import{r as a,I as W,D as Z,n as e,S as he,o as T,B as i,E as pe,T as h}from"./index-D8hBozCl.js";import{R as je,E as fe}from"./jspdf.es.min-D6D8GfGg.js";import"./jspdf.plugin.autotable-TLQB5wf7.js";import{i as k}from"./axios-0yhrvgHk.js";import{F as E}from"./index-CPerZvUG.js";import{D as ge}from"./index-YrUoHE_M.js";import{L as U}from"./index-CYOxmhgj.js";import{T as ee}from"./index-BzrSXtxJ.js";import{I as te,R as Se}from"./index-c-xDjV6w.js";import{R as we,S as p}from"./index-Bbm8COQ-.js";import{R as ye,a as Ie}from"./TextArea-Bs5ukQS9.js";import{R as se}from"./EditOutlined-BpfENuYh.js";import{P as L}from"./index-dpbpQePb.js";import{R as ne}from"./DeleteOutlined-CQNFutBi.js";import{R as Ne}from"./SendOutlined-CvtO6t-3.js";import{T as R}from"./index-DmSY7BiF.js";import{s as d}from"./index-BPW2WiK6.js";import{C as X}from"./index-B_00HpCd.js";import{F as be}from"./Table-BVZxJoUU.js";import{D as De}from"./index-Wj1yZsnU.js";import{R as Ce}from"./PlusOutlined-PtbJYp9O.js";import{M as Fe}from"./index-BlNQJlrr.js";import{D as j}from"./index-BAvzDBEV.js";import{R as $e}from"./MessageOutlined-D8acNkOV.js";import"./index-xsH4HHeE.js";import"./row-pMcTJa_w.js";import"./context-BFUfbSjF.js";import"./useClosable-BMf6yXpE.js";import"./InfoCircleFilled--t4l1xF5.js";import"./index-D97HIL6n.js";var ve={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M832 464h-68V240c0-70.7-57.3-128-128-128H388c-70.7 0-128 57.3-128 128v224h-68c-17.7 0-32 14.3-32 32v384c0 17.7 14.3 32 32 32h640c17.7 0 32-14.3 32-32V496c0-17.7-14.3-32-32-32zM332 240c0-30.9 25.1-56 56-56h248c30.9 0 56 25.1 56 56v224H332V240zm460 600H232V536h560v304zM484 701v53c0 4.4 3.6 8 8 8h40c4.4 0 8-3.6 8-8v-53a48.01 48.01 0 10-56 0z"}}]},name:"lock",theme:"outlined"},Re=function(S,n){return a.createElement(W,Z({},S,{ref:n,icon:ve}))},Te=a.forwardRef(Re),ke={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M832 464H332V240c0-30.9 25.1-56 56-56h248c30.9 0 56 25.1 56 56v68c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-68c0-70.7-57.3-128-128-128H388c-70.7 0-128 57.3-128 128v224h-68c-17.7 0-32 14.3-32 32v384c0 17.7 14.3 32 32 32h640c17.7 0 32-14.3 32-32V496c0-17.7-14.3-32-32-32zm-40 376H232V536h560v304zM484 701v53c0 4.4 3.6 8 8 8h40c4.4 0 8-3.6 8-8v-53a48.01 48.01 0 10-56 0z"}}]},name:"unlock",theme:"outlined"},Ae=function(S,n){return a.createElement(W,Z({},S,{ref:n,icon:ke}))},Oe=a.forwardRef(Ae);const{TextArea:J}=te,{Text:Pe}=ee,Ve=({visible:I,onClose:S,invoice:n,refreshInvoices:D})=>{const[A]=E.useForm(),[c,u]=a.useState([]),[B,g]=a.useState(!1),[N,l]=a.useState(null),[C,w]=a.useState("");a.useEffect(()=>{u((n==null?void 0:n.notes)||[])},[n]);const M=async({note:r})=>{const o={text:r,timestamp:new Date().toISOString(),author:"User"},m=[...c,o];try{g(!0),await k.put(`/api/invoices/${n._id}`,{...n,notes:m}),d.success("Note added"),u(m),A.resetFields(),D()}catch{d.error("Failed to add note")}finally{g(!1)}},_=async r=>{const o=c.filter((m,z)=>z!==r);try{g(!0),await k.put(`/api/invoices/${n._id}`,{...n,notes:o}),d.success("Note deleted"),u(o),D()}catch{d.error("Failed to delete note")}finally{g(!1)}},O=async r=>{const o=[...c];o[r]={...o[r],text:C,timestamp:new Date().toISOString(),updated:!0};try{g(!0),await k.put(`/api/invoices/${n._id}`,{...n,notes:o}),d.success("Note updated"),u(o),l(null),D()}catch{d.error("Update failed")}finally{g(!1)}};return e.jsx(ge,{title:e.jsx(e.Fragment,{children:e.jsxs("div",{children:["Notes for Invoice ",e.jsxs(R,{color:"blue",children:["#",n==null?void 0:n.invoiceNumber]})]})}),open:I,onClose:S,width:450,destroyOnClose:!0,children:e.jsxs(he,{spinning:B,children:[e.jsx(U,{dataSource:c,renderItem:(r,o)=>e.jsx(U.Item,{actions:[N===o?e.jsxs(T,{children:[e.jsx(i,{icon:e.jsx(we,{}),onClick:()=>O(o)}),e.jsx(i,{icon:e.jsx(ye,{}),onClick:()=>l(null)})]}):e.jsxs(T,{children:[e.jsx(i,{icon:e.jsx(se,{}),onClick:()=>{w(r.text),l(o)}}),e.jsx(L,{title:"Delete note?",onConfirm:()=>_(o),children:e.jsx(i,{icon:e.jsx(ne,{}),danger:!0})})]})],children:e.jsx(U.Item.Meta,{description:e.jsxs(e.Fragment,{children:[e.jsxs(Pe,{type:"secondary",children:[r.author," • ",new Date(r.timestamp).toLocaleString()]}),N===o?e.jsx(J,{rows:2,value:C,onChange:m=>w(m.target.value)}):e.jsx("div",{style:{whiteSpace:"pre-wrap"},children:r.text})]})})})}),e.jsxs(E,{form:A,layout:"vertical",onFinish:M,style:{marginTop:16},children:[e.jsx(E.Item,{name:"note",rules:[{required:!0,message:"Enter note"}],children:e.jsx(J,{rows:3,placeholder:"Type your note here..."})}),e.jsx(i,{htmlType:"submit",type:"primary",icon:e.jsx(Ne,{}),block:!0,children:"Add Note"})]})]})})},{Text:f}=ee,{RangePicker:Le}=De,ht=({invoices:I,onAddNew:S,onEdit:n,onDelete:D,onSearch:A,refreshInvoices:c})=>{var K;const[u,B]=a.useState(""),[g,N]=a.useState(!1),[l,C]=a.useState(null),[w,M]=a.useState("all"),[_,O]=a.useState(!1),[r,o]=a.useState(null),[m,z]=a.useState("all"),oe=[...new Set(I.map(t=>t.businessName))],Y=t=>{B(t),A(t)},ae=t=>{C(t),N(!0)},re=t=>{C(t),O(!0)},le=async t=>{try{await k.patch(`/api/invoices/${t}/close`),d.success("Invoice closed successfully"),c==null||c()}catch(s){console.error(s),d.error("Failed to close invoice")}},ie=async t=>{try{await k.patch(`/api/invoices/${t}/unlock`),d.success("Invoice unlocked successfully"),c==null||c()}catch(s){console.error(s),d.error("Failed to unlock invoice")}},ce=t=>{var V,F,$,v,Q;const s=new fe;s.setFontSize(20),s.text("TAX INVOICE",14,20),s.setFontSize(12),s.text(`Business: ${t.businessName||""}`,14,35),s.text(`Address: ${t.businessInfo||""}`,14,45),s.text(`GSTIN: ${t.gstin||""}`,14,55),s.text(`Invoice No: ${t.invoiceNumber||""}`,120,35),s.text(`Date: ${t.date||""}`,120,45),s.text(`Due Date: ${t.dueDate||"N/A"}`,120,55),s.text(`Status: ${t.paymentStatus}`,120,65),s.text(`Bill To: ${t.customerName||""}`,14,80),s.text(`Address: ${t.customerAddress||""}`,14,90);const x=((V=t.items)==null?void 0:V.map(b=>[b.description||"",b.hsnSac||"",b.quantity||0,`₹${(b.rate||0).toFixed(2)}`,`₹${((b.quantity||0)*(b.rate||0)).toFixed(2)}`]))||[];s.autoTable({head:[["Description","HSN/SAC","Qty","Rate (₹)","Amount (₹)"]],body:x,startY:100,theme:"grid"});const y=s.lastAutoTable.finalY+10;s.text(`Sub Total: ₹${((F=t.subTotal)==null?void 0:F.toFixed(2))||"0.00"}`,120,y),s.text(`GST (18%): ₹${(($=t.tax)==null?void 0:$.toFixed(2))||"0.00"}`,120,y+10),s.setFontSize(14),s.text(`Total: ₹${((v=t.total)==null?void 0:v.toFixed(2))||((Q=t.totalAmount)==null?void 0:Q.toFixed(2))||"0.00"}`,120,y+20),s.save(`invoice-${t.invoiceNumber||"draft"}.pdf`)},H=t=>{const s={paid:{color:"success",text:"Paid"},partial:{color:"warning",text:"Partial"},pending:{color:"error",text:"Pending"}}[t]||{};return e.jsx(R,{color:s.color,children:s.text})},de=(t,s)=>!t||s==="paid"?"none":new Date(t)<new Date?"overdue":"pending",P=(I||[]).filter(t=>{var F,$,v;const s=!u||((F=t.invoiceNumber)==null?void 0:F.toLowerCase().includes(u.toLowerCase()))||(($=t.businessName)==null?void 0:$.toLowerCase().includes(u.toLowerCase()))||((v=t.customerName)==null?void 0:v.toLowerCase().includes(u.toLowerCase())),x=!r||new Date(t.date)>=r[0].toDate()&&new Date(t.date)<=r[1].toDate(),y=w==="all"?!0:w==="overdue"?t.paymentStatus!=="paid"&&new Date(t.dueDate)<new Date:t.paymentStatus===w,V=m==="all"?!0:t.businessName===m;return s&&x&&y&&V}),ue=P.length,q=P.reduce((t,s)=>t+(s.totalAmount||0),0),G=P.filter(t=>t.paymentStatus==="paid").reduce((t,s)=>t+(s.totalAmount||0),0),me=q-G,xe=[{title:"S.No",render:(t,s,x)=>e.jsx(f,{strong:!0,children:x+1}),width:70},{title:"Invoice Number",render:(t,s)=>e.jsx(R,{color:"blue",icon:e.jsx(pe,{}),children:s.invoiceNumber})},{title:"Business Name",dataIndex:"businessName",render:t=>e.jsx(h,{title:t,children:e.jsx(f,{strong:!0,children:t})})},{title:"Customer Name",dataIndex:"customerName",render:t=>e.jsx(h,{title:t,children:e.jsx(f,{children:t})})},{title:"Amount",dataIndex:"totalAmount",align:"right",render:t=>e.jsxs(f,{strong:!0,style:{color:"#52c41a"},children:["₹",(t||0).toFixed(2)]})},{title:"Due Date",dataIndex:"dueDate",align:"center",render:(t,s)=>{const x=de(t,s.paymentStatus),y=x==="overdue"?"red":x==="pending"?"#faad14":"inherit";return e.jsx(f,{style:{color:y},children:t||"N/A"})}},{title:"Status",dataIndex:"paymentStatus",render:H},{title:"Actions",render:(t,s)=>e.jsxs(T,{children:[e.jsx(h,{title:"View",children:e.jsx(i,{icon:e.jsx(Se,{}),onClick:()=>ae(s)})}),e.jsx(h,{title:"PDF",children:e.jsx(i,{icon:e.jsx(je,{}),onClick:()=>ce(s)})}),e.jsx(h,{title:"Notes",children:e.jsx(i,{icon:e.jsx($e,{}),onClick:()=>re(s)})}),!s.isClosed&&e.jsx(h,{title:"Edit",children:e.jsx(i,{icon:e.jsx(se,{}),onClick:()=>n(s)})}),s.isClosed?e.jsx(L,{title:"Unlock this invoice?",onConfirm:()=>ie(s._id),children:e.jsx(h,{title:"Unlock",children:e.jsx(i,{icon:e.jsx(Oe,{})})})}):e.jsx(L,{title:"Close this invoice?",onConfirm:()=>le(s._id),children:e.jsx(h,{title:"Lock",children:e.jsx(i,{icon:e.jsx(Te,{})})})}),e.jsx(L,{title:"Delete invoice?",onConfirm:()=>D(s._id),children:e.jsx(h,{title:"Delete",children:e.jsx(i,{icon:e.jsx(ne,{}),danger:!0})})})]})}];return e.jsxs(e.Fragment,{children:[e.jsxs(X,{title:"Invoice Management",extra:e.jsxs(T,{wrap:!0,children:[e.jsx(Le,{onChange:t=>o(t),format:"YYYY-MM-DD"}),e.jsxs(p,{value:w,onChange:M,style:{width:140},children:[e.jsx(p.Option,{value:"all",children:"All Status"}),e.jsx(p.Option,{value:"paid",children:"Paid"}),e.jsx(p.Option,{value:"pending",children:"Pending"}),e.jsx(p.Option,{value:"partial",children:"Partial"}),e.jsx(p.Option,{value:"overdue",children:"Overdue"})]}),e.jsxs(p,{value:m,onChange:z,placeholder:"Filter by Business",style:{width:200},allowClear:!0,children:[e.jsx(p.Option,{value:"all",children:"All Businesses"}),oe.map(t=>e.jsx(p.Option,{value:t,children:t},t))]}),e.jsx(te.Search,{placeholder:"Search invoices",onSearch:Y,onChange:t=>Y(t.target.value),style:{width:240},allowClear:!0,prefix:e.jsx(Ie,{})}),e.jsx(i,{type:"primary",icon:e.jsx(Ce,{}),onClick:S,children:"New Invoice"})]}),children:[e.jsx(X,{type:"inner",title:"Summary",style:{marginBottom:16},children:e.jsxs(T,{direction:"horizontal",size:"large",children:[e.jsx(f,{strong:!0,children:"Total Invoices:"})," ",ue,e.jsx(f,{strong:!0,children:"Total Amount:"})," ₹",q.toFixed(2),e.jsx(f,{strong:!0,children:"Paid:"})," ₹",G.toFixed(2),e.jsx(f,{strong:!0,children:"Pending:"})," ₹",me.toFixed(2)]})}),e.jsx(be,{dataSource:P,columns:xe,rowKey:"_id",pagination:{pageSize:10},bordered:!0})]}),e.jsx(Fe,{title:"Invoice Details",open:g,onCancel:()=>N(!1),footer:e.jsx(i,{onClick:()=>N(!1),children:"Close"}),width:800,children:l&&e.jsxs(j,{bordered:!0,column:2,children:[e.jsx(j.Item,{label:"Invoice No",children:l.invoiceNumber}),e.jsx(j.Item,{label:"Date",children:l.date}),e.jsx(j.Item,{label:"Business",children:l.businessName}),e.jsx(j.Item,{label:"Customer",children:l.customerName}),e.jsx(j.Item,{label:"GSTIN",span:2,children:l.gstin}),e.jsxs(j.Item,{label:"Amount",span:2,children:["₹",(K=l.totalAmount)==null?void 0:K.toFixed(2)]}),e.jsx(j.Item,{label:"Status",span:2,children:H(l.paymentStatus)}),e.jsx(j.Item,{label:"Closed",span:2,children:l.isClosed?e.jsx(R,{color:"red",children:"Yes"}):e.jsx(R,{color:"green",children:"No"})})]})}),e.jsx(Ve,{visible:_,onClose:()=>O(!1),invoice:l,refreshInvoices:c})]})};export{ht as default};
