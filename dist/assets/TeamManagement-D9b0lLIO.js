import{r as d,I as W,e as X,x as r,B as o,K as Y,H as Z,V as i}from"./index-a4NG3Q5z.js";import{i as y}from"./axios-YBtE4rUB.js";import{F as l}from"./index-7IeMqjcz.js";import{R as U}from"./PlusOutlined-zZEGHg-n.js";import{C as D}from"./Collapse-CUEMg6Cp.js";import{L as S}from"./index-Dbrxa2QS.js";import{R as ee}from"./SwapOutlined-ButQLcNP.js";import{R as re}from"./TeamOutlined-BVrT1NE_.js";import{R as te}from"./EditOutlined-BKUXNvP_.js";import{P as ae}from"./index-BrWke8uh.js";import{R as se}from"./DeleteOutlined-CDi_tZxL.js";import{D as V}from"./index-B-jo3fiV.js";import{I as ne}from"./index-CyE2n0d3.js";import{S as c}from"./index-DexvsDj4.js";import"./TextArea-DUV9W9Uw.js";import"./useClosable-DJUuq7Xb.js";import"./Pagination-CqFfhKfi.js";import"./ActionButton-BkiXmq_U.js";import"./context-BMjDg9zo.js";var le={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M908 640H804V488c0-4.4-3.6-8-8-8H548v-96h108c8.8 0 16-7.2 16-16V80c0-8.8-7.2-16-16-16H368c-8.8 0-16 7.2-16 16v288c0 8.8 7.2 16 16 16h108v96H228c-4.4 0-8 3.6-8 8v152H116c-8.8 0-16 7.2-16 16v288c0 8.8 7.2 16 16 16h288c8.8 0 16-7.2 16-16V656c0-8.8-7.2-16-16-16H292v-88h440v88H620c-8.8 0-16 7.2-16 16v288c0 8.8 7.2 16 16 16h288c8.8 0 16-7.2 16-16V656c0-8.8-7.2-16-16-16zm-564 76v168H176V716h168zm84-408V140h168v168H428zm420 576H680V716h168v168z"}}]},name:"apartment",theme:"outlined"},ie=function(p,j){return d.createElement(W,X({},p,{ref:j,icon:le}))},oe=d.forwardRef(ie);const{Option:x}=c,{Panel:$}=D,Le=({teams:b,departments:p,allUsers:j,fetchTeams:C,fetchDepartments:de,fetchUsers:v})=>{const[H,h]=d.useState(!1),[n,L]=d.useState(null),[g]=l.useForm(),[z,w]=d.useState(!1),[f,O]=d.useState(null),[u]=l.useForm(),[R,I]=d.useState([]),m=JSON.parse(localStorage.getItem("user")),T=(m==null?void 0:m.role)==="Superadmin",_=(m==null?void 0:m.role)==="Admin",A=j.filter(e=>e.role==="Team Leader"&&!e.team),E=j.filter(e=>e.role==="Employee"&&!e.team),B=()=>{const e=n==null?void 0:n.teamLeader,t=[...A];return e&&!t.some(a=>a._id===e._id)&&t.push(e),t},M=()=>{const e=(n==null?void 0:n.members)||[],t=[...E];return e.forEach(a=>{t.some(s=>s._id===a._id)||t.push(a)}),t},N=()=>{L(null),g.resetFields(),h(!0)},P=e=>{var t,a;L(e),g.setFieldsValue({name:e.name,department:(t=e.department)==null?void 0:t._id,teamLeader:(a=e.teamLeader)==null?void 0:a._id,members:e.members.map(s=>s._id)}),h(!0)},q=async()=>{var e,t;try{const a=await g.validateFields();n?(await y.put(`/api/teams/${n._id}`,a),i.success("Team updated successfully")):(await y.post("/api/teams",a),i.success("Team created successfully")),h(!1),C(),v()}catch(a){console.error(a),i.error(((t=(e=a==null?void 0:a.response)==null?void 0:e.data)==null?void 0:t.message)||"Failed to submit team")}},K=async e=>{var t,a;try{await y.delete(`/api/teams/${e}`),i.success("Team deleted"),C(),v()}catch(s){i.error(((a=(t=s==null?void 0:s.response)==null?void 0:t.data)==null?void 0:a.message)||"Delete failed")}},F=p.reduce((e,t)=>(e[t._id]={...t,teams:b.filter(a=>{var s;return((s=a.department)==null?void 0:s._id)===t._id})},e),{}),J=e=>{O(e),u.resetFields(),I([]),w(!0)},G=e=>{if(u.setFieldsValue({newTeamId:void 0}),e){const t=b.filter(a=>{var s;return((s=a.department)==null?void 0:s._id)===e});I(t)}else I([])},Q=async()=>{var e,t;try{const a=await u.validateFields(),{newDepartmentId:s,newTeamId:k}=a;if(!f){i.error("No user selected for transfer.");return}if(!s&&!k){i.error("Please select a new department or team for transfer.");return}await y.put(`/api/users/${f._id}/transfer`,{newDepartmentId:s||null,newTeamId:k||null}),i.success(`${f.name} transferred successfully.`),w(!1),O(null),v(),C()}catch(a){console.error("Transfer failed:",a),i.error(((t=(e=a==null?void 0:a.response)==null?void 0:e.data)==null?void 0:t.message)||"Failed to transfer user.")}};return r.jsxs(r.Fragment,{children:[r.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16},children:[r.jsx("h2",{children:"Team Management"}),(T||_)&&r.jsx(o,{type:"primary",style:{backgroundColor:"#ef7a1b",borderColor:"#orange",color:"white"},icon:r.jsx(U,{}),onClick:N,children:"Create Team"})]}),r.jsx(D,{accordion:!0,bordered:!1,defaultActiveKey:Object.keys(F)[0],children:Object.values(F).map(e=>r.jsx($,{header:r.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[r.jsx(oe,{style:{marginRight:8,fontSize:"1.2em"}}),r.jsxs("h3",{children:[e.name," (",e.teams.length," Teams)"]})]}),style:{marginBottom:10,borderRadius:8,overflow:"hidden",border:"1px solid #d9d9d9"},children:e.teams.length===0?r.jsx("p",{children:"No teams in this department."}):r.jsx(D,{accordion:!0,bordered:!1,style:{background:"#f0f2f5"},children:e.teams.map(t=>r.jsx($,{header:r.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[r.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[r.jsx(re,{style:{marginRight:8}}),r.jsx("strong",{children:t.name}),t.teamLeader&&r.jsxs("span",{style:{marginLeft:15,fontSize:"0.9em",color:"#555"},children:["(Leader: ",t.teamLeader.name,")"]})]}),(T||_)&&r.jsxs(Z,{onClick:a=>a.stopPropagation(),children:[r.jsx(o,{icon:r.jsx(te,{}),onClick:()=>P(t),size:"small"}),r.jsx(ae,{title:"Delete this team?",onConfirm:()=>K(t._id),children:r.jsx(o,{danger:!0,icon:r.jsx(se,{}),size:"small"})})]})]}),style:{marginBottom:5,borderRadius:6,border:"1px solid #e8e8e8"},children:r.jsxs("div",{style:{paddingLeft:20},children:[r.jsx("h4",{children:"Team Members:"}),t.members.length===0?r.jsx("p",{children:"No members in this team."}):r.jsx(S,{size:"small",dataSource:t.members,renderItem:a=>r.jsx(S.Item,{actions:[(T||_)&&r.jsx(o,{type:"link",icon:r.jsx(ee,{}),onClick:()=>J(a),size:"small",title:"Transfer User",children:"Transfer"})],children:r.jsx(S.Item.Meta,{avatar:r.jsx(Y,{}),title:a.name,description:a.email})})})]})},t._id))})},e._id))}),r.jsx(V,{title:n?"Edit Team":"Create Team",open:H,onClose:()=>h(!1),width:420,destroyOnClose:!0,footer:r.jsxs("div",{style:{textAlign:"right"},children:[r.jsx(o,{onClick:()=>h(!1),style:{marginRight:8},children:"Cancel"}),r.jsx(o,{type:"primary",style:{backgroundColor:"#ef7a1b",borderColor:"#orange",color:"white"},onClick:q,children:n?"Update":"Create"})]}),children:r.jsxs(l,{form:g,layout:"vertical",children:[r.jsx(l.Item,{name:"name",label:"Team Name",rules:[{required:!0,message:"Team name is required"}],children:r.jsx(ne,{})}),r.jsx(l.Item,{name:"department",label:"Department",rules:[{required:!0,message:"Please select a department"}],children:r.jsx(c,{placeholder:"Select department",children:p.map(e=>r.jsx(x,{value:e._id,children:e.name},e._id))})}),r.jsx(l.Item,{name:"teamLeader",label:"Team Leader",children:r.jsx(c,{placeholder:"Select team leader (optional)",allowClear:!0,showSearch:!0,filterOption:(e,t)=>t.children.toLowerCase().indexOf(e.toLowerCase())>=0,children:B().map(e=>r.jsxs(x,{value:e._id,children:[e.name," (",e.email,")"]},e._id))})}),r.jsx(l.Item,{name:"members",label:"Team Members",children:r.jsx(c,{mode:"multiple",placeholder:"Select team members (optional)",showSearch:!0,filterOption:(e,t)=>t.children.toLowerCase().indexOf(e.toLowerCase())>=0,children:M().map(e=>r.jsxs(x,{value:e._id,children:[e.name," (",e.email,")"]},e._id))})})]})}),r.jsx(V,{title:`Transfer ${f?f.name:"User"}`,open:z,onClose:()=>w(!1),width:420,destroyOnClose:!0,footer:r.jsxs("div",{style:{textAlign:"right"},children:[r.jsx(o,{onClick:()=>w(!1),style:{marginRight:8},children:"Cancel"}),r.jsx(o,{type:"primary",style:{backgroundColor:"#ef7a1b",borderColor:"#orange",color:"white"},onClick:Q,children:"Transfer"})]}),children:r.jsxs(l,{form:u,layout:"vertical",children:[r.jsx(l.Item,{name:"newDepartmentId",label:"New Department",children:r.jsx(c,{placeholder:"Select new department (optional)",allowClear:!0,onChange:G,showSearch:!0,filterOption:(e,t)=>t.children.toLowerCase().indexOf(e.toLowerCase())>=0,children:p.map(e=>r.jsx(x,{value:e._id,children:e.name},e._id))})}),r.jsx(l.Item,{name:"newTeamId",label:"New Team",children:r.jsx(c,{placeholder:"Select new team (optional)",allowClear:!0,showSearch:!0,filterOption:(e,t)=>t.children.toLowerCase().indexOf(e.toLowerCase())>=0,disabled:!u.getFieldValue("newDepartmentId")||R.length===0,children:R.map(e=>r.jsx(x,{value:e._id,children:e.name},e._id))})})]})})]})};export{Le as default};
