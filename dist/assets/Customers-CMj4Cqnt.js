import{r as a,J as se,x as e,an as i,ap as te,B as oe,aq as m}from"./index-DRLLTQ-4.js";import{i as u}from"./axios-YBtE4rUB.js";import{B as ae,F as re,N as ne,R as le}from"./FollowUpDrawer-C5DGVmzP.js";import{R as ie}from"./html2canvas.esm-DHGcVs7q.js";import{C as ce}from"./index-_aOVwoMa.js";import{T as ue}from"./index-BYhEcT7L.js";import{I as de}from"./index-Zkf7-HZo.js";import{c as me}from"./TextArea-TVV6kunH.js";import{T as I}from"./index-BgXCMPfH.js";import{F as pe}from"./Table-BuMrv-us.js";import{M as fe}from"./index-D2YYgvC7.js";import{T as p}from"./index-CiQWmzqe.js";import{R as he}from"./EditOutlined-BscuiI8f.js";import{R as xe}from"./MessageOutlined-Bfz-y2A-.js";import{P as je}from"./index-pzzETfhE.js";import{R as ge}from"./DeleteOutlined-DCGQOyTP.js";import"./index-Gc4tPvnQ.js";import"./index-paQke72p.js";import"./context-BP3YoHGR.js";import"./useClosable-DdNfXilP.js";import"./index-D-yUMJFm.js";import"./index-BZl-NhOI.js";import"./index-Fh70pFDu.js";import"./moment-C5S46NFB.js";import"./index-36_P395g.js";import"./dayjs.min-BQTNyvzV.js";import"./index-Bpcamuxe.js";import"./addEventListener-BVELC7-i.js";import"./index-B0V_PhAp.js";import"./InfoCircleFilled-B2EacpIW.js";import"./ActionButton-CFBJztxB.js";import"./index-BG1_L86l.js";const{Title:Ce}=ue,{TabPane:we}=I,es=()=>{const[g,F]=a.useState(""),[_,$]=a.useState("active"),[R,U]=a.useState([]),[C,n]=a.useState(!1),[V,D]=a.useState([]),[k,w]=a.useState(!1),[E,h]=a.useState(!1),[r,S]=a.useState(null),[L,y]=a.useState(!1),[d,B]=a.useState(null),[x,M]=a.useState(null),[O,b]=a.useState(!1),[P,T]=a.useState(!1),[f,N]=a.useState(null),W=se(),c=()=>{n(!0),u.get("/api/accounts/customers").then(s=>{const t=Array.isArray(s.data)?s.data:[];U(t)}).catch(s=>{i.error("Failed to load customers"),console.error("Error fetching customers:",s)}).finally(()=>n(!1))},q=()=>{w(!0),u.get("/api/accounts/users/all").then(s=>{D(s.data)}).catch(()=>{i.error("Failed to load user list")}).finally(()=>w(!1))};a.useEffect(()=>{c(),q()},[]);const H=s=>{S(s),h(!0)},J=s=>{n(!0),(r!=null&&r._id?u.put(`/api/accounts/${r._id}`,s):u.post("/api/accounts",s)).then(()=>{i.success(`Customer ${r!=null&&r._id?"updated":"created"} successfully`),c()}).catch(o=>{var l;i.error(`Failed to ${r!=null&&r._id?"update":"create"} customer`),console.error("Save customer error:",((l=o.response)==null?void 0:l.data)||o.message)}).finally(()=>{h(!1),S(null),n(!1)})},K=()=>{n(!0);const s={...d,status:x};u.put(`/api/accounts/${d._id}`,s).then(()=>{i.success(`Status updated to ${x}`),c()}).catch(t=>{var o;i.error("Failed to update status"),console.error("Status update error:",((o=t.response)==null?void 0:o.data)||t.message)}).finally(()=>{y(!1),B(null),M(null),n(!1)})},Y=s=>{n(!0),u.put(`/api/accounts/${s}`,{status:"Closed",isCustomer:!1}).then(()=>{i.success("Customer status set to Closed"),c()}).catch(t=>{var o;i.error("Failed to close customer account"),console.error("Soft delete error:",((o=t.response)==null?void 0:o.data)||t.message)}).finally(()=>{n(!1)})},z=s=>{N(s),b(!0)},G=s=>{N(s),T(!0)},Q=s=>{W(`/customers/${s._id}`)},v=R.filter(s=>{var o,l,A;const t=g.toLowerCase();return s.status==="Customer"&&(((o=s.businessName)==null?void 0:o.toLowerCase().includes(t))||((l=s.contactName)==null?void 0:l.toLowerCase().includes(t))||((A=s.email)==null?void 0:A.toLowerCase().includes(t)))}).filter(s=>s.status==="Customer"),X=s=>{switch(s){case"Hot":return e.jsx(p,{color:"red",children:"Hot"});case"Warm":return e.jsx(p,{color:"orange",children:"Warm"});case"Cold":return e.jsx(p,{color:"blue",children:"Cold"});default:return e.jsx(p,{children:"Unknown"})}},j=JSON.parse(localStorage.getItem("user")),Z=j==null?void 0:j.role,ee=[{title:"Sno.",render:(s,t,o)=>o+1,width:60},{title:"Business Name",dataIndex:"businessName",render:(s,t)=>e.jsx("a",{onClick:()=>Q(t),style:{cursor:"pointer",color:"#1890ff"},children:s})},{title:"Contact Name",dataIndex:"contactName"},{title:"Email Id",dataIndex:"email"},{title:"Type",dataIndex:"type",render:X},{title:"Assigned To",render:(s,t)=>t.assignedTo?e.jsxs("span",{children:[t.assignedTo.name," (",t.assignedTo.role,")"]}):e.jsx("em",{children:"Unassigned"})},{title:"Latest Note",render:(s,t)=>{var l;const o=(l=t.notes)==null?void 0:l[t.notes.length-1];return o?e.jsxs("div",{children:[e.jsx("small",{style:{color:"#888"},children:o.timestamp}),e.jsx("br",{}),o.text]}):e.jsx("em",{children:"No notes"})}},{title:"Status",render:(s,t)=>e.jsx(p,{color:t.status==="Customer"?"blue":"gray",children:t.status})},{title:"Actions",render:(s,t)=>e.jsx(te,{overlay:e.jsxs(m,{children:[e.jsx(m.Item,{icon:e.jsx(he,{}),onClick:()=>H(t),children:"Edit Customer"},"edit"),e.jsx(m.Item,{icon:e.jsx(xe,{}),onClick:()=>z(t),children:"View/Add Notes"},"notes"),e.jsx(m.Item,{icon:e.jsx(le,{}),onClick:()=>G(t),children:"View/Add Follow-ups"},"followups"),Z==="Superadmin"&&e.jsx(m.Item,{children:e.jsxs(je,{title:"Are you sure you want to close this account? This will set its status to 'Closed'.",onConfirm:()=>Y(t._id),okText:"Yes",cancelText:"No",children:[e.jsx(ge,{}),"Close Account"]})},"close-account")]}),trigger:["click"],children:e.jsx(oe,{icon:e.jsx(ie,{})})})}];return e.jsxs("div",{children:[e.jsxs(ce,{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:16,flexWrap:"wrap"},children:[e.jsx(Ce,{level:4,children:"Customers"}),e.jsx(de,{placeholder:"Search by Business Name, Contact Name or Email",prefix:e.jsx(me,{}),value:g,onChange:s=>F(s.target.value),style:{width:"100%",maxWidth:400}})]}),e.jsx(I,{activeKey:_,onChange:$,children:e.jsx(we,{tab:`All Customers (${v.length})`,children:e.jsx(pe,{columns:ee,dataSource:v,rowKey:"_id",pagination:{pageSize:10},loading:C,scroll:{x:"max-content"}})},"active")})]}),e.jsx(ae,{visible:E,onClose:()=>h(!1),onSave:J,initialValues:r,allUsers:V,loadingUsers:k}),e.jsx(fe,{title:"Confirm Status Change",open:L,onOk:K,onCancel:()=>y(!1),okText:"Yes",cancelText:"No",confirmLoading:C,children:e.jsxs("p",{children:["Are you sure you want to change the status of ",e.jsx("strong",{children:d==null?void 0:d.businessName})," to ",e.jsx("strong",{children:x}),"?"]})}),f&&e.jsx(re,{visible:P,onClose:()=>T(!1),account:f,refreshAccounts:c}),f&&e.jsx(ne,{visible:O,onClose:()=>b(!1),account:f,refreshAccounts:c})]})};export{es as default};
