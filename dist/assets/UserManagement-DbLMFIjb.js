import{r as h,I as K,e as Y,x as e,B as f,V as m,H as G}from"./index-Bh972cwr.js";import{i as j}from"./axios-tnHzrPy3.js";import{F as i}from"./index-BL5iROut.js";import{F as Q}from"./Table-BExT_F7w.js";import{D as R}from"./index-C32tZoDq.js";import{I as b}from"./index-7-75ZJ3V.js";import{S as w}from"./index-CcaSAig_.js";import{R as W}from"./EditOutlined-C8onD6Za.js";import{R as X}from"./SwapOutlined-DOCJ994S.js";import{P as Z}from"./index-DHwruj0_.js";import{R as ee}from"./DeleteOutlined-BiQ_4_ag.js";import"./TextArea-BEg0asyq.js";import"./styleChecker-Dj00uHUt.js";import"./addEventListener-DjoSmVQg.js";import"./index-DDjaH6dd.js";import"./Pagination-BVSYs8JK.js";import"./useClosable-CvzyKiVq.js";import"./context-DoeWtm_R.js";import"./ActionButton-DInSw_8r.js";var ae={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M678.3 642.4c24.2-13 51.9-20.4 81.4-20.4h.1c3 0 4.4-3.6 2.2-5.6a371.67 371.67 0 00-103.7-65.8c-.4-.2-.8-.3-1.2-.5C719.2 505 759.6 431.7 759.6 349c0-137-110.8-248-247.5-248S264.7 212 264.7 349c0 82.7 40.4 156 102.6 201.1-.4.2-.8.3-1.2.5-44.7 18.9-84.8 46-119.3 80.6a373.42 373.42 0 00-80.4 119.5A373.6 373.6 0 00137 888.8a8 8 0 008 8.2h59.9c4.3 0 7.9-3.5 8-7.8 2-77.2 32.9-149.5 87.6-204.3C357 628.2 432.2 597 512.2 597c56.7 0 111.1 15.7 158 45.1a8.1 8.1 0 008.1.3zM512.2 521c-45.8 0-88.9-17.9-121.4-50.4A171.2 171.2 0 01340.5 349c0-45.9 17.9-89.1 50.3-121.6S466.3 177 512.2 177s88.9 17.9 121.4 50.4A171.2 171.2 0 01683.9 349c0 45.9-17.9 89.1-50.3 121.6C601.1 503.1 558 521 512.2 521zM880 759h-84v-84c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v84h-84c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h84v84c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-84h84c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8z"}}]},name:"user-add",theme:"outlined"},te=function(T,_){return h.createElement(K,Y({},T,{ref:_,icon:ae}))},re=h.forwardRef(te);const{Option:p}=w,ge=()=>{var E,O;const[F,T]=h.useState([]),[_,N]=h.useState([]),[A,$]=h.useState([]),[q,y]=h.useState(!1),[l,k]=h.useState(null),[v]=i.useForm(),[L,g]=h.useState(!1),[u,U]=h.useState(null),[D]=i.useForm(),r=JSON.parse(localStorage.getItem("user")),o=(r==null?void 0:r.role)==="Superadmin",c=(r==null?void 0:r.role)==="Admin",x=(r==null?void 0:r.role)==="Team Leader",C=async()=>{try{const a=await j.get("/api/users");let t=a.data;x&&r.team&&(t=a.data.filter(s=>{var d;return((d=s.team)==null?void 0:d._id)===r.team||s._id===r._id})),T(t)}catch{m.error("Failed to load users")}},I=async()=>{try{const a=await j.get("/api/departments");N(a.data)}catch{m.error("Failed to load departments")}},S=async()=>{try{const a=await j.get("/api/teams");$(a.data)}catch{m.error("Failed to load teams")}};h.useEffect(()=>{C(),(o||c)&&(I(),S())},[o,c,x,r==null?void 0:r.team]);const M=()=>{k(null),v.resetFields(),v.setFieldsValue({role:"Employee",status:"Active"}),y(!0)},P=a=>{var t,s;k(a),v.setFieldsValue({name:a.name,email:a.email,mobile:a.mobile,role:a.role,status:a.status,department:(t=a.department)==null?void 0:t._id,team:(s=a.team)==null?void 0:s._id}),y(!0)},V=async()=>{var a,t,s,d;try{const n=await v.validateFields();if(l&&!n.password&&delete n.password,x&&l){if(n.role!==l.role){m.error("Team Leaders cannot change user roles.");return}if(n.department!==((a=l.department)==null?void 0:a._id)){m.error("Team Leaders cannot change user departments.");return}if(n.team!==((t=l.team)==null?void 0:t._id)){m.error("Team Leaders cannot change user teams.");return}}l?(await j.put(`/api/users/${l._id}`,n),m.success("User updated successfully")):(await j.post("/api/users",n),m.success("User created successfully")),y(!1),C(),(o||c)&&(S(),I())}catch(n){console.error(n),m.error(((d=(s=n==null?void 0:n.response)==null?void 0:s.data)==null?void 0:d.message)||"Failed to submit user")}},B=async a=>{var t,s;try{if((o||c)&&r._id===a){m.error("You cannot delete your own account.");return}await j.delete(`/api/users/${a}`),m.success("User deleted"),C(),(o||c)&&(S(),I())}catch(d){m.error(((s=(t=d==null?void 0:d.response)==null?void 0:t.data)==null?void 0:s.message)||"Delete failed")}},z=a=>{var t,s,d,n;U(a),D.setFieldsValue({currentDepartment:(t=a.department)==null?void 0:t.name,currentTeam:(s=a.team)==null?void 0:s.name,newDepartment:(d=a.department)==null?void 0:d._id,newTeam:(n=a.team)==null?void 0:n._id}),g(!0)},H=async()=>{var a,t;try{const s=await D.validateFields(),{newDepartment:d,newTeam:n}=s;await j.put(`/api/users/transfer/${u._id}`,{newDepartmentId:d,newTeamId:n}),m.success(`${u.name} transferred successfully`),g(!1),C(),S(),I()}catch(s){console.error("Transfer error:",s),m.error(((t=(a=s==null?void 0:s.response)==null?void 0:a.data)==null?void 0:t.message)||"Failed to transfer user")}},J=[{title:"Name",dataIndex:"name",key:"name"},{title:"Email",dataIndex:"email",key:"email"},{title:"Mobile",dataIndex:"mobile",key:"mobile"},{title:"Role",dataIndex:"role",key:"role"},{title:"Status",dataIndex:"status",key:"status"},{title:"Actions",key:"actions",render:(a,t)=>{var s;return e.jsxs(G,{children:[(o||c||x&&r.team===((s=t.team)==null?void 0:s._id))&&e.jsx(f,{icon:e.jsx(W,{}),onClick:()=>P(t)}),(o||c)&&e.jsx(f,{icon:e.jsx(X,{}),onClick:()=>z(t),title:"Transfer User to another Team/Department"}),(o||c)&&e.jsx(Z,{title:"Delete this user?",onConfirm:()=>B(t._id),disabled:r._id===t._id,children:e.jsx(f,{danger:!0,icon:e.jsx(ee,{}),disabled:r._id===t._id})})]})}}];return e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16},children:[e.jsx("h2",{children:"User Management"}),(o||c)&&e.jsx(f,{type:"primary",style:{backgroundColor:"#ef7a1b",borderColor:"#orange",color:"white"},icon:e.jsx(re,{}),onClick:M,children:"Create User"})]}),e.jsx(Q,{columns:J,dataSource:F,rowKey:"_id",bordered:!0}),e.jsx(R,{title:l?"Edit User":"Create User",open:q,onClose:()=>y(!1),width:420,destroyOnClose:!0,footer:e.jsxs("div",{style:{textAlign:"right"},children:[e.jsx(f,{onClick:()=>y(!1),style:{marginRight:8},children:"Cancel"}),e.jsx(f,{type:"primary",style:{backgroundColor:"#ef7a1b",borderColor:"#orange",color:"white"},onClick:V,children:l?"Update":"Create"})]}),children:e.jsxs(i,{form:v,layout:"vertical",children:[e.jsx(i.Item,{name:"name",label:"Name",rules:[{required:!0,message:"Name is required"}],children:e.jsx(b,{disabled:x&&l&&r._id!==l._id})}),e.jsx(i.Item,{name:"email",label:"Email",rules:[{required:!0,message:"Email is required"},{type:"email",message:"Invalid email format"}],children:e.jsx(b,{disabled:x&&l&&r._id!==l._id})}),e.jsx(i.Item,{name:"mobile",label:"Mobile",children:e.jsx(b,{disabled:x&&l&&r._id!==l._id})}),(!l&&(o||c)||l&&(o||c))&&e.jsx(i.Item,{name:"password",label:"Password",rules:l?[]:[{required:!0,message:"Password is required"}],children:e.jsx(b.Password,{placeholder:l?"Leave blank to keep current password":""})}),e.jsx(i.Item,{name:"role",label:"Role",rules:[{required:!0,message:"Please select a role"}],children:e.jsxs(w,{placeholder:"Select role",disabled:x&&l&&r._id!==l._id,children:[e.jsx(p,{value:"Superadmin",disabled:!o,children:"Superadmin"}),e.jsx(p,{value:"Admin",disabled:!o,children:"Admin"})," ",e.jsx(p,{value:"Team Leader",children:"Team Leader"}),e.jsx(p,{value:"Employee",children:"Employee"})]})}),e.jsx(i.Item,{name:"status",label:"Status",rules:[{required:!0,message:"Please select status"}],children:e.jsxs(w,{placeholder:"Select status",disabled:x&&l&&r._id!==l._id,children:[e.jsx(p,{value:"Active",children:"Active"}),e.jsx(p,{value:"Inactive",children:"Inactive"})]})}),(o||c)&&e.jsx(i.Item,{name:"department",label:"Department",children:e.jsx(w,{placeholder:"Select department",allowClear:!0,children:_.map(a=>e.jsx(p,{value:a._id,children:a.name},a._id))})}),(o||c)&&e.jsx(i.Item,{name:"team",label:"Team",children:e.jsx(w,{placeholder:"Select team",allowClear:!0,children:A.map(a=>{var t;return e.jsxs(p,{value:a._id,children:[a.name," (",((t=a.department)==null?void 0:t.name)||"N/A",")"]},a._id)})})})]})}),e.jsx(R,{title:`Transfer User: ${u==null?void 0:u.name}`,open:L,onClose:()=>g(!1),width:420,destroyOnClose:!0,footer:e.jsxs("div",{style:{textAlign:"right"},children:[e.jsx(f,{onClick:()=>g(!1),style:{marginRight:8},children:"Cancel"}),e.jsx(f,{type:"primary",style:{backgroundColor:"#ef7a1b",borderColor:"#orange",color:"white"},onClick:H,children:"Transfer"})]}),children:e.jsxs(i,{form:D,layout:"vertical",children:[e.jsx(i.Item,{label:"Current Department",children:e.jsx(b,{value:((E=u==null?void 0:u.department)==null?void 0:E.name)||"N/A",disabled:!0})}),e.jsx(i.Item,{label:"Current Team",children:e.jsx(b,{value:((O=u==null?void 0:u.team)==null?void 0:O.name)||"N/A",disabled:!0})}),e.jsx(i.Item,{name:"newDepartment",label:"New Department (Optional)",children:e.jsx(w,{placeholder:"Select new department",allowClear:!0,children:_.map(a=>e.jsx(p,{value:a._id,children:a.name},a._id))})}),e.jsx(i.Item,{name:"newTeam",label:"New Team (Optional)",children:e.jsx(w,{placeholder:"Select new team",allowClear:!0,children:A.map(a=>{var t;return e.jsxs(p,{value:a._id,children:[a.name," (",((t=a.department)==null?void 0:t.name)||"N/A",")"]},a._id)})})})]})})]})};export{ge as default};
