import{r as n,x as ge,o as t,ak as r,al as fe,B as xe,am as l}from"./index-p2W8-JSg.js";import{i as u}from"./axios-YBtE4rUB.js";import{B as Ce,F as je,N as we,R as be}from"./FollowUpDrawer-BJvbc9uB.js";import{R as ve,h as ye,E as Se}from"./html2canvas.esm-BYtOSMrO.js";import{C as $e}from"./index-DdIJkXRK.js";import{T as Ie}from"./index-DBLVFDmX.js";import{I as Ne,b as Te}from"./index-CkSeMQSC.js";import{c as Ae}from"./TextArea-BIVTlsSe.js";import{T as G}from"./index-Cn41Z8Jf.js";import{F as B}from"./Table-0SM-dJv8.js";import{M as H}from"./index-D73F1-5_.js";import{T as g}from"./index-BYGICwCZ.js";import{R as Fe}from"./EditOutlined-CFOFvs5-.js";import{R as De}from"./MessageOutlined-P9qhkkkj.js";import{R as ke}from"./PrinterOutlined-D6N0ICO3.js";import{R as _e}from"./DeleteOutlined-C3b92VB7.js";import"./index-m4syREVC.js";import"./index-9Jakdzoy.js";import"./context-BqvnZ1wx.js";import"./useClosable-XihvMjnC.js";import"./index-BY2F3JJu.js";import"./index-CyLVz7SK.js";import"./index-8TEVMGxs.js";import"./moment-C5S46NFB.js";import"./index-B_eudkdX.js";import"./index-BjvDYLf9.js";import"./addEventListener-Duu3ACib.js";import"./index-DQC_fxCM.js";import"./InfoCircleFilled-D7nY6les.js";import"./ActionButton-Cyf4JHhA.js";import"./index-D4YLotbg.js";const{Title:Le}=Ie,{TabPane:W}=G,ht=()=>{const[T,O]=n.useState(""),[K,q]=n.useState("active"),[z,Y]=n.useState([]),[f,c]=n.useState(!1),[J,Q]=n.useState([]),[X,A]=n.useState(!1),[Z,b]=n.useState(!1),[i,F]=n.useState(null),[ee,v]=n.useState(!1),[p,D]=n.useState(null),[y,k]=n.useState(null),[te,S]=n.useState(!1),[d,_]=n.useState(null),[se,L]=n.useState(!1),[oe,R]=n.useState(!1),[x,U]=n.useState(null),ae=ge(),m=()=>{c(!0),u.get("/api/accounts/customers").then(e=>{const s=Array.isArray(e.data)?e.data:[];Y(s)}).catch(e=>{r.error("Failed to load customers"),console.error("Error fetching customers:",e)}).finally(()=>c(!1))},ne=()=>{A(!0),u.get("/api/accounts/users/all").then(e=>{Q(e.data)}).catch(()=>{r.error("Failed to load user list")}).finally(()=>A(!1))};n.useEffect(()=>{m(),ne()},[]);const ie=e=>{F(e),b(!0)},re=e=>{c(!0),(i!=null&&i._id?u.put(`/api/accounts/${i._id}`,e):u.post("/api/accounts",e)).then(()=>{r.success(`Customer ${i!=null&&i._id?"updated":"created"} successfully`),m()}).catch(a=>{var o;r.error(`Failed to ${i!=null&&i._id?"update":"create"} customer`),console.error("Save customer error:",((o=a.response)==null?void 0:o.data)||a.message)}).finally(()=>{b(!1),F(null),c(!1)})},$=(e,s)=>{D(s),k(e?"Active":"Inactive"),v(!0)},le=()=>{c(!0);const e={...p,status:y};u.put(`/api/accounts/${p._id}`,e).then(()=>{r.success(`Status updated to ${y}`),m()}).catch(s=>{var a;r.error("Failed to update status"),console.error("Status update error:",((a=s.response)==null?void 0:a.data)||s.message)}).finally(()=>{v(!1),D(null),k(null),c(!1)})},ce=e=>{_(e),S(!0)},de=()=>{d!=null&&d._id&&(c(!0),u.put(`/api/accounts/${d._id}`,{status:"Closed",isCustomer:!1}).then(()=>{r.success("Customer status set to Closed"),m()}).catch(e=>{var s;r.error("Failed to close customer account"),console.error("Soft delete error:",((s=e.response)==null?void 0:s.data)||e.message)}).finally(()=>{S(!1),_(null),c(!1)}))},me=e=>{U(e),L(!0)},ue=e=>{U(e),R(!0)},pe=e=>{ae(`/customers/${e._id}`)},he=async e=>{var a;const s=document.createElement("div");s.innerHTML=`
      <h1>${e.businessName} Details</h1>
      <p><strong>Contact Name:</strong> ${e.contactName}</p>
      <p><strong>Email:</strong> ${e.email}</p>
      <p><strong>Mobile:</strong> ${e.mobileNumber}</p>
      <p><strong>Address:</strong> ${e.addressLine1}, ${e.city}, ${e.state}, ${e.pincode}</p>
      <p><strong>Status:</strong> ${e.status}</p>
      <p><strong>Assigned To:</strong> ${((a=e.assignedTo)==null?void 0:a.name)||"Unassigned"}</p>
      ${e.notes&&e.notes.length>0?`
        <h2>Notes:</h2>
        <ul>
          ${e.notes.map(o=>`<li><strong>${o.timestamp}:</strong> ${o.text}</li>`).join("")}
        </ul>
      `:"<p>No notes available.</p>"}
      ${e.followUps&&e.followUps.length>0?`
        <h2>Follow-ups:</h2>
        <ul>
          ${e.followUps.map(o=>`<li><strong>${new Date(o.date).toLocaleDateString()}:</strong> ${o.note} (${o.status})</li>`).join("")}
        </ul>
      `:"<p>No follow-ups available.</p>"}
    `,s.style.width="210mm",s.style.padding="10mm",document.body.appendChild(s),r.loading("Generating PDF...",{id:"pdf-toast"});try{const o=await ye(s,{scale:2}),h=o.toDataURL("image/png"),C=new Se("p","mm","a4"),I=210,M=297,j=o.height*I/o.width;let w=j,N=0;for(C.addImage(h,"PNG",0,N,I,j),w-=M;w>=0;)N=w-j,C.addPage(),C.addImage(h,"PNG",0,N,I,j),w-=M;C.save(`${e.businessName}-details.pdf`),r.success("PDF generated!",{id:"pdf-toast"})}catch(o){r.error("Failed to generate PDF.",{id:"pdf-toast"}),console.error("PDF generation error:",o)}finally{document.body.removeChild(s)}},V=z.filter(e=>{var a,o,h;const s=T.toLowerCase();return e.status==="Customer"&&(((a=e.businessName)==null?void 0:a.toLowerCase().includes(s))||((o=e.contactName)==null?void 0:o.toLowerCase().includes(s))||((h=e.email)==null?void 0:h.toLowerCase().includes(s)))}).filter(e=>e.status==="Customer"),P=[],E=[{title:"Sno.",render:(e,s,a)=>a+1,width:60},{title:"Business Name",dataIndex:"businessName"},{title:"Contact Name",dataIndex:"contactName"},{title:"Email Id",dataIndex:"email"},{title:"Type",dataIndex:"type",render:e=>{switch(e){case"Hot":return t.jsx(g,{color:"red",children:"Hot"});case"Warm":return t.jsx(g,{color:"orange",children:"Warm"});case"Cold":return t.jsx(g,{color:"blue",children:"Cold"});default:return t.jsx(g,{children:"Unknown"})}}},{title:"Assigned To",render:(e,s)=>s.assignedTo?t.jsxs("span",{children:[s.assignedTo.name," (",s.assignedTo.role,")"]}):t.jsx("em",{children:"Unassigned"})},{title:"Latest Note",render:(e,s)=>{var o;const a=(o=s.notes)==null?void 0:o[s.notes.length-1];return a?t.jsxs("div",{children:[t.jsx("small",{style:{color:"#888"},children:a.timestamp}),t.jsx("br",{}),a.text]}):t.jsx("em",{children:"No notes"})}},{title:"Status",render:(e,s)=>t.jsx(g,{color:s.status==="Customer"?"blue":"gray",children:s.status})},{title:"Actions",render:(e,s)=>t.jsx(fe,{overlay:t.jsxs(l,{children:[t.jsx(l.Item,{icon:t.jsx(Fe,{}),onClick:()=>ie(s),children:"Edit Customer"},"edit"),t.jsx(l.Item,{icon:t.jsx(De,{}),onClick:()=>me(s),children:"View/Add Notes"},"notes"),t.jsx(l.Item,{icon:t.jsx(be,{}),onClick:()=>ue(s),children:"View/Add Follow-ups"},"followups"),t.jsx(l.Item,{icon:t.jsx(Te,{}),onClick:()=>pe(s),children:"View Profile"},"view-profile"),t.jsx(l.Item,{icon:t.jsx(ke,{}),onClick:()=>he(s),children:"Generate PDF"},"generate-pdf"),s.status==="Customer"?t.jsxs(t.Fragment,{children:[t.jsx(l.Item,{onClick:()=>$("Active",s),children:"Change to Active Lead"},"change-to-active-lead"),t.jsx(l.Item,{onClick:()=>$("Inactive",s),children:"Change to Inactive Lead"},"change-to-inactive-lead")]}):t.jsx(l.Item,{onClick:()=>$("Customer",s),children:"Change to Customer"},"change-to-customer"),t.jsx(l.Item,{icon:t.jsx(_e,{}),danger:!0,onClick:()=>ce(s),children:"Close Account"},"close-account")]}),trigger:["click"],children:t.jsx(xe,{icon:t.jsx(ve,{})})})}];return t.jsxs("div",{style:{padding:"24px"},children:[t.jsxs($e,{children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:16,flexWrap:"wrap"},children:[t.jsx(Le,{level:4,children:"Customers"}),t.jsx(Ne,{placeholder:"Search by Business Name, Contact Name or Email",prefix:t.jsx(Ae,{}),value:T,onChange:e=>O(e.target.value),style:{width:"100%",maxWidth:400}})]}),t.jsxs(G,{activeKey:K,onChange:q,children:[t.jsx(W,{tab:`All Customers (${V.length})`,children:t.jsx(B,{columns:E,dataSource:V,rowKey:"_id",pagination:{pageSize:10},loading:f,scroll:{x:"max-content"}})},"active"),t.jsx(W,{tab:`Inactive Customers (${P.length})`,children:t.jsx(B,{columns:E,dataSource:P,rowKey:"_id",pagination:{pageSize:10},loading:f,scroll:{x:"max-content"}})},"inactive")]})]}),t.jsx(Ce,{visible:Z,onClose:()=>b(!1),onSave:re,initialValues:i,allUsers:J,loadingUsers:X}),t.jsx(H,{title:"Confirm Status Change",open:ee,onOk:le,onCancel:()=>v(!1),okText:"Yes",cancelText:"No",confirmLoading:f,children:t.jsxs("p",{children:["Are you sure you want to change the status of ",t.jsx("strong",{children:p==null?void 0:p.businessName})," to ",t.jsx("strong",{children:y}),"?"]})}),t.jsx(H,{title:"Confirm Account Closure",open:te,onOk:de,onCancel:()=>S(!1),okText:"Close Account",okButtonProps:{danger:!0},cancelText:"Cancel",confirmLoading:f,children:t.jsxs("p",{children:["Are you sure you want to change the status of ",t.jsx("strong",{children:d==null?void 0:d.businessName})," to 'Closed'?"]})}),x&&t.jsx(je,{visible:oe,onClose:()=>R(!1),account:x,refreshAccounts:m}),x&&t.jsx(we,{visible:se,onClose:()=>L(!1),account:x,refreshAccounts:m})]})};export{ht as default};
