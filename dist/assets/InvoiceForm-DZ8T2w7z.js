import{r as c,s as F,p as e,B as x,q as W}from"./index-DO2xjt6F.js";import{R as K}from"./jspdf.es.min-CafCr0QM.js";import"./jspdf.plugin.autotable-TLQB5wf7.js";import{d as C,D as P}from"./index-DtYsO9Lt.js";import{i as k}from"./axios-0yhrvgHk.js";import{F as d}from"./index-DrHZk4bw.js";import{C as O}from"./index-BqrCpxkO.js";import{R as m,C as a}from"./row-CodefCjq.js";import{S as v}from"./index-Dr8C4fpI.js";import{I as o}from"./index-Bsc_TH0P.js";import{R as g}from"./index-Cx609xem.js";import{D as b}from"./index-CneINHzn.js";import{T as Y}from"./index-CYt6p7Zn.js";import{R as X}from"./DeleteOutlined-cXOMvh7W.js";import{R as Z}from"./SaveOutlined-BMH4Ja7T.js";import"./TextArea-BGWnTIhk.js";import"./index-xsH4HHeE.js";import"./PlusOutlined-CozxblFd.js";const{Option:u}=v,{TextArea:E}=o,ye=({onCancel:H,onSave:L,initialValues:s})=>{var B;const[D]=d.useForm(),[i,p]=c.useState([{id:1,description:"",hsnSac:"",quantity:1,rate:0}]),[T,N]=c.useState("pending"),[U,$]=c.useState([]),[j,M]=c.useState(null),[y,_]=c.useState([]),z=()=>{try{const n=JSON.parse(localStorage.getItem("user"));return(n==null?void 0:n.email)||"Unknown"}catch{return"Unknown"}};c.useEffect(()=>{k.get("/api/invoices/leads/active").then(n=>_(n.data)).catch(()=>F.error("Failed to load businesses"))},[]),c.useEffect(()=>{k.get("/api/invoices/types").then(n=>$(n.data)).catch(()=>F.error("Failed to load invoice types"))},[]),c.useEffect(()=>{var n;if(s){const t=((n=s.businessId)==null?void 0:n._id)||s.businessId,r=y.find(l=>l._id===t);D.setFieldsValue({...s,date:s.date?C(s.date):null,dueDate:s.dueDate?C(s.dueDate):null,paymentStatus:s.paymentStatus||"pending",invoiceType:s.invoiceType||"Invoice",businessName:r==null?void 0:r.businessName,businessType:r==null?void 0:r.type,businessInfo:r?[r.addressLine1,r.addressLine2,r.addressLine3,r.city,r.state,r.pincode,r.country].filter(Boolean).join(", "):"",gstin:(r==null?void 0:r.gstNumber)||"",businessId:r==null?void 0:r._id}),p(s.items||[]),N(s.paymentStatus||"pending"),M(s.dueDate?C(s.dueDate):null)}},[s,y]);const G=()=>{const n=Math.max(0,...i.map(t=>t.id))+1;p([...i,{id:n,description:"",hsnSac:"",quantity:1,rate:0}])},f=(n,t,r)=>{p(i.map(l=>l.id===n?{...l,[t]:r}:l))},J=n=>{p(i.filter(t=>t.id!==n))},I=()=>i.reduce((n,t)=>n+t.quantity*t.rate,0),S=()=>I()*.18,R=()=>I()+S(),Q=n=>{var q,A;const t=I(),r=S(),l=R(),w={amount:n.newPaymentAmount,method:n.newPaymentMethod,reference:n.newPaymentReference,date:(q=n.newPaymentDate)==null?void 0:q.format("YYYY-MM-DD"),addedBy:z()},h={...n,date:(A=n.date)==null?void 0:A.format("YYYY-MM-DD"),dueDate:j==null?void 0:j.format("YYYY-MM-DD"),paymentStatus:T,items:i,subTotal:t,tax:r,totalAmount:l};w.amount&&w.method&&(h.paymentHistory=[...(s==null?void 0:s.paymentHistory)||[],w]),delete h.newPaymentAmount,delete h.newPaymentMethod,delete h.newPaymentReference,delete h.newPaymentDate,L(h)};return e.jsx(O,{title:s?"Edit Invoice":"Create New Invoice",children:e.jsxs(d,{form:D,layout:"vertical",onFinish:Q,children:[e.jsxs(m,{gutter:16,children:[e.jsxs(a,{span:12,children:[e.jsx(d.Item,{label:"Business Name",name:"businessName",rules:[{required:!0}],children:e.jsx(v,{placeholder:"Select business",onChange:n=>{const t=y.find(r=>r.businessName===n);if(t){const r=[t.addressLine1,t.addressLine2,t.addressLine3,t.city,t.state,t.pincode,t.country].filter(Boolean).join(", ");D.setFieldsValue({businessType:t.type||"",businessInfo:r,gstin:t.gstNumber||"",businessId:t._id})}},children:y.map(n=>e.jsx(u,{value:n.businessName,children:n.businessName},n._id))})}),e.jsx(d.Item,{name:"businessId",hidden:!0,children:e.jsx(o,{})})]}),e.jsx(a,{span:12,children:e.jsx(d.Item,{label:"Business Type",name:"businessType",children:e.jsx(o,{readOnly:!0})})})]}),e.jsx(d.Item,{label:"Invoice Type",name:"invoiceType",rules:[{required:!0}],children:e.jsx(v,{placeholder:"Select invoice type",children:U.map(n=>e.jsx(u,{value:n,children:n},n))})}),e.jsxs(m,{gutter:16,children:[(s==null?void 0:s.invoiceNumber)&&e.jsx(a,{span:12,children:e.jsx(d.Item,{label:"Invoice Number",children:e.jsx(o,{value:s.invoiceNumber,readOnly:!0})})}),e.jsx(a,{span:12,children:e.jsx(d.Item,{label:"Business Info",name:"businessInfo",children:e.jsx(E,{rows:2})})})]}),e.jsxs(m,{gutter:16,children:[e.jsx(a,{span:12,children:e.jsx(d.Item,{label:"Date",name:"date",rules:[{required:!0}],children:e.jsx(P,{style:{width:"100%"},format:"DD/MM/YYYY"})})}),e.jsx(a,{span:12,children:e.jsx(d.Item,{label:"Due Date",name:"dueDate",children:e.jsx(P,{style:{width:"100%"},format:"DD/MM/YYYY",value:j,onChange:M})})})]}),e.jsxs(m,{gutter:16,children:[e.jsx(a,{span:12,children:e.jsx(d.Item,{label:"GSTIN",name:"gstin",children:e.jsx(o,{})})}),e.jsx(a,{span:12,children:e.jsx(d.Item,{label:"Customer Name",name:"customerName",rules:[{required:!0}],children:e.jsx(o,{})})})]}),e.jsx(d.Item,{label:"Customer Address",name:"customerAddress",rules:[{required:!0}],children:e.jsx(E,{rows:2})}),e.jsx(d.Item,{label:"Payment Status",name:"paymentStatus",children:e.jsxs(g.Group,{value:T,onChange:n=>N(n.target.value),children:[e.jsx(g.Button,{value:"pending",children:"Pending"}),e.jsx(g.Button,{value:"partial",children:"Partial"}),e.jsx(g.Button,{value:"paid",children:"Paid"})]})}),e.jsx(b,{children:"Items"}),i.map(n=>e.jsxs(m,{gutter:16,style:{marginBottom:12},children:[e.jsx(a,{span:6,children:e.jsx(o,{placeholder:"Description",value:n.description,onChange:t=>f(n.id,"description",t.target.value)})}),e.jsx(a,{span:4,children:e.jsx(o,{placeholder:"HSN/SAC",value:n.hsnSac,onChange:t=>f(n.id,"hsnSac",t.target.value)})}),e.jsx(a,{span:4,children:e.jsx(Y,{placeholder:"Qty",value:n.quantity,onChange:t=>f(n.id,"quantity",t),style:{width:"100%"}})}),e.jsx(a,{span:4,children:e.jsx(Y,{placeholder:"Rate",value:n.rate,onChange:t=>f(n.id,"rate",t),style:{width:"100%"}})}),e.jsx(a,{span:4,children:e.jsx(o,{value:`₹${(n.quantity*n.rate).toFixed(2)}`,readOnly:!0})}),e.jsx(a,{span:2,children:e.jsx(x,{icon:e.jsx(X,{}),danger:!0,onClick:()=>J(n.id)})})]},n.id)),e.jsx(x,{onClick:G,block:!0,children:"+ Add Item"}),e.jsx(b,{children:"Summary"}),e.jsxs(m,{gutter:16,children:[e.jsx(a,{span:8,children:e.jsx(o,{readOnly:!0,value:`₹${I().toFixed(2)}`,addonBefore:"Sub Total"})}),e.jsx(a,{span:8,children:e.jsx(o,{readOnly:!0,value:`₹${S().toFixed(2)}`,addonBefore:"GST (18%)"})}),e.jsx(a,{span:8,children:e.jsx(o,{readOnly:!0,value:`₹${R().toFixed(2)}`,addonBefore:"Total",style:{fontWeight:"bold"}})})]}),e.jsx(b,{children:"Payment History"}),((B=s==null?void 0:s.paymentHistory)==null?void 0:B.length)>0&&e.jsx("div",{style:{marginBottom:16},children:s.paymentHistory.map((n,t)=>e.jsxs(O,{size:"small",style:{marginBottom:8},children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Amount:"})," ₹",n.amount]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Method:"})," ",n.method]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Date:"})," ",n.date]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Reference:"})," ",n.reference]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Added By:"})," ",n.addedBy]})]},t))}),e.jsx(b,{children:"Add Payment Entry"}),e.jsxs(m,{gutter:16,children:[e.jsx(a,{span:6,children:e.jsx(d.Item,{label:"Amount",name:"newPaymentAmount",children:e.jsx(Y,{min:0,style:{width:"100%"}})})}),e.jsx(a,{span:6,children:e.jsx(d.Item,{label:"Method",name:"newPaymentMethod",children:e.jsxs(v,{placeholder:"Select method",children:[e.jsx(u,{value:"Cash",children:"Cash"}),e.jsx(u,{value:"Bank",children:"Bank"}),e.jsx(u,{value:"UPI",children:"UPI"}),e.jsx(u,{value:"Cheque",children:"Cheque"})]})})}),e.jsx(a,{span:6,children:e.jsx(d.Item,{label:"Reference",name:"newPaymentReference",children:e.jsx(o,{})})}),e.jsx(a,{span:6,children:e.jsx(d.Item,{label:"Date",name:"newPaymentDate",children:e.jsx(P,{style:{width:"100%"},format:"DD/MM/YYYY"})})})]}),e.jsx(d.Item,{style:{marginTop:24},children:e.jsxs(W,{children:[e.jsx(x,{type:"primary",htmlType:"submit",icon:e.jsx(Z,{}),size:"large",children:s?"Update Invoice":"Save Invoice"}),e.jsx(x,{onClick:H,size:"large",children:"Cancel"}),e.jsx(x,{icon:e.jsx(K,{}),size:"large",onClick:()=>window.print(),children:"Print"})]})})]})})};export{ye as default};
