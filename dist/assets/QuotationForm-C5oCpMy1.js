import{r as m,V as l,n as e,B as b,o as L}from"./index-DD76fs-h.js";import{a as E}from"./index-xsH4HHeE.js";import{d as q,D as N}from"./index-Dx7S66AB.js";import{F as n}from"./index-CVolLEbg.js";import{C as _}from"./index-CFl-p7rD.js";import{R as x,C as r}from"./row-qnhl_Xtb.js";import{S as F}from"./index-Cyejg2uk.js";import{I as o}from"./index-Bz8HKjRU.js";import{D as Y}from"./index-BelEbI9C.js";import{T as w}from"./index-C8gyv-gM.js";import{R as G}from"./DeleteOutlined-QhKYsw_D.js";import{R as H}from"./SaveOutlined-e6ymyoOE.js";import"./TextArea-CMtgeMII.js";import"./PlusOutlined-M3Xgh6eT.js";const{Option:P}=F,{TextArea:g}=o,de=({onCancel:O,onSave:$,initialValues:a})=>{const[f]=n.useForm(),[S,A]=m.useState([]),[d,h]=m.useState([{id:1,description:"",hsnSac:"",quantity:1,rate:0}]),[v,M]=m.useState([]),[I,c]=m.useState(!1);m.useEffect(()=>{c(!0);const s=l.loading("Loading business options...");E.get("/api/quotations/leads/active").then(t=>{A(t.data),l.success("Business options loaded",{id:s}),c(!1)}).catch(()=>{l.error("Failed to load businesses",{id:s}),c(!1)}),a&&(f.setFieldsValue({...a,date:a.date?q(a.date):null,validUntil:a.validUntil?q(a.validUntil):null,noteText:""}),h(a.items||[]),M(a.notes||[]))},[a]);const R=s=>{var T,C;if(!d||d.length===0){l.error("At least one item is required.");return}c(!0);const t=l.loading("Saving quotation..."),u=new Date().toLocaleString(),i=s.noteText?{text:s.noteText,timestamp:u}:null,Q={...s,date:(T=s.date)==null?void 0:T.format("YYYY-MM-DD"),validUntil:(C=s.validUntil)==null?void 0:C.format("YYYY-MM-DD"),items:d,notes:i?[...v,i]:v,subTotal:p(),tax:y(),total:D(),createdDate:new Date().toLocaleDateString()};try{$(Q),l.success("Quotation saved successfully",{id:t})}catch(k){l.error(`Failed to save: ${k.message}`,{id:t}),c(!1)}},B=()=>h([...d,{id:Date.now(),description:"",hsnSac:"",quantity:1,rate:0}]),U=s=>h(d.filter(t=>t.id!==s)),j=(s,t,u)=>{h(d.map(i=>i.id===s?{...i,[t]:u}:i))},p=()=>d.reduce((s,t)=>s+t.quantity*t.rate,0),y=()=>p()*.18,D=()=>p()+y();return e.jsx(_,{title:a?"Edit Quotation":"Create Quotation",loading:I,children:e.jsxs(n,{form:f,layout:"vertical",onFinish:R,children:[e.jsxs(x,{gutter:16,children:[e.jsxs(r,{span:12,children:[e.jsx(n.Item,{label:"Business",name:"businessId",rules:[{required:!0}],children:e.jsx(F,{placeholder:"Select business",onChange:s=>{const t=S.find(u=>u._id===s);t&&f.setFieldsValue({businessId:s,businessName:t.businessName,businessType:t.type,businessInfo:`${t.addressLine1}, ${t.city}, ${t.state}`,gstin:t.gstNumber})},children:S.map(s=>e.jsx(P,{value:s._id,children:s.businessName},s._id))})}),e.jsx(n.Item,{name:"businessName",hidden:!0,children:e.jsx(o,{})})]}),e.jsx(r,{span:12,children:e.jsx(n.Item,{name:"businessType",label:"Type",children:e.jsx(o,{readOnly:!0})})})]}),(a==null?void 0:a.quotationNumber)&&e.jsx(n.Item,{label:"Quotation Number",children:e.jsx(o,{value:a.quotationNumber,readOnly:!0})}),e.jsxs(x,{gutter:16,children:[e.jsx(r,{span:12,children:e.jsx(n.Item,{name:"date",label:"Date",rules:[{required:!0}],children:e.jsx(N,{style:{width:"100%"},format:"DD/MM/YYYY"})})}),e.jsx(r,{span:12,children:e.jsx(n.Item,{name:"validUntil",label:"Valid Until",children:e.jsx(N,{style:{width:"100%"},format:"DD/MM/YYYY"})})})]}),e.jsxs(x,{gutter:16,children:[e.jsx(r,{span:12,children:e.jsx(n.Item,{name:"gstin",label:"GSTIN",children:e.jsx(o,{})})}),e.jsx(r,{span:12,children:e.jsx(n.Item,{name:"customerName",label:"Customer Name",rules:[{required:!0}],children:e.jsx(o,{})})})]}),e.jsx(n.Item,{name:"customerAddress",label:"Customer Address",rules:[{required:!0}],children:e.jsx(g,{rows:2})}),e.jsx(n.Item,{name:"businessInfo",label:"Business Info",children:e.jsx(g,{rows:2})}),e.jsx(Y,{children:"Items"}),d.map(s=>e.jsxs(x,{gutter:16,style:{marginBottom:12},children:[e.jsx(r,{span:6,children:e.jsx(o,{placeholder:"Description",value:s.description,onChange:t=>j(s.id,"description",t.target.value)})}),e.jsx(r,{span:4,children:e.jsx(o,{placeholder:"HSN/SAC",value:s.hsnSac,onChange:t=>j(s.id,"hsnSac",t.target.value)})}),e.jsx(r,{span:4,children:e.jsx(w,{placeholder:"Qty",value:s.quantity,onChange:t=>j(s.id,"quantity",t),style:{width:"100%"}})}),e.jsx(r,{span:4,children:e.jsx(w,{placeholder:"Rate",value:s.rate,onChange:t=>j(s.id,"rate",t),style:{width:"100%"}})}),e.jsx(r,{span:4,children:e.jsx(o,{value:`₹${(s.quantity*s.rate).toFixed(2)}`,readOnly:!0})}),e.jsx(r,{span:2,children:e.jsx(b,{icon:e.jsx(G,{}),danger:!0,onClick:()=>U(s.id)})})]},s.id)),e.jsx(b,{onClick:B,block:!0,children:"+ Add Item"}),e.jsx(Y,{children:"Summary"}),e.jsxs(x,{gutter:16,children:[e.jsx(r,{span:8,children:e.jsx(n.Item,{label:"Sub Total",children:e.jsx(o,{readOnly:!0,value:`₹${p().toFixed(2)}`})})}),e.jsx(r,{span:8,children:e.jsx(n.Item,{label:"GST (18%)",children:e.jsx(o,{readOnly:!0,value:`₹${y().toFixed(2)}`})})}),e.jsx(r,{span:8,children:e.jsx(n.Item,{label:"Total",children:e.jsx(o,{readOnly:!0,value:`₹${D().toFixed(2)}`})})})]}),e.jsx(n.Item,{name:"noteText",label:"Add Note",children:e.jsx(g,{rows:2,placeholder:"Add new note..."})}),e.jsx(n.Item,{children:e.jsxs(L,{children:[e.jsx(b,{htmlType:"submit",type:"primary",icon:e.jsx(H,{}),loading:I,children:"Save"}),e.jsx(b,{onClick:O,disabled:I,children:"Cancel"})]})})]})})};export{de as default};
