import{r as n,J as me,x as e,H as ge,B as D,S as fe,an as i,ao as he,ap as x}from"./index-CDHHEH9R.js";import{i as S}from"./axios-CSlAuMiO.js";import{R as xe,a as Se,B as ye,F as Ce,N as je,b as be}from"./FollowUpDrawer-C0fo0bzK.js";import{h as we,E as Te,R as Ne}from"./html2canvas.esm-D4gOIGy2.js";import{u as F,a as Ie}from"./xlsx-CyWl6TWy.js";import{C as Ae}from"./index-DCFdla3I.js";import{T as ve}from"./index-Govk3_r-.js";import{I as $e}from"./index-moz96MFa.js";import{c as ze}from"./TextArea-DuGAdjqD.js";import{T as V}from"./index-ZgWJIb_H.js";import{F as De}from"./Table-b-pe5h1z.js";import{E as Fe}from"./index-_DW4MO8t.js";import{M as Ee}from"./index-CVA8aRI9.js";import{T as C}from"./index-BxYB1PTR.js";import{R as _e}from"./EditOutlined-xqHe53iW.js";import{R as ke}from"./MessageOutlined-2SzkZOCK.js";import{P as Le}from"./index-BQzleOIU.js";import{R as Re}from"./DeleteOutlined-S1VgwgK-.js";import"./index-BGDXiIZJ.js";import"./index-Dg-FNmH8.js";import"./context-cWxd9jnK.js";import"./useClosable-GYGSyFE0.js";import"./index-DYhdLMFp.js";import"./index-gOyG0OeV.js";import"./PlusOutlined-ByfnQIH-.js";import"./moment-C5S46NFB.js";import"./index-4mnRxljj.js";import"./dayjs.min-F-oh7tHl.js";import"./index-DWClh8PC.js";import"./Pagination-Dihjq4x4.js";import"./styleChecker-BPp1vV_G.js";import"./addEventListener-uZJL53jX.js";import"./index-CmB5d6LT.js";import"./InfoCircleFilled-CVv9ml8T.js";import"./ActionButton-FXhSaRtp.js";import"./index-Dl72V75l.js";const{Title:Pe}=ve,{TabPane:Ue}=V,j="/api/accounts",wt=()=>{const[d,O]=n.useState(""),[M,W]=n.useState("customer"),[b,H]=n.useState([]),[E,p]=n.useState(!1),[G,Y]=n.useState([]),[J,_]=n.useState(!1),[K,T]=n.useState(!1),[m,k]=n.useState(null),[q,N]=n.useState(!1),[y,L]=n.useState(null),[I,R]=n.useState(null),[Q,P]=n.useState(!1),[X,U]=n.useState(!1),[A,B]=n.useState(null),Z=me();n.useRef(null);const f=JSON.parse(localStorage.getItem("user")),w=f==null?void 0:f.role,v=f==null?void 0:f._id,[a,$]=n.useState({current:1,pageSize:10,total:0}),g=async(s={})=>{p(!0);try{const{current:t=a.current,pageSize:r=a.pageSize,searchText:o="",sortBy:l="createdAt",sortOrder:h="desc"}=s;let c=`${j}/paginated?page=${t}&pageSize=${r}&search=${o}&status=Customer`;l&&(c+=`&sortBy=${l}`),h&&(c+=`&sortOrder=${h}`),w==="Employee"&&v&&(c+=`&userId=${v}&role=${w}`);const u=await S.get(c);H(u.data.data),$({...a,current:u.data.page,pageSize:u.data.pageSize,total:u.data.total})}catch(t){i.error("Failed to load customers"),console.error("Error fetching customers:",t)}finally{p(!1)}},ee=async()=>{_(!0);try{const s=await S.get("/api/accounts/users/all");Y(s.data)}catch(s){i.error("Failed to load user list"),console.error("Error fetching users:",s)}finally{_(!1)}};n.useEffect(()=>{g({current:a.current,pageSize:a.pageSize,searchText:d}),ee()},[a.current,a.pageSize,d,w,v]);const te=s=>{k(s),T(!0)},se=async s=>{var t;p(!0);try{m!=null&&m._id?(await S.put(`${j}/${m._id}`,s),i.success("Customer updated successfully")):(await S.post(j,s),i.success("Customer created successfully")),g({current:a.current,pageSize:a.pageSize,searchText:d})}catch(r){i.error(`Failed to ${m!=null&&m._id?"update":"create"} customer`),console.error("Save customer error:",((t=r.response)==null?void 0:t.data)||r.message)}finally{T(!1),k(null),p(!1)}},oe=(s,t)=>{L(t),R(s),N(!0)},ae=async()=>{var s;p(!0);try{const t={...y,status:I};await S.put(`${j}/${y._id}`,t),i.success(`Status updated to ${I}`),g({current:a.current,pageSize:a.pageSize,searchText:d})}catch(t){i.error("Failed to update status"),console.error("Status update error:",((s=t.response)==null?void 0:s.data)||t.message)}finally{N(!1),L(null),R(null),p(!1)}},re=async s=>{var t;p(!0);try{await S.put(`${j}/${s}`,{status:"Closed",isCustomer:!1}),i.success("Customer status set to Closed"),g({current:a.current,pageSize:a.pageSize,searchText:d})}catch(r){i.error("Failed to close customer account"),console.error("Soft delete error:",((t=r.response)==null?void 0:t.data)||r.message)}finally{p(!1)}},ne=s=>{B(s),P(!0)},ie=s=>{B(s),U(!0)},ce=s=>{Z(`/customers/${s._id}`)},le=async()=>{const s=document.getElementById("customerTable");if(!s){i.error("Table content not found for PDF export.");return}i.loading("Generating PDF...",{id:"pdf-toast"});try{const t=await we(s,{scale:2}),r=t.toDataURL("image/png"),o=new Te("p","mm","a4"),l=210,h=297,c=t.height*l/t.width;let u=c,z=0;for(o.addImage(r,"PNG",0,z,l,c),u-=h;u>=0;)z=u-c,o.addPage(),o.addImage(r,"PNG",0,z,l,c),u-=h;o.save("Customers_Details.pdf"),i.success("PDF generated!",{id:"pdf-toast"})}catch(t){console.error("Error generating PDF:",t),i.error("Failed to generate PDF.",{id:"pdf-toast"})}},de=()=>{if(b.length===0){i.error("No data to export to Excel.");return}const s=b.map((o,l)=>{var c;return{"S.No":l+1+(a.current-1)*a.pageSize,"Business Name":o.businessName,"Contact Name":o.contactName,Email:o.email,"Mobile Number":o.mobileNumber,"Lead Type":o.type,Status:o.status,"Source Type":o.sourceType,"Assigned To":((c=o.assignedTo)==null?void 0:c.name)||"Unassigned","GST Number":o.gstNumber,"Phone Number":o.phoneNumber,"Address Line 1":o.addressLine1,"Address Line 2":o.addressLine2,"Address Line 3":o.addressLine3,Landmark:o.landmark,City:o.city,Pincode:o.pincode,State:o.state,Country:o.country,Website:o.website,"Is Customer":o.isCustomer?"Yes":"No","Created At":new Date(o.createdAt).toLocaleString()}}),t=F.json_to_sheet(s),r=F.book_new();F.book_append_sheet(r,t,"Customers Data"),Ie(r,"Customers_Data.xlsx"),i.success("Data exported to Excel!")},ue=[{title:"Sno.",render:(s,t,r)=>r+1+(a.current-1)*a.pageSize,width:60},{title:"Business Name",dataIndex:"businessName",render:(s,t)=>e.jsx("a",{onClick:()=>ce(t),style:{cursor:"pointer",color:"#1890ff"},children:s})},{title:"Contact Name",dataIndex:"contactName"},{title:"Email Id",dataIndex:"email"},{title:"Type",dataIndex:"type",render:s=>{switch(s){case"Hot":return e.jsx(C,{color:"red",children:"Hot"});case"Warm":return e.jsx(C,{color:"orange",children:"Warm"});case"Cold":return e.jsx(C,{color:"blue",children:"Cold"});default:return e.jsx(C,{children:"Unknown"})}}},{title:"Assigned To",render:(s,t)=>t.assignedTo?e.jsxs("span",{children:[t.assignedTo.name," (",t.assignedTo.role,")"]}):e.jsx("em",{children:"Unassigned"})},{title:"Latest Note",render:(s,t)=>{var o;const r=(o=t.notes)==null?void 0:o[t.notes.length-1];return r?e.jsxs("div",{children:[e.jsx("small",{style:{color:"#888"},children:new Date(r.timestamp).toLocaleString()}),e.jsx("br",{}),r.text]}):e.jsx("em",{children:"No notes"})}},{title:"Status",render:(s,t)=>e.jsx(C,{color:t.status==="Customer"?"blue":"gray",children:t.status})},{title:"Actions",render:(s,t)=>e.jsx(he,{overlay:e.jsxs(x,{children:[e.jsx(x.Item,{icon:e.jsx(_e,{}),onClick:()=>te(t),children:"Edit Customer"},"edit"),e.jsx(x.Item,{icon:e.jsx(ke,{}),onClick:()=>ne(t),children:"View/Add Notes"},"notes"),e.jsx(x.Item,{icon:e.jsx(be,{}),onClick:()=>ie(t),children:"View/Add Follow-ups"},"followups"),e.jsx(x.Item,{onClick:()=>oe("Active",t),children:"Change to Active Lead"},"change-to-active"),w==="Superadmin"&&e.jsx(x.Item,{children:e.jsxs(Le,{title:"Are you sure you want to close this account? This will set its status to 'Closed'.",onConfirm:()=>re(t._id),okText:"Yes",cancelText:"No",children:[e.jsx(Re,{}),"Close Account"]})},"close-account")]}),trigger:["click"],children:e.jsx(D,{icon:e.jsx(Ne,{})})})}],pe=(s,t,r)=>{$(s);const o=r.field,l=r.order==="ascend"?"asc":r.order==="descend"?"desc":void 0;g({current:s.current,pageSize:s.pageSize,searchText:d,sortBy:o,sortOrder:l})};return e.jsxs("div",{children:[e.jsxs(Ae,{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:16,flexWrap:"wrap",gap:"10px"},children:[e.jsx(Pe,{level:4,children:"Customers"}),e.jsx($e,{placeholder:"Search by Business Name, Contact Name or Email",prefix:e.jsx(ze,{}),value:d,onChange:s=>{O(s.target.value),$({...a,current:1})},style:{width:"100%",maxWidth:150}}),e.jsxs(ge,{children:[e.jsx(D,{icon:e.jsx(xe,{}),onClick:le,style:{marginBottom:16,backgroundColor:"#ef7a1b",borderColor:"#orange",color:"white"},children:"Export to PDF"}),e.jsx(D,{icon:e.jsx(Se,{}),onClick:de,style:{marginBottom:16,backgroundColor:"#ef7a1b",borderColor:"#orange",color:"white"},children:"Export to Excel"})]})]}),e.jsx(V,{activeKey:M,onChange:W,children:e.jsx(Ue,{tab:`All Customers (${a.total})`,children:E?e.jsx(fe,{size:"large",style:{display:"block",margin:"50px auto"}}):b.length>0?e.jsxs("div",{id:"customerTable",children:[" ",e.jsx(De,{columns:ue,dataSource:b,rowKey:"_id",pagination:a,onChange:pe,scroll:{x:"max-content"}})]}):e.jsx(Fe,{description:"No customers found."})},"customer")})]}),e.jsx(ye,{visible:K,onClose:()=>T(!1),onSave:se,initialValues:m,allUsers:G,loadingUsers:J}),e.jsx(Ee,{title:"Confirm Status Change",open:q,onOk:ae,onCancel:()=>N(!1),okText:"Yes",cancelText:"No",confirmLoading:E,children:e.jsxs("p",{children:["Are you sure you want to change the status of ",e.jsx("strong",{children:y==null?void 0:y.businessName})," to ",e.jsx("strong",{children:I}),"?"]})}),A&&e.jsxs(e.Fragment,{children:[e.jsx(Ce,{visible:X,onClose:()=>U(!1),account:A,refreshAccounts:()=>g({current:a.current,pageSize:a.pageSize,searchText:d})}),e.jsx(je,{visible:Q,onClose:()=>P(!1),account:A,refreshAccounts:()=>g({current:a.current,pageSize:a.pageSize,searchText:d})})]})]})};export{wt as default};
