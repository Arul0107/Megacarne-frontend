import{r as u,V as l,p as e,B as b,q as G}from"./index-B-Scc70w.js";import{i as S}from"./axios-0yhrvgHk.js";import{d as $,D as O}from"./index-DfCZo8zT.js";import{F as r}from"./index-CJSKmZ54.js";import{C as H}from"./index-CTyommp3.js";import{R as m,C as a}from"./row-jLefKywz.js";import{S as R}from"./index-T1SRL-JP.js";import{I as o}from"./index-D2P39C2r.js";import{D as A}from"./index-BxykBC4t.js";import{T as M}from"./index-1O6uZkHD.js";import{R as P}from"./DeleteOutlined-DHx9rL6p.js";import{R as z}from"./SaveOutlined-Do8eWzJm.js";import"./index-xsH4HHeE.js";import"./TextArea-3xmhtIFj.js";import"./PlusOutlined-Br6dYwaI.js";const{Option:J}=R,{TextArea:v}=o,ce=({onCancel:B,onSave:U,initialValues:n})=>{const[f]=r.useForm(),[q,Q]=u.useState([]),[d,x]=u.useState([{id:1,description:"",hsnSac:"",quantity:1,rate:0}]),[D,k]=u.useState([]),[y,T]=u.useState(!1);u.useEffect(()=>{const s=l.loading("Loading business options...");S.get("/api/quotations/leads/active").then(t=>{Q(t.data),l.success("Business options loaded",{id:s})}).catch(()=>{l.error("Failed to load businesses",{id:s})}),n&&(f.setFieldsValue({...n,date:n.date?$(n.date):null,validUntil:n.validUntil?$(n.validUntil):null,noteText:""}),x(n.items||[]),k(n.notes||[]))},[n]);const L=async s=>{var N,Y,w,F;if(!d||d.length===0){l.error("At least one item is required.");return}T(!0);const t=l.loading("Saving quotation..."),c=new Date().toLocaleString(),i=s.noteText?{text:s.noteText,timestamp:c}:null,g={...s,date:(N=s.date)==null?void 0:N.format("YYYY-MM-DD"),validUntil:(Y=s.validUntil)==null?void 0:Y.format("YYYY-MM-DD"),items:d,notes:i?[...D,i]:D,subTotal:h(),tax:I(),total:C(),createdDate:new Date().toLocaleDateString()};try{n!=null&&n._id?await S.put(`/api/quotations/${n._id}`,g):await S.post("/api/quotations",g),l.success("Quotation saved successfully",{id:t}),U(g)}catch(j){l.error(`Failed to save: ${((F=(w=j==null?void 0:j.response)==null?void 0:w.data)==null?void 0:F.message)||j.message}`,{id:t})}finally{T(!1)}},_=()=>x([...d,{id:Date.now(),description:"",hsnSac:"",quantity:1,rate:0}]),E=s=>x(d.filter(t=>t.id!==s)),p=(s,t,c)=>{x(d.map(i=>i.id===s?{...i,[t]:c}:i))},h=()=>d.reduce((s,t)=>s+t.quantity*t.rate,0),I=()=>h()*.18,C=()=>h()+I();return e.jsx(H,{title:n?"Edit Quotation":"Create Quotation",loading:y,children:e.jsxs(r,{form:f,layout:"vertical",onFinish:L,children:[e.jsxs(m,{gutter:16,children:[e.jsxs(a,{span:12,children:[e.jsx(r.Item,{label:"Business",name:"businessId",rules:[{required:!0}],children:e.jsx(R,{placeholder:"Select business",onChange:s=>{const t=q.find(c=>c._id===s);t&&f.setFieldsValue({businessId:s,businessName:t.businessName,businessType:t.type,businessInfo:`${t.addressLine1}, ${t.city}, ${t.state}`,gstin:t.gstNumber})},children:q.map(s=>e.jsx(J,{value:s._id,children:s.businessName},s._id))})}),e.jsx(r.Item,{name:"businessName",hidden:!0,children:e.jsx(o,{})})]}),e.jsx(a,{span:12,children:e.jsx(r.Item,{name:"businessType",label:"Type",children:e.jsx(o,{readOnly:!0})})})]}),(n==null?void 0:n.quotationNumber)&&e.jsx(r.Item,{label:"Quotation Number",children:e.jsx(o,{value:n.quotationNumber,readOnly:!0})}),e.jsxs(m,{gutter:16,children:[e.jsx(a,{span:12,children:e.jsx(r.Item,{name:"date",label:"Date",rules:[{required:!0}],children:e.jsx(O,{style:{width:"100%"},format:"DD/MM/YYYY"})})}),e.jsx(a,{span:12,children:e.jsx(r.Item,{name:"validUntil",label:"Valid Until",children:e.jsx(O,{style:{width:"100%"},format:"DD/MM/YYYY"})})})]}),e.jsxs(m,{gutter:16,children:[e.jsx(a,{span:12,children:e.jsx(r.Item,{name:"gstin",label:"GSTIN",children:e.jsx(o,{})})}),e.jsx(a,{span:12,children:e.jsx(r.Item,{name:"customerName",label:"Customer Name",rules:[{required:!0}],children:e.jsx(o,{})})})]}),e.jsx(r.Item,{name:"customerAddress",label:"Customer Address",rules:[{required:!0}],children:e.jsx(v,{rows:2})}),e.jsx(r.Item,{name:"businessInfo",label:"Business Info",children:e.jsx(v,{rows:2})}),e.jsx(A,{children:"Items"}),d.map(s=>e.jsxs(m,{gutter:16,style:{marginBottom:12},children:[e.jsx(a,{span:6,children:e.jsx(o,{placeholder:"Description",value:s.description,onChange:t=>p(s.id,"description",t.target.value)})}),e.jsx(a,{span:4,children:e.jsx(o,{placeholder:"HSN/SAC",value:s.hsnSac,onChange:t=>p(s.id,"hsnSac",t.target.value)})}),e.jsx(a,{span:4,children:e.jsx(M,{placeholder:"Qty",value:s.quantity,onChange:t=>p(s.id,"quantity",t),style:{width:"100%"}})}),e.jsx(a,{span:4,children:e.jsx(M,{placeholder:"Rate",value:s.rate,onChange:t=>p(s.id,"rate",t),style:{width:"100%"}})}),e.jsx(a,{span:4,children:e.jsx(o,{value:`₹${(s.quantity*s.rate).toFixed(2)}`,readOnly:!0})}),e.jsx(a,{span:2,children:e.jsx(b,{icon:e.jsx(P,{}),danger:!0,onClick:()=>E(s.id)})})]},s.id)),e.jsx(b,{onClick:_,block:!0,children:"+ Add Item"}),e.jsx(A,{children:"Summary"}),e.jsxs(m,{gutter:16,children:[e.jsx(a,{span:8,children:e.jsx(r.Item,{label:"Sub Total",children:e.jsx(o,{readOnly:!0,value:`₹${h().toFixed(2)}`})})}),e.jsx(a,{span:8,children:e.jsx(r.Item,{label:"GST (18%)",children:e.jsx(o,{readOnly:!0,value:`₹${I().toFixed(2)}`})})}),e.jsx(a,{span:8,children:e.jsx(r.Item,{label:"Total",children:e.jsx(o,{readOnly:!0,value:`₹${C().toFixed(2)}`})})})]}),e.jsx(r.Item,{name:"noteText",label:"Add Note",children:e.jsx(v,{rows:2,placeholder:"Add new note..."})}),e.jsx(r.Item,{children:e.jsxs(G,{children:[e.jsx(b,{htmlType:"submit",type:"primary",icon:e.jsx(z,{}),loading:y,children:"Save"}),e.jsx(b,{onClick:B,disabled:y,children:"Cancel"})]})})]})})};export{ce as default};
