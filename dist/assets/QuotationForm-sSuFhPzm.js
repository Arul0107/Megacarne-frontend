import{v as n,r as x,V as l,s as R,G as N,o as e,q as E,p as h,C as a,H as F,I as d,J as C,K as Y,M as w,B as b,A as G,w as _,N as H}from"./index-BHNQ9zbu.js";const{Option:J}=F,{TextArea:f}=d,P=({onCancel:A,onSave:M,initialValues:r})=>{const[I]=n.useForm(),[v,O]=x.useState([]),[o,j]=x.useState([{id:1,description:"",hsnSac:"",quantity:1,rate:0}]),[S,$]=x.useState([]),[y,c]=x.useState(!1);x.useEffect(()=>{c(!0);const s=l.loading("Loading business options...");R.get("/api/quotations/leads/active").then(t=>{O(t.data),l.success("Business options loaded",{id:s}),c(!1)}).catch(()=>{l.error("Failed to load businesses",{id:s}),c(!1)}),r&&(I.setFieldsValue({...r,date:r.date?N(r.date):null,validUntil:r.validUntil?N(r.validUntil):null,noteText:""}),j(r.items||[]),$(r.notes||[]))},[r]);const B=s=>{var q,D;if(!o||o.length===0){l.error("At least one item is required.");return}c(!0);const t=l.loading("Saving quotation..."),u=new Date().toLocaleString(),i=s.noteText?{text:s.noteText,timestamp:u}:null,k={...s,date:(q=s.date)==null?void 0:q.format("YYYY-MM-DD"),validUntil:(D=s.validUntil)==null?void 0:D.format("YYYY-MM-DD"),items:o,notes:i?[...S,i]:S,subTotal:p(),tax:g(),total:T(),createdDate:new Date().toLocaleDateString()};try{M(k),l.success("Quotation saved successfully",{id:t})}catch(L){l.error(`Failed to save: ${L.message}`,{id:t}),c(!1)}},U=()=>j([...o,{id:Date.now(),description:"",hsnSac:"",quantity:1,rate:0}]),Q=s=>j(o.filter(t=>t.id!==s)),m=(s,t,u)=>{j(o.map(i=>i.id===s?{...i,[t]:u}:i))},p=()=>o.reduce((s,t)=>s+t.quantity*t.rate,0),g=()=>p()*.18,T=()=>p()+g();return e.jsx(E,{title:r?"Edit Quotation":"Create Quotation",loading:y,children:e.jsxs(n,{form:I,layout:"vertical",onFinish:B,children:[e.jsxs(h,{gutter:16,children:[e.jsxs(a,{span:12,children:[e.jsx(n.Item,{label:"Business",name:"businessId",rules:[{required:!0}],children:e.jsx(F,{placeholder:"Select business",onChange:s=>{const t=v.find(u=>u._id===s);t&&I.setFieldsValue({businessId:s,businessName:t.businessName,businessType:t.type,businessInfo:`${t.addressLine1}, ${t.city}, ${t.state}`,gstin:t.gstNumber})},children:v.map(s=>e.jsx(J,{value:s._id,children:s.businessName},s._id))})}),e.jsx(n.Item,{name:"businessName",hidden:!0,children:e.jsx(d,{})})]}),e.jsx(a,{span:12,children:e.jsx(n.Item,{name:"businessType",label:"Type",children:e.jsx(d,{readOnly:!0})})})]}),(r==null?void 0:r.quotationNumber)&&e.jsx(n.Item,{label:"Quotation Number",children:e.jsx(d,{value:r.quotationNumber,readOnly:!0})}),e.jsxs(h,{gutter:16,children:[e.jsx(a,{span:12,children:e.jsx(n.Item,{name:"date",label:"Date",rules:[{required:!0}],children:e.jsx(C,{style:{width:"100%"},format:"DD/MM/YYYY"})})}),e.jsx(a,{span:12,children:e.jsx(n.Item,{name:"validUntil",label:"Valid Until",children:e.jsx(C,{style:{width:"100%"},format:"DD/MM/YYYY"})})})]}),e.jsxs(h,{gutter:16,children:[e.jsx(a,{span:12,children:e.jsx(n.Item,{name:"gstin",label:"GSTIN",children:e.jsx(d,{})})}),e.jsx(a,{span:12,children:e.jsx(n.Item,{name:"customerName",label:"Customer Name",rules:[{required:!0}],children:e.jsx(d,{})})})]}),e.jsx(n.Item,{name:"customerAddress",label:"Customer Address",rules:[{required:!0}],children:e.jsx(f,{rows:2})}),e.jsx(n.Item,{name:"businessInfo",label:"Business Info",children:e.jsx(f,{rows:2})}),e.jsx(Y,{children:"Items"}),o.map(s=>e.jsxs(h,{gutter:16,style:{marginBottom:12},children:[e.jsx(a,{span:6,children:e.jsx(d,{placeholder:"Description",value:s.description,onChange:t=>m(s.id,"description",t.target.value)})}),e.jsx(a,{span:4,children:e.jsx(d,{placeholder:"HSN/SAC",value:s.hsnSac,onChange:t=>m(s.id,"hsnSac",t.target.value)})}),e.jsx(a,{span:4,children:e.jsx(w,{placeholder:"Qty",value:s.quantity,onChange:t=>m(s.id,"quantity",t),style:{width:"100%"}})}),e.jsx(a,{span:4,children:e.jsx(w,{placeholder:"Rate",value:s.rate,onChange:t=>m(s.id,"rate",t),style:{width:"100%"}})}),e.jsx(a,{span:4,children:e.jsx(d,{value:`₹${(s.quantity*s.rate).toFixed(2)}`,readOnly:!0})}),e.jsx(a,{span:2,children:e.jsx(b,{icon:e.jsx(G,{}),danger:!0,onClick:()=>Q(s.id)})})]},s.id)),e.jsx(b,{onClick:U,block:!0,children:"+ Add Item"}),e.jsx(Y,{children:"Summary"}),e.jsxs(h,{gutter:16,children:[e.jsx(a,{span:8,children:e.jsx(n.Item,{label:"Sub Total",children:e.jsx(d,{readOnly:!0,value:`₹${p().toFixed(2)}`})})}),e.jsx(a,{span:8,children:e.jsx(n.Item,{label:"GST (18%)",children:e.jsx(d,{readOnly:!0,value:`₹${g().toFixed(2)}`})})}),e.jsx(a,{span:8,children:e.jsx(n.Item,{label:"Total",children:e.jsx(d,{readOnly:!0,value:`₹${T().toFixed(2)}`})})})]}),e.jsx(n.Item,{name:"noteText",label:"Add Note",children:e.jsx(f,{rows:2,placeholder:"Add new note..."})}),e.jsx(n.Item,{children:e.jsxs(_,{children:[e.jsx(b,{htmlType:"submit",type:"primary",icon:e.jsx(H,{}),loading:y,children:"Save"}),e.jsx(b,{onClick:A,disabled:y,children:"Cancel"})]})})]})})};export{P as default};
