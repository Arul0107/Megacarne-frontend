import{r as h,s as g,p as e,B as j,q as ne,V as p,T as se,D as le,M as f}from"./index-Bq7SEXuf.js";import{R as X,E as ae}from"./jspdf.es.min-zBOFm9dL.js";import re from"./html2canvas.esm-CBrSDip1.js";import{i as M,I as ee,R as ie}from"./axios-GhlsiOT5.js";import{h as F,R as de}from"./moment-CYyrXtnG.js";import{D as ce}from"./index-DadFFg_X.js";import{D as me}from"./index-46gWX4pY.js";import{D as H}from"./index-Dsy7Z7ff.js";import{T as te}from"./index-CbdXlDe3.js";import{L as Q}from"./index-JPHp6_-t.js";import{T as oe,a as z}from"./index-SmLCrNGy.js";import{M as K}from"./index-D0lY9ADb.js";import{a as ue}from"./index-BOPJqWeZ.js";import{F as u,R as pe}from"./Table-Bf67WVZ7.js";import{D as r}from"./index-BsVbQk8t.js";import{R as he}from"./MessageOutlined-DEnj2zof.js";import{R as xe}from"./ScheduleOutlined-C2Ld9lZO.js";import{R as ge}from"./DeleteOutlined-DFLVsPO1.js";import"./context-B8wIWz00.js";import"./index-gpSYoz0o.js";import"./index-BMaUSiUl.js";const{TextArea:fe}=ee,{TabPane:q}=te,{Text:Z}=oe,je=({visible:y,onClose:L,quotation:m,refreshQuotations:E})=>{const[C,w]=h.useState(""),[T,I]=h.useState(null),[O,b]=h.useState(!1),[l,Y]=h.useState([]),[N,D]=h.useState(null);h.useEffect(()=>{y&&(m!=null&&m._id)&&v()},[y,m]);const v=async()=>{try{const t=await M.get(`/api/quotations/${m._id}/followups`);Y(t.data||[])}catch(t){console.error("Failed to fetch follow-ups for quotation:",t),g.error("Failed to fetch follow-ups for this quotation.")}},V=()=>{if(!C||!T){g.error("Please fill in both date and note fields.");return}const t=JSON.parse(localStorage.getItem("user")),n=t==null?void 0:t._id;if(!n){g.error("User information not found. Please log in.");return}b(!0);const s={date:T.format("YYYY-MM-DD"),note:C,addedBy:n};(N===null?M.post(`/api/quotations/${m._id}/followups`,s):M.put(`/api/quotations/${m._id}/followups/${N}`,s)).then(()=>{g.success(N===null?"Follow-up added successfully!":"Follow-up updated successfully!"),w(""),I(null),D(null),v(),E()}).catch(i=>{var c,A;console.error("Error saving follow-up:",i),g.error(((A=(c=i==null?void 0:i.response)==null?void 0:c.data)==null?void 0:A.message)||"Failed to save follow-up.")}).finally(()=>b(!1))},_=t=>{const n=l[t];w(n.note),I(F(n.date)),D(t)},x=t=>{K.confirm({title:"Delete Follow-up",content:"Are you sure you want to delete this follow-up? This action cannot be undone.",okText:"Yes, Delete",cancelText:"No",okButtonProps:{danger:!0},onOk:()=>{M.delete(`/api/quotations/${m._id}/followups/${t}`).then(()=>{g.success("Follow-up deleted successfully!"),v(),E()}).catch(n=>{var s,a;console.error("Error deleting follow-up:",n),g.error(((a=(s=n==null?void 0:n.response)==null?void 0:s.data)==null?void 0:a.message)||"Failed to delete follow-up.")})}})},S=F().format("YYYY-MM-DD"),$=[...l].sort((t,n)=>new Date(n.date)-new Date(t.date)),k=$.filter(t=>F(t.date).format("YYYY-MM-DD")===S),P=$.filter(t=>F(t.date).isAfter(S,"day")),B=$.filter(t=>F(t.date).isBefore(S,"day")),o=(t,n)=>{var s,a;return e.jsx(Q.Item,{actions:[e.jsx(j,{type:"link",onClick:()=>_(n),children:"Edit"},"edit"),e.jsx(j,{type:"link",danger:!0,onClick:()=>x(n),children:"Delete"},"delete")],children:e.jsxs("div",{children:[e.jsx(Z,{strong:!0,children:F(t.date).format("DD-MM-YYYY")}),e.jsx("br",{}),t.note,e.jsx("br",{}),e.jsxs(Z,{type:"secondary",children:["By ",((s=t.addedBy)==null?void 0:s.name)||((a=t.addedBy)==null?void 0:a.email)||"Unknown User"]})]})})};return e.jsxs(ce,{title:`Follow-ups for Quotation: ${(m==null?void 0:m.quotationNumber)||"N/A"}`,open:y,onClose:()=>{D(null),w(""),I(null),L()},width:720,children:[e.jsxs("div",{style:{marginBottom:20},children:[e.jsx(me,{style:{width:"100%",marginBottom:8},format:"DD-MM-YYYY",value:T,onChange:t=>I(t),placeholder:"Select follow-up date"}),e.jsx(fe,{rows:4,placeholder:"Enter follow-up note",value:C,onChange:t=>w(t.target.value)}),e.jsx(j,{type:"primary",block:!0,onClick:V,loading:O,style:{marginTop:10},children:N===null?"Add Follow-up":"Update Follow-up"})]}),e.jsx(H,{children:"Existing Follow-ups"}),e.jsxs(te,{defaultActiveKey:"today",children:[e.jsx(q,{tab:`Today's (${k.length})`,children:e.jsx(Q,{dataSource:k,renderItem:t=>o(t,l.indexOf(t)),locale:{emptyText:"No follow-ups scheduled for today."}})},"today"),e.jsx(q,{tab:`Upcoming (${P.length})`,children:e.jsx(Q,{dataSource:P,renderItem:t=>o(t,l.indexOf(t)),locale:{emptyText:"No upcoming follow-ups."}})},"upcoming"),e.jsx(q,{tab:`Past (${B.length})`,children:e.jsx(Q,{dataSource:B,renderItem:t=>o(t,l.indexOf(t)),locale:{emptyText:"No past follow-ups."}})},"past")]})]})},{Text:d}=oe,Me=({quotations:y,onAddNew:L,onEdit:m,onDelete:E,onSearch:C,onViewNotes:w,loading:T,refreshQuotations:I})=>{var k,P,B;const[O,b]=h.useState(!1),[l,Y]=h.useState(null),[N,D]=h.useState(!1),v=o=>{Y(o),b(!0),p.success("Quotation details loaded.",{duration:1500,position:"top-right"})},V=o=>{Y(o),D(!0)},_=async o=>{let t=null;const n=p.loading("Generating PDF...",{position:"top-center"});try{const s=document.getElementById(`quotation-${o._id}`);if(!s){p.error("Quotation content not found for PDF generation. Please try again.",{id:n});return}t=s.cloneNode(!0),t.style.position="fixed",t.style.top="-9999px",t.style.left="-9999px",t.style.width="210mm",t.style.padding="10mm",t.style.background="white",t.style.zIndex="-1",t.style.display="block",document.body.appendChild(t),await new Promise(R=>setTimeout(R,100));const i=(await re(t,{scale:2,useCORS:!0,logging:!1})).toDataURL("image/png"),c=new ae("p","mm","a4"),A=c.internal.pageSize.getWidth(),G=c.internal.pageSize.getHeight(),W=c.getImageProperties(i),U=W.height*A/W.width;let J=0;if(U>G){let R=U;for(;R>0;)c.addImage(i,"PNG",0,J,A,U),R-=G,J-=G,R>0&&c.addPage()}else c.addImage(i,"PNG",0,0,A,U);c.save(`${o.quotationNumber||"quotation"}.pdf`),p.success("PDF downloaded successfully!",{id:n})}catch(s){console.error("Failed to generate PDF:",s),p.error("Failed to generate PDF. Please try again.",{id:n})}finally{t&&document.body.contains(t)&&document.body.removeChild(t)}},x=o=>`₹${(parseFloat(o)||0).toLocaleString("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2})}`,S=()=>[{title:"S.No",width:60,align:"center",render:(o,t,n)=>n+1},{title:"Description",dataIndex:"description",ellipsis:!0,render:(o,t)=>{var n;if(!o&&((n=t.specifications)==null?void 0:n.length)>0){const s=t.specifications.find(a=>a.name==="SPECIFICATION");return s?s.value:"N/A"}return o||"N/A"}},{title:"HSN/SAC",dataIndex:"hsnSac",width:100,align:"center",render:o=>o||"N/A"},{title:"Qty",dataIndex:"quantity",width:80,align:"center",render:o=>parseFloat(o)||0},{title:"Unit Price (₹)",width:140,align:"right",render:(o,t)=>x(t.rate||0)},{title:"Total (₹)",width:140,align:"right",render:(o,t)=>e.jsx(d,{strong:!0,style:{color:"#52c41a"},children:x((t.quantity||0)*(t.rate||0))})}],$=[{title:"Quotation #",dataIndex:"quotationNumber",render:o=>e.jsx(z,{color:"blue",children:o||"N/A"}),sorter:(o,t)=>(o.quotationNumber||"").localeCompare(t.quotationNumber||"")},{title:"Business",dataIndex:"businessName",sorter:(o,t)=>(o.businessName||"").localeCompare(t.businessName||"")},{title:"Customer",dataIndex:"customerName",render:(o,t)=>e.jsxs("div",{children:[e.jsx("div",{children:o||"N/A"}),t.customerEmail&&e.jsx("div",{style:{fontSize:12,color:"#666"},children:t.customerEmail})]}),sorter:(o,t)=>(o.customerName||"").localeCompare(t.customerName||"")},{title:"Items Count",render:(o,t)=>{var n,s;return e.jsxs(z,{color:"geekblue",children:[((n=t.items)==null?void 0:n.length)||0," item",(((s=t.items)==null?void 0:s.length)||0)!==1?"s":""]})}},{title:"Latest Note",dataIndex:"notes",render:o=>{if(o&&o.length>0){const t=o[o.length-1],n=t.text.length>30?`${t.text.substring(0,30)}...`:t.text;return e.jsx(se,{title:t.text,children:e.jsx(d,{type:"secondary",children:n})})}return e.jsx(d,{type:"secondary",italic:!0,children:"No notes"})}},{title:"Total (₹)",dataIndex:"total",render:(o,t)=>{var s;const n=parseFloat(o)||((s=t.items)==null?void 0:s.reduce((a,i)=>a+(i.quantity||0)*(i.rate||0),0))||0;return e.jsx(d,{strong:!0,style:{color:"#52c41a"},children:x(n)})},sorter:(o,t)=>{const n=parseFloat(o.total)||0,s=parseFloat(t.total)||0;return n-s}},{title:"Date",dataIndex:"date",render:o=>{if(!o)return"N/A";try{return new Date(o).toLocaleDateString("en-IN")}catch{return o}},sorter:(o,t)=>{const n=new Date(o.date).getTime()||0,s=new Date(t.date).getTime()||0;return n-s}},{title:"Actions",width:80,render:(o,t)=>e.jsx(le,{overlay:e.jsxs(f,{children:[e.jsx(f.Item,{icon:e.jsx(ie,{}),onClick:()=>v(t),children:"View Details"},"view"),e.jsx(f.Item,{icon:e.jsx(X,{}),onClick:()=>_(t),children:"Download PDF"},"download"),e.jsx(f.Item,{icon:e.jsx(he,{}),onClick:()=>{w(t),p.success("Opening notes dialog...",{duration:1500})},children:"View/Add Notes"},"notes"),e.jsx(f.Item,{icon:e.jsx(xe,{}),onClick:()=>V(t),children:"Add/View Follow-ups"},"followups"),e.jsx(f.Item,{icon:e.jsx(pe,{}),onClick:()=>{m(t),p.success("Initiating quotation edit...",{duration:1500})},children:"Edit Quotation"},"edit"),e.jsx(f.Item,{icon:e.jsx(ge,{}),danger:!0,onClick:()=>{K.confirm({title:"Delete Quotation",content:"Are you sure you want to delete this quotation? This action cannot be undone.",okText:"Yes, Delete",cancelText:"No",okButtonProps:{danger:!0},onOk:()=>{E(t._id),p.success("Deleting quotation...",{duration:1500})}})},children:"Delete Quotation"},"delete")]}),trigger:["click"],children:e.jsx(j,{icon:e.jsx(de,{})})})}];return e.jsxs(e.Fragment,{children:[e.jsxs(ne,{style:{marginBottom:16,justifyContent:"space-between",width:"100%"},children:[e.jsx(ee.Search,{placeholder:"Search by quotation number, business, customer, or notes...",onChange:o=>{C(o.target.value)},style:{width:400},prefix:e.jsx(ue,{}),allowClear:!0}),e.jsx(j,{type:"primary",onClick:()=>{L(),p.success("Prepare to create a new quotation.",{duration:1500})},children:"+ New Quotation"})]}),e.jsx(u,{columns:$,dataSource:y,rowKey:"_id",loading:T,pagination:{pageSize:10,showSizeChanger:!0,showQuickJumper:!0,showTotal:(o,t)=>`${t[0]}-${t[1]} of ${o} quotations`},scroll:{x:1200}}),e.jsx(K,{title:e.jsxs("div",{children:[e.jsx(d,{strong:!0,children:"Quotation Details"}),l&&e.jsx(z,{color:"blue",style:{marginLeft:8},children:l.quotationNumber})]}),open:O,onCancel:()=>b(!1),footer:[e.jsx(j,{icon:e.jsx(X,{}),onClick:()=>_(l),children:"Download PDF"},"download"),e.jsx(j,{onClick:()=>b(!1),children:"Close"},"close")],width:1e3,children:l&&e.jsxs("div",{id:`quotation-modal-preview-${l._id}`,children:[e.jsxs(r,{column:2,bordered:!0,size:"small",children:[e.jsx(r.Item,{label:"Quotation Number",children:e.jsx(z,{color:"blue",children:l.quotationNumber||"N/A"})}),e.jsx(r.Item,{label:"Date",children:l.date?new Date(l.date).toLocaleDateString("en-IN"):"N/A"}),e.jsx(r.Item,{label:"Business Name",children:l.businessName||"N/A"}),e.jsx(r.Item,{label:"Customer Name",children:l.customerName||"N/A"}),e.jsx(r.Item,{label:"Customer Email",children:l.customerEmail||"N/A"}),e.jsx(r.Item,{label:"GSTIN",children:e.jsx(d,{code:!0,children:l.gstin||"N/A"})}),e.jsx(r.Item,{label:"Business Info",span:2,children:e.jsx(d,{style:{whiteSpace:"pre-wrap"},children:l.businessInfo||"N/A"})}),e.jsx(r.Item,{label:"Total Amount",span:2,children:e.jsx(d,{style:{fontSize:"18px",fontWeight:"bold",color:"#52c41a"},children:x(l.total||((k=l.items)==null?void 0:k.reduce((o,t)=>o+(t.quantity||0)*(t.rate||0),0))||0)})})]}),((P=l.items)==null?void 0:P.length)>0&&e.jsxs(e.Fragment,{children:[e.jsxs(H,{orientation:"left",children:["Items (",l.items.length,")"]}),e.jsx(u,{dataSource:l.items,columns:S(),pagination:!1,size:"small",rowKey:(o,t)=>`${l._id}-item-${t}`,bordered:!0,expandable:{expandedRowRender:o=>{var t;return e.jsx("div",{style:{margin:0,padding:0},children:((t=o.specifications)==null?void 0:t.length)>0&&e.jsx(r,{column:1,size:"small",children:o.specifications.filter(n=>n.name!=="SPECIFICATION").map((n,s)=>e.jsx(r.Item,{label:n.name,children:n.value},s))})})},rowExpandable:o=>{var t;return((t=o.specifications)==null?void 0:t.length)>0}},summary:o=>{const t=o.reduce((n,s)=>n+(s.quantity||0)*(s.rate||0),0);return e.jsx(u.Summary,{fixed:!0,children:e.jsxs(u.Summary.Row,{children:[e.jsx(u.Summary.Cell,{index:0,colSpan:5,children:e.jsx(d,{strong:!0,children:"Grand Total:"})}),e.jsx(u.Summary.Cell,{index:5,children:e.jsx(d,{strong:!0,style:{color:"#52c41a"},children:x(t)})})]})})}})]}),((B=l.notes)==null?void 0:B.length)>0&&e.jsxs(e.Fragment,{children:[e.jsxs(H,{orientation:"left",children:["Notes (",l.notes.length,")"]}),l.notes.map((o,t)=>e.jsxs("div",{style:{marginBottom:12,padding:8,background:"#f5f5f5",borderRadius:4},children:[e.jsxs(d,{italic:!0,children:['"',o.text,'"']}),e.jsx("br",{}),e.jsxs(d,{type:"secondary",style:{fontSize:"0.8em"},children:["— ",o.author," on"," ",o.timestamp||new Date(l.createdAt).toLocaleDateString("en-IN")]})]},t))]})]})}),y.map(o=>{var t,n;return e.jsx("div",{id:`quotation-${o._id}`,style:{display:"none"},children:e.jsxs("div",{style:{padding:"20px",fontFamily:"Arial, sans-serif"},children:[e.jsx("h2",{style:{textAlign:"center",marginBottom:"20px"},children:"QUOTATION"}),e.jsxs(r,{column:2,bordered:!0,size:"small",children:[e.jsx(r.Item,{label:"Quotation Number",children:o.quotationNumber||"N/A"}),e.jsx(r.Item,{label:"Date",children:o.date?new Date(o.date).toLocaleDateString("en-IN"):"N/A"}),e.jsx(r.Item,{label:"Business Name",children:o.businessName||"N/A"}),e.jsx(r.Item,{label:"Customer Name",children:o.customerName||"N/A"}),e.jsx(r.Item,{label:"Customer Email",children:o.customerEmail||"N/A"}),e.jsx(r.Item,{label:"GSTIN",children:o.gstin||"N/A"}),e.jsx(r.Item,{label:"Business Info",span:2,children:e.jsx(d,{style:{whiteSpace:"pre-wrap"},children:o.businessInfo||"N/A"})})]}),((t=o.items)==null?void 0:t.length)>0&&e.jsxs(e.Fragment,{children:[e.jsx("h3",{style:{marginTop:"20px",marginBottom:"10px"},children:"Items"}),e.jsx(u,{dataSource:o.items,columns:S(),pagination:!1,size:"small",rowKey:(s,a)=>`${o._id}-pdf-item-${a}`,bordered:!0,expandable:{expandedRowRender:s=>{var a;return e.jsx("div",{style:{margin:0,padding:0},children:((a=s.specifications)==null?void 0:a.length)>0&&e.jsx(r,{column:1,size:"small",children:s.specifications.filter(i=>i.name!=="SPECIFICATION").map((i,c)=>e.jsx(r.Item,{label:i.name,children:i.value},c))})})},rowExpandable:s=>{var a;return((a=s.specifications)==null?void 0:a.length)>0}},summary:s=>{const a=s.reduce((i,c)=>i+(c.quantity||0)*(c.rate||0),0);return e.jsx(u.Summary,{children:e.jsxs(u.Summary.Row,{children:[e.jsx(u.Summary.Cell,{index:0,colSpan:5,children:e.jsx(d,{strong:!0,children:"Grand Total:"})}),e.jsx(u.Summary.Cell,{index:5,children:e.jsx(d,{strong:!0,style:{color:"#52c41a"},children:x(a)})})]})})}})]}),((n=o.notes)==null?void 0:n.length)>0&&e.jsxs(e.Fragment,{children:[e.jsx("h3",{style:{marginTop:"20px",marginBottom:"10px"},children:"Notes"}),o.notes.map((s,a)=>e.jsxs("div",{style:{marginBottom:8},children:[e.jsxs(d,{italic:!0,children:['"',s.text,'"']}),e.jsx("br",{}),e.jsxs(d,{type:"secondary",style:{fontSize:"0.8em"},children:["— ",s.author," on"," ",s.timestamp||new Date(o.createdAt).toLocaleDateString("en-IN")]})]},a))]})]})},o._id)}),l&&e.jsx(je,{visible:N,onClose:()=>D(!1),quotation:l,refreshQuotations:I})]})};export{Me as default};
