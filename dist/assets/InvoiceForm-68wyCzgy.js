import{r as m,s as D,p as e,B as h,q as Q}from"./index-CKWzJZwz.js";import{R as W,E as X}from"./jspdf.es.min-lsgphRXx.js";import"./jspdf.plugin.autotable-TLQB5wf7.js";import{d as T,D as C}from"./index-C6aGBovD.js";import{i as R}from"./axios-0yhrvgHk.js";import{F as r}from"./index-BkOdznK5.js";import{C as K}from"./index-XKyTlcS0.js";import{R as p,C as a}from"./row-vY193qbU.js";import{S as $}from"./index-DHfbdJKK.js";import{I as d}from"./index-D547GtUq.js";import{R as j}from"./index-D13QqeyP.js";import{D as F}from"./index-Be92sfkX.js";import{T as N}from"./index-DZ16B_2c.js";import{R as Z}from"./DeleteOutlined-CaapTf6n.js";import{R as V}from"./SaveOutlined-DnDqHt09.js";import"./TextArea-DEWBu-8c.js";import"./index-xsH4HHeE.js";import"./PlusOutlined-B6wL2tqI.js";const{Option:I}=$,{TextArea:B}=d,Ie=({onCancel:k,onSave:P,initialValues:n})=>{const[v]=r.useForm(),[l,f]=m.useState([{id:1,description:"",hsnSac:"",quantity:1,rate:0}]),[g,q]=m.useState("pending"),[O,G]=m.useState([]),[x,A]=m.useState(null),[w,E]=m.useState([]),H=()=>{try{const s=JSON.parse(localStorage.getItem("user"));return(s==null?void 0:s.email)||"Unknown"}catch{return"Unknown"}};m.useEffect(()=>{const s=D.loading("Loading business options...");R.get("/api/invoices/leads/active").then(t=>{E(t.data),D.success("Business options loaded",{id:s})}).catch(()=>D.error("Failed to load businesses",{id:s}))},[]),m.useEffect(()=>{R.get("/api/invoices/types").then(s=>G(s.data)).catch(()=>D.error("Failed to load invoice types"))},[]),m.useEffect(()=>{var s;n&&(v.setFieldsValue({...n,date:n.date?T(n.date):null,dueDate:n.dueDate?T(n.dueDate):null,paymentStatus:n.paymentStatus||"pending",invoiceType:n.invoiceType||"Invoice",paymentHistory:((s=n.paymentHistory)==null?void 0:s.map(t=>({...t,date:t.date?T(t.date):null})))||[]}),f(n.items||[]),q(n.paymentStatus||"pending"),A(n.dueDate?T(n.dueDate):null))},[n]);const z=s=>{var u,M;const t=y(),c=S(),o=Y(),i={...s,date:(u=s.date)==null?void 0:u.format("YYYY-MM-DD"),dueDate:x==null?void 0:x.format("YYYY-MM-DD"),paymentStatus:g,items:l,subTotal:t,tax:c,totalAmount:o,paymentHistory:((M=s.paymentHistory)==null?void 0:M.filter(J=>J.amount))||[]};P(i)},U=()=>f([...l,{id:Date.now(),description:"",hsnSac:"",quantity:1,rate:0}]),L=s=>l.length>1&&f(l.filter(t=>t.id!==s)),b=(s,t,c)=>f(l.map(o=>o.id===s?{...o,[t]:c}:o)),y=()=>l.reduce((s,t)=>s+t.quantity*t.rate,0),S=()=>y()*.18,Y=()=>y()+S(),_=()=>{var i;const s=v.getFieldsValue(),t=new X;t.setFontSize(20),t.text("TAX INVOICE",14,20),t.setFontSize(12),t.text(`Business: ${s.businessName||""}`,14,35),t.text(`Type: ${s.businessType||""}`,14,42),t.text(`Address: ${s.businessInfo||""}`,14,50),t.text(`GSTIN: ${s.gstin||""}`,14,58),t.text(`Invoice No: ${(n==null?void 0:n.invoiceNumber)||"Generated on save"}`,120,35),t.text(`Date: ${((i=s.date)==null?void 0:i.format("DD/MM/YYYY"))||""}`,120,43),t.text(`Due Date: ${(x==null?void 0:x.format("DD/MM/YYYY"))||""}`,120,51),t.text(`Status: ${g}`,120,59),t.text(`Bill To: ${s.customerName||""}`,14,75),t.text(`Address: ${s.customerAddress||""}`,14,83);const c=l.map(u=>[u.description||"",u.hsnSac||"",u.quantity,`₹${u.rate.toFixed(2)}`,`₹${(u.quantity*u.rate).toFixed(2)}`]);t.autoTable({head:[["Description","HSN/SAC","Qty","Rate (₹)","Amount (₹)"]],body:c,startY:100,theme:"grid"});const o=t.lastAutoTable.finalY+10;t.text(`Sub Total: ₹${y().toFixed(2)}`,120,o),t.text(`GST (18%): ₹${S().toFixed(2)}`,120,o+10),t.setFontSize(14),t.text(`Total: ₹${Y().toFixed(2)}`,120,o+20),t.text(`Payment Status: ${g}`,14,o+30),t.save(`invoice-${(n==null?void 0:n.invoiceNumber)||"draft"}.pdf`)};return e.jsx(K,{title:n?"Edit Invoice":"Create New Invoice",children:e.jsxs(r,{form:v,layout:"vertical",onFinish:z,children:[e.jsxs(p,{gutter:16,children:[e.jsxs(a,{span:12,children:[e.jsx(r.Item,{label:"Business Name",name:"businessName",rules:[{required:!0}],children:e.jsx($,{placeholder:"Select business",onChange:s=>{const t=w.find(c=>c.businessName===s);if(t){const c=[t.addressLine1,t.addressLine2,t.addressLine3,t.city,t.state,t.pincode,t.country].filter(Boolean).join(", ");v.setFieldsValue({businessType:t.type||"",businessInfo:c,gstin:t.gstNumber||"",businessId:t._id})}},children:w.map(s=>e.jsx(I,{value:s.businessName,children:s.businessName},s._id))})}),e.jsx(r.Item,{name:"businessId",hidden:!0,children:e.jsx(d,{})})]}),e.jsx(a,{span:12,children:e.jsx(r.Item,{label:"Business Type",name:"businessType",children:e.jsx(d,{readOnly:!0})})})]}),e.jsxs(p,{gutter:16,children:[(n==null?void 0:n.invoiceNumber)&&e.jsx(a,{span:12,children:e.jsx(r.Item,{label:"Invoice Number",children:e.jsx(d,{value:n.invoiceNumber,readOnly:!0})})}),e.jsx(a,{span:12,children:e.jsx(r.Item,{label:"Business Info",name:"businessInfo",children:e.jsx(B,{rows:2})})})]}),e.jsxs(p,{gutter:16,children:[e.jsx(a,{span:12,children:e.jsx(r.Item,{label:"Date",name:"date",rules:[{required:!0}],children:e.jsx(C,{style:{width:"100%"},format:"DD/MM/YYYY"})})}),e.jsx(a,{span:12,children:e.jsx(r.Item,{label:"Due Date",name:"dueDate",children:e.jsx(C,{style:{width:"100%"},format:"DD/MM/YYYY",value:x,onChange:A})})})]}),e.jsxs(p,{gutter:16,children:[e.jsx(a,{span:12,children:e.jsx(r.Item,{label:"GSTIN",name:"gstin",children:e.jsx(d,{})})}),e.jsx(a,{span:12,children:e.jsx(r.Item,{label:"Customer Name",name:"customerName",rules:[{required:!0}],children:e.jsx(d,{})})})]}),e.jsx(r.Item,{label:"Customer Address",name:"customerAddress",rules:[{required:!0}],children:e.jsx(B,{rows:2})}),e.jsx(r.Item,{label:"Invoice Type",name:"invoiceType",rules:[{required:!0}],children:e.jsx(j.Group,{children:O.map(s=>e.jsx(j.Button,{value:s,children:s},s))})}),e.jsx(r.Item,{label:"Payment Status",name:"paymentStatus",children:e.jsxs(j.Group,{value:g,onChange:s=>q(s.target.value),children:[e.jsx(j.Button,{value:"pending",children:"Pending"}),e.jsx(j.Button,{value:"paid",children:"Paid"}),e.jsx(j.Button,{value:"partial",children:"Partial"})]})}),e.jsx(F,{children:"Invoice Items"}),l.map(s=>e.jsxs(p,{gutter:16,style:{marginBottom:12},children:[e.jsx(a,{span:8,children:e.jsx(d,{value:s.description,onChange:t=>b(s.id,"description",t.target.value),placeholder:"Description"})}),e.jsx(a,{span:4,children:e.jsx(d,{value:s.hsnSac,onChange:t=>b(s.id,"hsnSac",t.target.value),placeholder:"HSN/SAC"})}),e.jsx(a,{span:3,children:e.jsx(N,{value:s.quantity,min:1,onChange:t=>b(s.id,"quantity",t),style:{width:"100%"}})}),e.jsx(a,{span:3,children:e.jsx(N,{value:s.rate,min:0,onChange:t=>b(s.id,"rate",t),style:{width:"100%"}})}),e.jsx(a,{span:4,children:e.jsx(d,{value:`₹ ${(s.quantity*s.rate).toFixed(2)}`,readOnly:!0})}),e.jsx(a,{span:2,children:e.jsx(h,{icon:e.jsx(Z,{}),danger:!0,onClick:()=>L(s.id),disabled:l.length===1})})]},s.id)),e.jsx(h,{type:"dashed",onClick:U,block:!0,style:{marginBottom:24},children:"+ Add Item"}),e.jsx(F,{children:"Payment History"}),e.jsx(r.List,{name:"paymentHistory",children:(s,{add:t,remove:c})=>e.jsxs(e.Fragment,{children:[s.map(({key:o,name:i})=>e.jsxs(p,{gutter:16,style:{marginBottom:12},children:[e.jsx(a,{span:4,children:e.jsx(r.Item,{name:[i,"amount"],rules:[{required:!0}],children:e.jsx(N,{placeholder:"Amount",style:{width:"100%"}})})}),e.jsx(a,{span:4,children:e.jsx(r.Item,{name:[i,"method"],rules:[{required:!0}],children:e.jsxs($,{placeholder:"Method",children:[e.jsx(I,{value:"Cash",children:"Cash"}),e.jsx(I,{value:"UPI",children:"UPI"}),e.jsx(I,{value:"Card",children:"Card"}),e.jsx(I,{value:"Bank Transfer",children:"Bank"})]})})}),e.jsx(a,{span:5,children:e.jsx(r.Item,{name:[i,"reference"],rules:[{required:!0}],children:e.jsx(d,{placeholder:"Reference"})})}),e.jsx(a,{span:5,children:e.jsx(r.Item,{name:[i,"date"],rules:[{required:!0}],children:e.jsx(C,{style:{width:"100%"},format:"DD/MM/YYYY"})})}),e.jsx(a,{span:4,children:e.jsx(r.Item,{name:[i,"addedBy"],initialValue:H(),children:e.jsx(d,{placeholder:"Added By",readOnly:!0})})}),e.jsx(a,{span:2,children:e.jsx(h,{onClick:()=>c(i),danger:!0,children:"Remove"})})]},o)),e.jsx(r.Item,{children:e.jsx(h,{type:"dashed",onClick:()=>t(),block:!0,children:"+ Add Payment"})})]})}),e.jsx(F,{children:"Summary"}),e.jsxs(p,{gutter:16,children:[e.jsx(a,{span:8,children:e.jsx(d,{readOnly:!0,value:`₹ ${y().toFixed(2)}`,addonBefore:"Sub Total"})}),e.jsx(a,{span:8,children:e.jsx(d,{readOnly:!0,value:`₹ ${S().toFixed(2)}`,addonBefore:"GST (18%)"})}),e.jsx(a,{span:8,children:e.jsx(d,{readOnly:!0,value:`₹ ${Y().toFixed(2)}`,addonBefore:"Total",style:{fontWeight:"bold"}})})]}),e.jsx(r.Item,{name:"noteText",label:"Note",children:e.jsx(B,{rows:2,placeholder:"Add a note"})}),e.jsx(r.Item,{style:{marginTop:24},children:e.jsxs(Q,{children:[e.jsx(h,{type:"primary",htmlType:"submit",icon:e.jsx(V,{}),size:"large",children:n?"Update Invoice":"Save Invoice"}),e.jsx(h,{onClick:k,size:"large",children:"Cancel"}),e.jsx(h,{onClick:_,icon:e.jsx(W,{}),size:"large",children:"Generate PDF"})]})})]})})};export{Ie as default};
