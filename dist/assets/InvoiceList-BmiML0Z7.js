import{r,I as Z,D as ee,n as e,S as pe,o as k,B as d,E as je,T as x,V as h}from"./index-Cutw-enT.js";import{R as ge,E as fe}from"./jspdf.es.min-3VB7ac1T.js";import"./jspdf.plugin.autotable-TLQB5wf7.js";import{i as C}from"./axios-0yhrvgHk.js";import{F as U}from"./index-mDIpU0Wn.js";import{D as Se}from"./index-DxNPc3B1.js";import{L as Y}from"./index-DhiKNL4W.js";import{T as te}from"./index-BJ5DgSa8.js";import{I as se,R as we}from"./index-BR-p_aOo.js";import{R as ye,S as p}from"./index-B4mxXDrl.js";import{R as Ie,a as be}from"./TextArea-wS4BJCvv.js";import{R as ne,F as Ne}from"./Table-BcQs_2Pc.js";import{P as L}from"./index-B7twddN4.js";import{R as oe}from"./DeleteOutlined-y75rAjZs.js";import{R as De}from"./SendOutlined-B7SXhTJB.js";import{T as R}from"./index-6KKm8Dw0.js";import{s as D}from"./index-BRDnsLIx.js";import{C as J}from"./index-Bpnj6IYI.js";import{D as Ce}from"./index-Dr2qfWBK.js";import{R as $e}from"./PlusOutlined-BVrrzkCK.js";import{M as Fe}from"./index-DIlPTcPi.js";import{D as j}from"./index-D2q9Y2Gf.js";import{R as ve}from"./MessageOutlined-BGxAE4eK.js";var Te={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M832 464h-68V240c0-70.7-57.3-128-128-128H388c-70.7 0-128 57.3-128 128v224h-68c-17.7 0-32 14.3-32 32v384c0 17.7 14.3 32 32 32h640c17.7 0 32-14.3 32-32V496c0-17.7-14.3-32-32-32zM332 240c0-30.9 25.1-56 56-56h248c30.9 0 56 25.1 56 56v224H332V240zm460 600H232V536h560v304zM484 701v53c0 4.4 3.6 8 8 8h40c4.4 0 8-3.6 8-8v-53a48.01 48.01 0 10-56 0z"}}]},name:"lock",theme:"outlined"},Re=function(S,n){return r.createElement(Z,ee({},S,{ref:n,icon:Te}))},ke=r.forwardRef(Re),Ae={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M832 464H332V240c0-30.9 25.1-56 56-56h248c30.9 0 56 25.1 56 56v68c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-68c0-70.7-57.3-128-128-128H388c-70.7 0-128 57.3-128 128v224h-68c-17.7 0-32 14.3-32 32v384c0 17.7 14.3 32 32 32h640c17.7 0 32-14.3 32-32V496c0-17.7-14.3-32-32-32zm-40 376H232V536h560v304zM484 701v53c0 4.4 3.6 8 8 8h40c4.4 0 8-3.6 8-8v-53a48.01 48.01 0 10-56 0z"}}]},name:"unlock",theme:"outlined"},Oe=function(S,n){return r.createElement(Z,ee({},S,{ref:n,icon:Ae}))},Ve=r.forwardRef(Oe);const{TextArea:W}=se,{Text:_e}=te,Pe=({visible:I,onClose:S,invoice:n,refreshInvoices:A})=>{const[O]=U.useForm(),[l,u]=r.useState([]),[M,f]=r.useState(!1),[b,c]=r.useState(null),[$,w]=r.useState("");r.useEffect(()=>{u((n==null?void 0:n.notes)||[])},[n]);const z=async({note:i})=>{const o={text:i,timestamp:new Date().toISOString(),author:"User"},m=[...l,o];try{f(!0),await C.put(`/api/invoices/${n._id}`,{...n,notes:m}),D.success("Note added"),u(m),O.resetFields(),A()}catch{D.error("Failed to add note")}finally{f(!1)}},B=async i=>{const o=l.filter((m,E)=>E!==i);try{f(!0),await C.put(`/api/invoices/${n._id}`,{...n,notes:o}),D.success("Note deleted"),u(o),A()}catch{D.error("Failed to delete note")}finally{f(!1)}},V=async i=>{const o=[...l];o[i]={...o[i],text:$,timestamp:new Date().toISOString(),updated:!0};try{f(!0),await C.put(`/api/invoices/${n._id}`,{...n,notes:o}),D.success("Note updated"),u(o),c(null),A()}catch{D.error("Update failed")}finally{f(!1)}};return e.jsx(Se,{title:e.jsx(e.Fragment,{children:e.jsxs("div",{children:["Notes for Invoice ",e.jsxs(R,{color:"blue",children:["#",n==null?void 0:n.invoiceNumber]})]})}),open:I,onClose:S,width:450,destroyOnClose:!0,children:e.jsxs(pe,{spinning:M,children:[e.jsx(Y,{dataSource:l,renderItem:(i,o)=>e.jsx(Y.Item,{actions:[b===o?e.jsxs(k,{children:[e.jsx(d,{icon:e.jsx(ye,{}),onClick:()=>V(o)}),e.jsx(d,{icon:e.jsx(Ie,{}),onClick:()=>c(null)})]}):e.jsxs(k,{children:[e.jsx(d,{icon:e.jsx(ne,{}),onClick:()=>{w(i.text),c(o)}}),e.jsx(L,{title:"Delete note?",onConfirm:()=>B(o),children:e.jsx(d,{icon:e.jsx(oe,{}),danger:!0})})]})],children:e.jsx(Y.Item.Meta,{description:e.jsxs(e.Fragment,{children:[e.jsxs(_e,{type:"secondary",children:[i.author," • ",new Date(i.timestamp).toLocaleString()]}),b===o?e.jsx(W,{rows:2,value:$,onChange:m=>w(m.target.value)}):e.jsx("div",{style:{whiteSpace:"pre-wrap"},children:i.text})]})})})}),e.jsxs(U,{form:O,layout:"vertical",onFinish:z,style:{marginTop:16},children:[e.jsx(U.Item,{name:"note",rules:[{required:!0,message:"Enter note"}],children:e.jsx(W,{rows:3,placeholder:"Type your note here..."})}),e.jsx(d,{htmlType:"submit",type:"primary",icon:e.jsx(De,{}),block:!0,children:"Add Note"})]})]})})},{Text:g}=te,{RangePicker:Le}=Ce,Me=({invoices:I,onAddNew:S,onEdit:n,onDelete:A,onSearch:O,refreshInvoices:l})=>{var Q;const[u,M]=r.useState(""),[f,b]=r.useState(!1),[c,$]=r.useState(null),[w,z]=r.useState("all"),[B,V]=r.useState(!1),[i,o]=r.useState(null),[m,E]=r.useState("all"),ae=[...new Set(I.map(t=>t.businessName))],H=t=>{M(t),O(t)},re=t=>{$(t),b(!0)},le=t=>{$(t),V(!0)},ie=async t=>{const s=h.loading("Closing invoice...");try{await C.patch(`/api/invoices/${t}/close`),h.success("Invoice closed successfully",{id:s}),l==null||l()}catch(a){console.error(a),h.error("Failed to close invoice",{id:s})}},ce=async t=>{const s=h.loading("Unlocking invoice...");try{await C.patch(`/api/invoices/${t}/unlock`),h.success("Invoice unlocked successfully",{id:s}),l==null||l()}catch(a){console.error(a),h.error("Failed to unlock invoice",{id:s})}},de=t=>{var P,F,v,T,X;const s=new fe;s.setFontSize(20),s.text("TAX INVOICE",14,20),s.setFontSize(12),s.text(`Business: ${t.businessName||""}`,14,35),s.text(`Address: ${t.businessInfo||""}`,14,45),s.text(`GSTIN: ${t.gstin||""}`,14,55),s.text(`Invoice No: ${t.invoiceNumber||""}`,120,35),s.text(`Date: ${t.date||""}`,120,45),s.text(`Due Date: ${t.dueDate||"N/A"}`,120,55),s.text(`Status: ${t.paymentStatus}`,120,65),s.text(`Bill To: ${t.customerName||""}`,14,80),s.text(`Address: ${t.customerAddress||""}`,14,90);const a=((P=t.items)==null?void 0:P.map(N=>[N.description||"",N.hsnSac||"",N.quantity||0,`₹${(N.rate||0).toFixed(2)}`,`₹${((N.quantity||0)*(N.rate||0)).toFixed(2)}`]))||[];s.autoTable({head:[["Description","HSN/SAC","Qty","Rate (₹)","Amount (₹)"]],body:a,startY:100,theme:"grid"});const y=s.lastAutoTable.finalY+10;s.text(`Sub Total: ₹${((F=t.subTotal)==null?void 0:F.toFixed(2))||"0.00"}`,120,y),s.text(`GST (18%): ₹${((v=t.tax)==null?void 0:v.toFixed(2))||"0.00"}`,120,y+10),s.setFontSize(14),s.text(`Total: ₹${((T=t.total)==null?void 0:T.toFixed(2))||((X=t.totalAmount)==null?void 0:X.toFixed(2))||"0.00"}`,120,y+20),s.save(`invoice-${t.invoiceNumber||"draft"}.pdf`)},_=I.filter(t=>{var F,v,T;const s=!u||((F=t.invoiceNumber)==null?void 0:F.toLowerCase().includes(u.toLowerCase()))||((v=t.businessName)==null?void 0:v.toLowerCase().includes(u.toLowerCase()))||((T=t.customerName)==null?void 0:T.toLowerCase().includes(u.toLowerCase())),a=!i||new Date(t.date)>=i[0].toDate()&&new Date(t.date)<=i[1].toDate(),y=w==="all"?!0:w==="overdue"?t.paymentStatus!=="paid"&&new Date(t.dueDate)<new Date:t.paymentStatus===w,P=m==="all"?!0:t.businessName===m;return s&&a&&y&&P}),ue=_.length,q=_.reduce((t,s)=>t+(s.totalAmount||0),0),G=_.filter(t=>t.paymentStatus==="paid").reduce((t,s)=>t+(s.totalAmount||0),0),me=q-G,K=t=>{const s={paid:{color:"success",text:"Paid"},partial:{color:"warning",text:"Partial"},pending:{color:"error",text:"Pending"}}[t]||{};return e.jsx(R,{color:s.color,children:s.text})},xe=(t,s)=>!t||s==="paid"?"none":new Date(t)<new Date?"overdue":"pending",he=[{title:"S.No",render:(t,s,a)=>e.jsx(g,{strong:!0,children:a+1}),width:70},{title:"Invoice Number",render:(t,s)=>e.jsx(R,{color:"blue",icon:e.jsx(je,{}),children:s.invoiceNumber})},{title:"Business Name",dataIndex:"businessName",render:t=>e.jsx(x,{title:t,children:e.jsx(g,{strong:!0,children:t})})},{title:"Customer Name",dataIndex:"customerName",render:t=>e.jsx(x,{title:t,children:e.jsx(g,{children:t})})},{title:"Amount",dataIndex:"totalAmount",align:"right",render:t=>e.jsxs(g,{strong:!0,style:{color:"#52c41a"},children:["₹",(t||0).toFixed(2)]})},{title:"Due Date",dataIndex:"dueDate",align:"center",render:(t,s)=>{const a=xe(t,s.paymentStatus),y=a==="overdue"?"red":a==="pending"?"#faad14":"inherit";return e.jsx(g,{style:{color:y},children:t||"N/A"})}},{title:"Status",dataIndex:"paymentStatus",render:K},{title:"Actions",render:(t,s)=>e.jsxs(k,{children:[e.jsx(x,{title:"View",children:e.jsx(d,{icon:e.jsx(we,{}),onClick:()=>re(s)})}),e.jsx(x,{title:"PDF",children:e.jsx(d,{icon:e.jsx(ge,{}),onClick:()=>de(s)})}),e.jsx(x,{title:"Notes",children:e.jsx(d,{icon:e.jsx(ve,{}),onClick:()=>le(s)})}),!s.isClosed&&e.jsx(x,{title:"Edit",children:e.jsx(d,{icon:e.jsx(ne,{}),onClick:()=>n(s)})}),s.isClosed?e.jsx(L,{title:"Unlock this invoice?",onConfirm:()=>ce(s._id),children:e.jsx(x,{title:"Unlock",children:e.jsx(d,{icon:e.jsx(Ve,{})})})}):e.jsx(L,{title:"Close this invoice?",onConfirm:()=>ie(s._id),children:e.jsx(x,{title:"Lock",children:e.jsx(d,{icon:e.jsx(ke,{})})})}),e.jsx(L,{title:"Delete invoice?",onConfirm:()=>{const a=h.loading("Deleting invoice...");C.delete(`/api/invoices/${s._id}`).then(()=>{h.success("Invoice deleted",{id:a}),l==null||l()}).catch(()=>{h.error("Delete failed",{id:a})})},children:e.jsx(x,{title:"Delete",children:e.jsx(d,{icon:e.jsx(oe,{}),danger:!0})})})]})}];return e.jsxs(e.Fragment,{children:[e.jsxs(J,{title:"Invoice Management",extra:e.jsxs(k,{wrap:!0,children:[e.jsx(Le,{onChange:t=>o(t),format:"YYYY-MM-DD"}),e.jsxs(p,{value:w,onChange:z,style:{width:140},children:[e.jsx(p.Option,{value:"all",children:"All Status"}),e.jsx(p.Option,{value:"paid",children:"Paid"}),e.jsx(p.Option,{value:"pending",children:"Pending"}),e.jsx(p.Option,{value:"partial",children:"Partial"}),e.jsx(p.Option,{value:"overdue",children:"Overdue"})]}),e.jsxs(p,{value:m,onChange:E,placeholder:"Filter by Business",style:{width:200},allowClear:!0,children:[e.jsx(p.Option,{value:"all",children:"All Businesses"}),ae.map(t=>e.jsx(p.Option,{value:t,children:t},t))]}),e.jsx(se.Search,{placeholder:"Search invoices",onSearch:H,onChange:t=>H(t.target.value),style:{width:240},allowClear:!0,prefix:e.jsx(be,{})}),e.jsx(d,{type:"primary",icon:e.jsx($e,{}),onClick:S,children:"New Invoice"})]}),children:[e.jsx(J,{type:"inner",title:"Summary",style:{marginBottom:16},children:e.jsxs(k,{direction:"horizontal",size:"large",children:[e.jsx(g,{strong:!0,children:"Total Invoices:"})," ",ue,e.jsx(g,{strong:!0,children:"Total Amount:"})," ₹",q.toFixed(2),e.jsx(g,{strong:!0,children:"Paid:"})," ₹",G.toFixed(2),e.jsx(g,{strong:!0,children:"Pending:"})," ₹",me.toFixed(2)]})}),e.jsx(Ne,{dataSource:_,columns:he,rowKey:"_id",pagination:{pageSize:10},bordered:!0})]}),e.jsx(Fe,{title:"Invoice Details",open:f,onCancel:()=>b(!1),footer:e.jsx(d,{onClick:()=>b(!1),children:"Close"}),width:800,children:c&&e.jsxs(j,{bordered:!0,column:2,children:[e.jsx(j.Item,{label:"Invoice No",children:c.invoiceNumber}),e.jsx(j.Item,{label:"Date",children:c.date}),e.jsx(j.Item,{label:"Business",children:c.businessName}),e.jsx(j.Item,{label:"Customer",children:c.customerName}),e.jsx(j.Item,{label:"GSTIN",span:2,children:c.gstin}),e.jsxs(j.Item,{label:"Amount",span:2,children:["₹",(Q=c.totalAmount)==null?void 0:Q.toFixed(2)]}),e.jsx(j.Item,{label:"Status",span:2,children:K(c.paymentStatus)}),e.jsx(j.Item,{label:"Closed",span:2,children:c.isClosed?e.jsx(R,{color:"red",children:"Yes"}):e.jsx(R,{color:"green",children:"No"})})]})}),e.jsx(Pe,{visible:B,onClose:()=>V(!1),invoice:c,refreshInvoices:l})]})},ct=Object.freeze(Object.defineProperty({__proto__:null,default:Me},Symbol.toStringTag,{value:"Module"}));export{Me as I,Pe as N,ct as a};
