import{r as s,x as t,S as B,B as O,V as a}from"./index-Dhm34sgv.js";import{i as y}from"./axios-YBtE4rUB.js";import R from"./QuotationForm-CDe1YOrv.js";import J from"./QuotationList-CZym9Xve.js";import{F as I}from"./index-CsdUItHh.js";import{D as E}from"./index-DYQ3KbXq.js";import{I as _}from"./index-DU47aUfY.js";import{R as H}from"./SendOutlined-Xvnx2f4N.js";import{T as W}from"./index-DkB689rm.js";import"./dayjs.min-BjANFWqH.js";import"./index-CQqa482v.js";import"./index-DZ6VrGuv.js";import"./TextArea-aiJnFeae.js";import"./index-x9NBQsoh.js";import"./PlusOutlined-Cg0eeMwI.js";import"./index-D2I0ptaS.js";import"./index-BhDIhWJr.js";import"./index-CPNF_bye.js";import"./index-DKlhRhsb.js";import"./DeleteOutlined-BV_en6Iq.js";import"./MinusCircleOutlined-BRPPnLBU.js";import"./SaveOutlined-CIzdqORP.js";import"./moment-C5S46NFB.js";import"./index-CReYVYDC.js";import"./useClosable-uJTLd_hL.js";import"./Pagination-BGVvFZpc.js";import"./MessageOutlined-C5BShQ5W.js";import"./html2canvas.esm-VorwOHoA.js";import"./Table-IhBhSztc.js";import"./styleChecker-5MFDiKsj.js";import"./addEventListener-Da8-Sd5v.js";import"./index-C6Vo095j.js";import"./index-zymrVtTo.js";import"./InfoCircleFilled-dxoV8F3y.js";import"./ActionButton-CY-WY53X.js";import"./index-Dn_Z7XVT.js";import"./context-BOjBZPbX.js";import"./index-DRHPO5ks.js";import"./index-DS6hlzzk.js";import"./PrinterOutlined-DuDyr3wR.js";import"./ScheduleOutlined-Brabufp5.js";import"./EditOutlined-DOZ2tZXT.js";import"./index-ZSMw7GZp.js";const{TextArea:Y}=_,{Title:G,Text:K}=W,M=({visible:D,onClose:b,quotation:n,refreshQuotations:c})=>{const[u]=I.useForm(),[i,S]=s.useState(!1),[m,v]=s.useState([]);s.useEffect(()=>{v((n==null?void 0:n.notes)||[])},[n]);const j=()=>{try{const r=JSON.parse(localStorage.getItem("user"));return(r==null?void 0:r.email)||"Unknown"}catch{return"Unknown"}},Q=async r=>{try{S(!0);const l=a.loading("Adding note..."),d={text:r.note,timestamp:new Date().toLocaleString(),author:j()},p=[...m,d];await y.put(`/api/quotations/${n._id}`,{notes:p}),v(p),a.success("Note added",{id:l}),u.resetFields(),typeof c=="function"&&c()}catch(l){console.error("Failed to add note:",l),a.error("Failed to add note")}finally{S(!1)}},N=()=>m.length?m.map((r,l)=>{const d=l>0?m[l-1]:null,p=new Date(r.timestamp).toDateString(),w=d?new Date(d.timestamp).toDateString():null,F=p!==w;return t.jsxs("div",{children:[F&&t.jsx("div",{className:"note-date-header",children:p}),t.jsxs("div",{className:"note-bubble",children:[t.jsxs("div",{className:"note-meta",children:[r.author,"    ",r.timestamp]}),t.jsx("div",{className:"note-text",children:r.text})]})]},l)}):t.jsx(K,{type:"secondary",children:"No notes added yet"});return t.jsx(E,{title:t.jsxs(G,{level:4,style:{margin:0},children:["Notes for Quotation #",n==null?void 0:n.quotationNumber]}),open:D,onClose:b,width:440,destroyOnClose:!0,children:t.jsxs(B,{spinning:i,children:[t.jsx("div",{style:{maxHeight:"calc(100vh - 200px)",overflowY:"auto",marginBottom:16},children:N()}),t.jsxs(I,{form:u,layout:"vertical",onFinish:Q,children:[t.jsx(I.Item,{name:"note",rules:[{required:!0,message:"Please enter a note"}],children:t.jsx(Y,{rows:3,placeholder:"Type your note here"})}),t.jsx(O,{type:"primary",style:{backgroundColor:"#ef7a1b",borderColor:"#orange",color:"white"},htmlType:"submit",loading:i,block:!0,icon:t.jsx(H,{}),children:"Add Note"})]})]})})},Bt=()=>{const[D,b]=s.useState([]),[n,c]=s.useState(!1),[u,i]=s.useState(null),[S,m]=s.useState([]),[v,j]=s.useState(!1),[Q,N]=s.useState(!1),[r,l]=s.useState(!1),[d,p]=s.useState(1),[w,F]=s.useState(10),[T,V]=s.useState(0),C=async()=>{N(!0);const o=a.loading("Loading quotations...");try{const e=await y.get(`/api/quotations?page=${d}&limit=${w}`);b(e.data.quotations),m(e.data.quotations),V(e.data.totalItems),a.success("Quotations loaded successfully",{id:o})}catch(e){a.error("Failed to load quotations",{id:o}),console.error("Error fetching quotations:",e)}finally{N(!1)}};s.useEffect(()=>{C()},[d,w]);const P=(o,e)=>{p(o),F(e)},k=async o=>{var h,f,x;if(r){a("Quotation save in progress. Please wait...",{icon:"⏳"});return}l(!0);const e=a.loading("Saving quotation...");try{u?await y.put(`/api/quotations/${u._id}`,o):await y.post("/api/quotations",o),a.success("Quotation saved successfully!",{id:e}),await C(),c(!1),i(null)}catch(g){console.error("Error saving quotation:",((h=g.response)==null?void 0:h.data)||g),a.error(`Failed to save quotation: ${((x=(f=g.response)==null?void 0:f.data)==null?void 0:x.error)||g.message||"Unknown error"}`,{id:e})}finally{l(!1)}},A=async o=>{const e=a.loading("Deleting quotation...");try{await y.delete(`/api/quotations/${o}`),a.success("Quotation deleted successfully",{id:e}),C()}catch(h){a.error(`Failed to delete quotation: ${h.message}`,{id:e}),console.error("Error deleting quotation:",h)}},U=o=>{const e=o.toLowerCase(),h=D.filter(f=>{var x,g,L,$;return((x=f.businessName)==null?void 0:x.toLowerCase().includes(e))||((g=f.customerName)==null?void 0:g.toLowerCase().includes(e))||((L=f.quotationNumber)==null?void 0:L.toLowerCase().includes(e))||(($=f.notes)==null?void 0:$.some(z=>{var q;return(q=z.text)==null?void 0:q.toLowerCase().includes(e)}))});m(h)};return t.jsxs(t.Fragment,{children:[t.jsx("h2",{children:"Quotation "}),t.jsx(J,{quotations:S,onAddNew:()=>{i(null),c(!0)},onEdit:o=>{i(o),c(!0)},onDelete:A,onSearch:U,onViewNotes:o=>{i(o),j(!0)},loading:Q,pagination:{current:d,pageSize:w,total:T,onChange:P,showSizeChanger:!0,showQuickJumper:!0,showTotal:(o,e)=>`${e[0]}-${e[1]} of ${o} quotations`}}),t.jsx(E,{open:n,title:u?"Edit Quotation":"Create Quotation",onClose:()=>{c(!1),i(null)},width:window.innerWidth>768?"80vw":"95vw",destroyOnClose:!0,children:t.jsx(R,{initialValues:u,onSave:k,onCancel:()=>{c(!1),i(null)},isSaving:r})}),t.jsx(M,{visible:v,onClose:()=>{j(!1),i(null)},quotation:u,refreshQuotations:C})]})};export{Bt as default};
