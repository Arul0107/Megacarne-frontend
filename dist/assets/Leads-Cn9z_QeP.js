import{r as n,an as i,x as t,H as Ce,B as b,S as Se,ao as we,ap as g}from"./index-CDHHEH9R.js";import{i as y}from"./axios-CSlAuMiO.js";import{h as ve,E as je,R as Ae}from"./html2canvas.esm-D4gOIGy2.js";import{u as R,a as Te}from"./xlsx-CyWl6TWy.js";import{R as ke,a as Ne,B as Ie,N as Fe,F as $e,b as ze}from"./FollowUpDrawer-C0fo0bzK.js";import{C as Pe}from"./index-DCFdla3I.js";import{I as q}from"./index-moz96MFa.js";import{c as Q}from"./TextArea-DuGAdjqD.js";import{R as De}from"./PlusOutlined-ByfnQIH-.js";import{T as H}from"./index-ZgWJIb_H.js";import{F as Le}from"./Table-b-pe5h1z.js";import{E as Re}from"./index-_DW4MO8t.js";import{M as Ee}from"./index-CVA8aRI9.js";import{T as Ue}from"./index-Govk3_r-.js";import{T as _e}from"./index-BxYB1PTR.js";import{R as Be}from"./EditOutlined-xqHe53iW.js";import{R as Ve}from"./MessageOutlined-2SzkZOCK.js";import{P as Me}from"./index-BQzleOIU.js";import{R as Oe}from"./DeleteOutlined-S1VgwgK-.js";import"./index-BGDXiIZJ.js";import"./index-Dg-FNmH8.js";import"./context-cWxd9jnK.js";import"./useClosable-GYGSyFE0.js";import"./index-DYhdLMFp.js";import"./index-gOyG0OeV.js";import"./moment-C5S46NFB.js";import"./index-4mnRxljj.js";import"./dayjs.min-F-oh7tHl.js";import"./index-DWClh8PC.js";import"./Pagination-Dihjq4x4.js";import"./styleChecker-BPp1vV_G.js";import"./addEventListener-uZJL53jX.js";import"./index-CmB5d6LT.js";import"./InfoCircleFilled-CVv9ml8T.js";import"./ActionButton-FXhSaRtp.js";import"./index-Dl72V75l.js";const{Title:Ge}=Ue,{TabPane:C}=H,v="/api/accounts",kt=()=>{const[Y,j]=n.useState(!1),[I,E]=n.useState(null),[u,K]=n.useState(""),[d,J]=n.useState("all"),[X,F]=n.useState(!1),[U,$]=n.useState(null),[z,P]=n.useState(null),[A,Z]=n.useState([]),[ee,_]=n.useState(!1),[te,B]=n.useState(!1),[D,V]=n.useState(null),[r,T]=n.useState({current:1,pageSize:10,total:0}),[h,se]=n.useState({all:0,active:0,customers:0,Pipeline:0,closed:0,quotations:0}),[ae,oe]=n.useState([]),[re,M]=n.useState(!1),[ne,O]=n.useState(!0),x=JSON.parse(localStorage.getItem("user")),k=x==null?void 0:x.role,L=x==null?void 0:x._id,G=n.useRef(null),p=async(e={})=>{O(!0);try{const{current:s=r.current,pageSize:a=r.pageSize,searchText:o="",activeTab:c="all",sortBy:f="createdAt",sortOrder:l="desc"}=e,m=c==="all"?"":c;let S=`${v}/paginated?page=${s}&pageSize=${a}&search=${o}`;m&&(S+=`&status=${m}`),f&&(S+=`&sortBy=${f}`),l&&(S+=`&sortOrder=${l}`),k==="Employee"&&L&&(S+=`&userId=${L}&role=${k}`);const w=await y.get(S);Z(w.data.data),T({...r,current:w.data.page,pageSize:w.data.pageSize,total:w.data.total}),se(ye=>({...ye,[c]:w.data.total}))}catch(s){i.error("Failed to fetch accounts."),console.error("Fetch accounts error:",s)}finally{O(!1)}};n.useEffect(()=>{p({current:r.current,pageSize:r.pageSize,searchText:u,activeTab:d}),ie()},[r.current,r.pageSize,u,d,k,L]);const ie=async()=>{M(!0);try{const e=await y.get("/api/users");oe(e.data)}catch(e){console.error("Error fetching users:",e),i.error("Failed to load users for assignment.")}finally{M(!1)}},ce=async e=>{var s;try{const a={...e};I?(await y.put(`${v}/${I._id}`,a),i.success("Account updated successfully!")):(await y.post(v,a),i.success("Account created successfully!")),j(!1),p({current:r.current,pageSize:r.pageSize,searchText:u,activeTab:d})}catch(a){throw a.response&&a.response.status===409||(i.error("Failed to save account."),console.error("Save account error:",((s=a.response)==null?void 0:s.data)||a.message)),a}},le=e=>{E(e),j(!0)},ue=async e=>{var s;try{await y.put(`${v}/${e}`,{status:"Closed"}),i.success("Account status set to Closed!"),p({current:r.current,pageSize:r.pageSize,searchText:u,activeTab:d})}catch(a){i.error("Failed to set account status to Closed."),console.error("Delete account error:",((s=a.response)==null?void 0:s.data)||a.message)}},de=e=>{V(e),_(!0)},pe=e=>{V(e),B(!0)},W=(e,s)=>{$(s),P(e),F(!0)},me=async()=>{var e;try{const s={...U,status:z};await y.put(`${v}/${U._id}`,s),i.success(`Account status changed to ${z}!`),p({current:r.current,pageSize:r.pageSize,searchText:u,activeTab:d})}catch(s){i.error("Failed to update account status."),console.error("Status update error:",((e=s.response)==null?void 0:e.data)||s.message)}finally{F(!1),$(null),P(null)}},ge=()=>{F(!1),$(null),P(null)},he=async()=>{const e=G.current;if(!e){i.error("Table content not found for PDF export.");return}i.loading("Generating PDF...",{id:"pdf-toast"});try{const s=await ve(e,{scale:2}),a=s.toDataURL("image/png"),o=new je("p","mm","a4"),c=210,f=297,l=s.height*c/s.width;let m=l,N=0;for(o.addImage(a,"PNG",0,N,c,l),m-=f;m>=0;)N=m-l,o.addPage(),o.addImage(a,"PNG",0,N,c,l),m-=f;o.save("Leads_Customers_Details.pdf"),i.success("PDF generated!",{id:"pdf-toast"})}catch(s){console.error("Error generating PDF:",s),i.error("Failed to generate PDF.",{id:"pdf-toast"})}},xe=()=>{if(A.length===0){i.error("No data to export to Excel.");return}const e=A.map((o,c)=>{var l;return{"S.No":c+1+(r.current-1)*r.pageSize,"Business Name":o.businessName,"Contact Name":o.contactName,Email:o.email,"Mobile Number":o.mobileNumber,"Lead Type":o.type,Status:o.status,"Source Type":o.sourceType,"Assigned To":((l=o.assignedTo)==null?void 0:l.name)||"Unassigned","GST Number":o.gstNumber,"Phone Number":o.phoneNumber,"Address Line 1":o.addressLine1,"Address Line 2":o.addressLine2,"Address Line 3":o.addressLine3,Landmark:o.landmark,City:o.city,Pincode:o.pincode,State:o.state,Country:o.country,Website:o.website,"Is Customer":o.isCustomer?"Yes":"No","Created At":new Date(o.createdAt).toLocaleString()}}),s=R.json_to_sheet(e),a=R.book_new();R.book_append_sheet(a,s,"Leads & Customers"),Te(a,"Leads_Customers_Data.xlsx"),i.success("Data exported to Excel!")},fe=[{title:"S.No",key:"sno",render:(e,s,a)=>a+1+(r.current-1)*r.pageSize,width:60},{title:"Business Name",dataIndex:"businessName",key:"businessName",filterDropdown:({setSelectedKeys:e,selectedKeys:s,confirm:a,clearFilters:o})=>t.jsxs("div",{style:{padding:8},children:[t.jsx(q,{placeholder:"Search Business Name",value:s[0],onChange:c=>e(c.target.value?[c.target.value]:[]),onPressEnter:()=>a(),style:{marginBottom:8,display:"block"}}),t.jsx(b,{type:"primary",onClick:()=>a(),icon:t.jsx(Q,{}),size:"small",style:{width:90,marginRight:8,backgroundColor:"#ef7a1b",borderColor:"#orange",color:"white"},children:"Search"}),t.jsx(b,{onClick:()=>o(),size:"small",style:{width:90},children:"Reset"})]}),onFilter:(e,s)=>s.businessName.toLowerCase().includes(e.toLowerCase()),responsive:["xs","sm","md","lg"]},{title:"Contact Name",dataIndex:"contactName",key:"contactName",responsive:["md","lg"]},{title:"Email",dataIndex:"email",key:"email",responsive:["lg"]},{title:"Product",dataIndex:"selectedProduct",key:"selectedProduct",render:e=>e?e.productName:"N/A",responsive:["md","lg"]},{title:"Mobile Number",dataIndex:"mobileNumber",key:"mobileNumber",responsive:["md","lg"]},{title:"Status",dataIndex:"status",key:"status",render:e=>{let s;switch(e){case"Active":s="green";break;case"Pipeline":s="orange";break;case"Closed":s="purple";break;case"Customer":s="blue";break;case"Quotations":s="cyan";break;default:s="gray"}return t.jsx(_e,{color:s,children:e})},filters:[{text:"Active",value:"Active"},{text:"Pipeline",value:"Pipeline"},{text:"Closed",value:"Closed"},{text:"Customer",value:"Customer"},{text:"Quotations",value:"Quotations"}],onFilter:(e,s)=>s.status.indexOf(e)===0,filterMultiple:!0,responsive:["sm","md","lg"]},{title:"Assigned To",dataIndex:"assignedTo",key:"assignedTo",render:e=>e?e.name:"Unassigned",responsive:["md","lg"]},{title:"Source Type",dataIndex:"sourceType",key:"sourceType",filters:[{text:"Direct",value:"Direct"},{text:"Facebook",value:"Facebook"},{text:"Google Ads",value:"Google Ads"},{text:"Website",value:"Website"},{text:"Cold Call",value:"Cold Call"},{text:"Client",value:"Client"},{text:"Tradefair",value:"Tradefair"},{text:"Other",value:"Other"}],onFilter:(e,s)=>{var a;return((a=s.sourceType)==null?void 0:a.indexOf(e))===0},responsive:["lg"]},{title:"Action",key:"action",width:80,render:(e,s)=>t.jsx(we,{overlay:t.jsxs(g,{children:[t.jsx(g.Item,{icon:t.jsx(Be,{}),onClick:()=>le(s),children:"Edit Account"},"edit"),t.jsx(g.Item,{icon:t.jsx(Ve,{}),onClick:()=>de(s),children:"View/Add Notes"},"notes"),t.jsx(g.Item,{icon:t.jsx(ze,{}),onClick:()=>pe(s),children:"View/Add Follow-ups"},"followup"),s.status==="Customer"?t.jsx(g.Item,{onClick:()=>W("Active",s),children:"Change to Lead"},"change-to-lead"):t.jsx(g.Item,{onClick:()=>W("Customer",s),children:"Change to Customer"},"change-to-customer"),k==="Superadmin"&&t.jsx(g.Item,{children:t.jsxs(Me,{title:"Are you sure you want to close this account? This will set its status to 'Closed'.",onConfirm:()=>ue(s._id),okText:"Yes",cancelText:"No",children:[t.jsx(Oe,{}),"Close Account"]})},"close-account")]}),trigger:["click"],children:t.jsx(b,{icon:t.jsx(Ae,{})})})}],be=(e,s,a)=>{T(e);const o=a.field,c=a.order==="ascend"?"asc":a.order==="descend"?"desc":void 0;p({current:e.current,pageSize:e.pageSize,searchText:u,activeTab:d,sortBy:o,sortOrder:c})};return t.jsxs(Pe,{title:t.jsx(Ge,{level:4,children:"Manage Leads & Customers"}),children:[t.jsxs("div",{style:{marginBottom:16,display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:"10px"},children:[t.jsx(q,{placeholder:"Search by business or contact name",prefix:t.jsx(Q,{}),style:{width:"100%",maxWidth:300},value:u,onChange:e=>{K(e.target.value),T({...r,current:1})}}),t.jsxs(Ce,{children:[t.jsx(b,{type:"primary",icon:t.jsx(De,{}),style:{backgroundColor:"#ef7a1b",borderColor:"#orange",color:"white"},onClick:()=>{E(null),j(!0)},children:"Add New Account"}),t.jsx(b,{icon:t.jsx(ke,{}),onClick:he}),t.jsx(b,{icon:t.jsx(Ne,{}),onClick:xe})]})]}),t.jsxs(H,{defaultActiveKey:"all",onChange:e=>{J(e),T({...r,current:1})},children:[t.jsx(C,{tab:`All Leads (${h.all})`},"all"),t.jsx(C,{tab:`Lead (${h.active})`},"active"),t.jsx(C,{tab:`Enquiry (${h.Pipeline})`},"Pipeline"),t.jsx(C,{tab:`Quotations (${h.quotations})`},"quotations"),t.jsx(C,{tab:`Converted (${h.customers})`},"customers"),t.jsx(C,{tab:`Closed (${h.closed})`},"closed")]}),t.jsx("div",{ref:G,children:ne?t.jsx(Se,{size:"large",style:{display:"block",margin:"50px auto"}}):A.length>0?t.jsx(Le,{columns:fe,dataSource:A,rowKey:"_id",scroll:{x:"max-content"},pagination:r,onChange:be}):t.jsx(Re,{description:"No accounts found."})}),t.jsx(Ie,{visible:Y,onClose:()=>j(!1),onSave:ce,initialValues:I,allUsers:ae,loadingUsers:re}),D&&t.jsxs(t.Fragment,{children:[t.jsx(Fe,{visible:ee,onClose:()=>_(!1),account:D,refreshAccounts:()=>p({current:r.current,pageSize:r.pageSize,searchText:u,activeTab:d})}),t.jsx($e,{visible:te,onClose:()=>B(!1),account:D,refreshAccounts:()=>p({current:r.current,pageSize:r.pageSize,searchText:u,activeTab:d})})]}),t.jsx(Ee,{title:"Change Account Status",open:X,onOk:me,onCancel:ge,okText:"Yes",cancelText:"No",children:t.jsxs("p",{children:["Are you sure you want to change this account's status to"," ","**",z,"**?"]})})]})};export{kt as default};
