import{r as a,I as W,D as Z,n as e,S as he,o as R,B as l,E as pe,T as h}from"./index-DOl5o0Fi.js";import{R as je,E as fe}from"./jspdf.es.min-BGRMkKsu.js";import"./jspdf.plugin.autotable-TLQB5wf7.js";import{a as K}from"./index-xsH4HHeE.js";import{F as z}from"./index-BGklyIoz.js";import{D as ge}from"./index-C1jWW2JK.js";import{L as E}from"./index-CSGtnS7J.js";import{T as ee}from"./index-urhnUZZj.js";import{I as te,R as Se}from"./index-BuLJMp6D.js";import{R as ye,S as p}from"./index-DdA_pnqc.js";import{R as we,a as Ne}from"./TextArea-C4DPS5YY.js";import{R as se,F as be}from"./Table-C5Y_brLg.js";import{P as V}from"./index-CKdYz8QF.js";import{R as ne}from"./DeleteOutlined-CLFo74kb.js";import{R as Ie}from"./SendOutlined-YVBdKRQR.js";import{T as v}from"./index-SpzIKIyO.js";import{s as d}from"./index-D0cqfMpl.js";import{C as Q}from"./index-BzoFmVq5.js";import{D as Ce}from"./index-C4VLxRWm.js";import{R as De}from"./PlusOutlined-FiOkOQB_.js";import{M as Fe}from"./index-JO2pgooI.js";import{D as j}from"./index-BTWPr2ot.js";import{R as Te}from"./MessageOutlined-DbPnkpAp.js";import"./row-Py5ar9wK.js";import"./context-CmZbqAFB.js";import"./useClosable-B_lu9RL-.js";import"./index-CcH3ZLi-.js";import"./InfoCircleFilled-BfnhUeHt.js";var $e={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M832 464h-68V240c0-70.7-57.3-128-128-128H388c-70.7 0-128 57.3-128 128v224h-68c-17.7 0-32 14.3-32 32v384c0 17.7 14.3 32 32 32h640c17.7 0 32-14.3 32-32V496c0-17.7-14.3-32-32-32zM332 240c0-30.9 25.1-56 56-56h248c30.9 0 56 25.1 56 56v224H332V240zm460 600H232V536h560v304zM484 701v53c0 4.4 3.6 8 8 8h40c4.4 0 8-3.6 8-8v-53a48.01 48.01 0 10-56 0z"}}]},name:"lock",theme:"outlined"},ve=function(S,n){return a.createElement(W,Z({},S,{ref:n,icon:$e}))},Re=a.forwardRef(ve),ke={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M832 464H332V240c0-30.9 25.1-56 56-56h248c30.9 0 56 25.1 56 56v68c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-68c0-70.7-57.3-128-128-128H388c-70.7 0-128 57.3-128 128v224h-68c-17.7 0-32 14.3-32 32v384c0 17.7 14.3 32 32 32h640c17.7 0 32-14.3 32-32V496c0-17.7-14.3-32-32-32zm-40 376H232V536h560v304zM484 701v53c0 4.4 3.6 8 8 8h40c4.4 0 8-3.6 8-8v-53a48.01 48.01 0 10-56 0z"}}]},name:"unlock",theme:"outlined"},Ae=function(S,n){return a.createElement(W,Z({},S,{ref:n,icon:ke}))},Oe=a.forwardRef(Ae);const{TextArea:X}=te,{Text:Pe}=ee,Ve=({visible:N,onClose:S,invoice:n,refreshInvoices:C})=>{const[k]=z.useForm(),[c,u]=a.useState([]),[L,g]=a.useState(!1),[b,i]=a.useState(null),[D,y]=a.useState("");a.useEffect(()=>{u((n==null?void 0:n.notes)||[])},[n]);const B=async({note:r})=>{const o={text:r,timestamp:new Date().toISOString(),author:"User"},m=[...c,o];try{g(!0),await fetch(`/api/invoices/${n._id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({...n,notes:m})}),d.success("Note added"),u(m),k.resetFields(),C()}catch{d.error("Failed to add note")}finally{g(!1)}},M=async r=>{const o=c.filter((m,_)=>_!==r);try{g(!0),await fetch(`/api/invoices/${n._id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({...n,notes:o})}),d.success("Note deleted"),u(o),C()}catch{d.error("Failed to delete note")}finally{g(!1)}},A=async r=>{const o=[...c];o[r]={...o[r],text:D,timestamp:new Date().toISOString(),updated:!0};try{g(!0),await fetch(`/api/invoices/${n._id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({...n,notes:o})}),d.success("Note updated"),u(o),i(null),C()}catch{d.error("Update failed")}finally{g(!1)}};return e.jsx(ge,{title:e.jsx(e.Fragment,{children:e.jsxs("div",{children:["Notes for Invoice ",e.jsxs(v,{color:"blue",children:["#",n==null?void 0:n.invoiceNumber]})]})}),open:N,onClose:S,width:450,destroyOnClose:!0,children:e.jsxs(he,{spinning:L,children:[e.jsx(E,{dataSource:c,renderItem:(r,o)=>e.jsx(E.Item,{actions:[b===o?e.jsxs(R,{children:[e.jsx(l,{icon:e.jsx(ye,{}),onClick:()=>A(o)}),e.jsx(l,{icon:e.jsx(we,{}),onClick:()=>i(null)})]}):e.jsxs(R,{children:[e.jsx(l,{icon:e.jsx(se,{}),onClick:()=>{y(r.text),i(o)}}),e.jsx(V,{title:"Delete note?",onConfirm:()=>M(o),children:e.jsx(l,{icon:e.jsx(ne,{}),danger:!0})})]})],children:e.jsx(E.Item.Meta,{description:e.jsxs(e.Fragment,{children:[e.jsxs(Pe,{type:"secondary",children:[r.author," • ",new Date(r.timestamp).toLocaleString()]}),b===o?e.jsx(X,{rows:2,value:D,onChange:m=>y(m.target.value)}):e.jsx("div",{style:{whiteSpace:"pre-wrap"},children:r.text})]})})})}),e.jsxs(z,{form:k,layout:"vertical",onFinish:B,style:{marginTop:16},children:[e.jsx(z.Item,{name:"note",rules:[{required:!0,message:"Enter note"}],children:e.jsx(X,{rows:3,placeholder:"Type your note here..."})}),e.jsx(l,{htmlType:"submit",type:"primary",icon:e.jsx(Ie,{}),block:!0,children:"Add Note"})]})]})})},{Text:f}=ee,{RangePicker:Le}=Ce,mt=({invoices:N,onAddNew:S,onEdit:n,onDelete:C,onSearch:k,refreshInvoices:c})=>{var G;const[u,L]=a.useState(""),[g,b]=a.useState(!1),[i,D]=a.useState(null),[y,B]=a.useState("all"),[M,A]=a.useState(!1),[r,o]=a.useState(null),[m,_]=a.useState("all"),oe=[...new Set(N.map(t=>t.businessName))],U=t=>{L(t),k(t)},ae=t=>{D(t),b(!0)},re=t=>{D(t),A(!0)},ie=async t=>{try{await K.patch(`/api/invoices/${t}/close`),d.success("Invoice closed successfully"),c==null||c()}catch(s){console.error(s),d.error("Failed to close invoice")}},le=async t=>{try{await K.patch(`/api/invoices/${t}/unlock`),d.success("Invoice unlocked successfully"),c==null||c()}catch(s){console.error(s),d.error("Failed to unlock invoice")}},ce=t=>{var P,F,T,$,J;const s=new fe;s.setFontSize(20),s.text("TAX INVOICE",14,20),s.setFontSize(12),s.text(`Business: ${t.businessName||""}`,14,35),s.text(`Address: ${t.businessInfo||""}`,14,45),s.text(`GSTIN: ${t.gstin||""}`,14,55),s.text(`Invoice No: ${t.invoiceNumber||""}`,120,35),s.text(`Date: ${t.date||""}`,120,45),s.text(`Due Date: ${t.dueDate||"N/A"}`,120,55),s.text(`Status: ${t.paymentStatus}`,120,65),s.text(`Bill To: ${t.customerName||""}`,14,80),s.text(`Address: ${t.customerAddress||""}`,14,90);const x=((P=t.items)==null?void 0:P.map(I=>[I.description||"",I.hsnSac||"",I.quantity||0,`₹${(I.rate||0).toFixed(2)}`,`₹${((I.quantity||0)*(I.rate||0)).toFixed(2)}`]))||[];s.autoTable({head:[["Description","HSN/SAC","Qty","Rate (₹)","Amount (₹)"]],body:x,startY:100,theme:"grid"});const w=s.lastAutoTable.finalY+10;s.text(`Sub Total: ₹${((F=t.subTotal)==null?void 0:F.toFixed(2))||"0.00"}`,120,w),s.text(`GST (18%): ₹${((T=t.tax)==null?void 0:T.toFixed(2))||"0.00"}`,120,w+10),s.setFontSize(14),s.text(`Total: ₹${(($=t.total)==null?void 0:$.toFixed(2))||((J=t.totalAmount)==null?void 0:J.toFixed(2))||"0.00"}`,120,w+20),s.save(`invoice-${t.invoiceNumber||"draft"}.pdf`)},Y=t=>{const s={paid:{color:"success",text:"Paid"},partial:{color:"warning",text:"Partial"},pending:{color:"error",text:"Pending"}}[t]||{};return e.jsx(v,{color:s.color,children:s.text})},de=(t,s)=>!t||s==="paid"?"none":new Date(t)<new Date?"overdue":"pending",O=(N||[]).filter(t=>{var F,T,$;const s=!u||((F=t.invoiceNumber)==null?void 0:F.toLowerCase().includes(u.toLowerCase()))||((T=t.businessName)==null?void 0:T.toLowerCase().includes(u.toLowerCase()))||(($=t.customerName)==null?void 0:$.toLowerCase().includes(u.toLowerCase())),x=!r||new Date(t.date)>=r[0].toDate()&&new Date(t.date)<=r[1].toDate(),w=y==="all"?!0:y==="overdue"?t.paymentStatus!=="paid"&&new Date(t.dueDate)<new Date:t.paymentStatus===y,P=m==="all"?!0:t.businessName===m;return s&&x&&w&&P}),ue=O.length,H=O.reduce((t,s)=>t+(s.totalAmount||0),0),q=O.filter(t=>t.paymentStatus==="paid").reduce((t,s)=>t+(s.totalAmount||0),0),me=H-q,xe=[{title:"S.No",render:(t,s,x)=>e.jsx(f,{strong:!0,children:x+1}),width:70},{title:"Invoice Number",render:(t,s)=>e.jsx(v,{color:"blue",icon:e.jsx(pe,{}),children:s.invoiceNumber})},{title:"Business Name",dataIndex:"businessName",render:t=>e.jsx(h,{title:t,children:e.jsx(f,{strong:!0,children:t})})},{title:"Customer Name",dataIndex:"customerName",render:t=>e.jsx(h,{title:t,children:e.jsx(f,{children:t})})},{title:"Amount",dataIndex:"totalAmount",align:"right",render:t=>e.jsxs(f,{strong:!0,style:{color:"#52c41a"},children:["₹",(t||0).toFixed(2)]})},{title:"Due Date",dataIndex:"dueDate",align:"center",render:(t,s)=>{const x=de(t,s.paymentStatus),w=x==="overdue"?"red":x==="pending"?"#faad14":"inherit";return e.jsx(f,{style:{color:w},children:t||"N/A"})}},{title:"Status",dataIndex:"paymentStatus",render:Y},{title:"Actions",render:(t,s)=>e.jsxs(R,{children:[e.jsx(h,{title:"View",children:e.jsx(l,{icon:e.jsx(Se,{}),onClick:()=>ae(s)})}),e.jsx(h,{title:"PDF",children:e.jsx(l,{icon:e.jsx(je,{}),onClick:()=>ce(s)})}),e.jsx(h,{title:"Notes",children:e.jsx(l,{icon:e.jsx(Te,{}),onClick:()=>re(s)})}),!s.isClosed&&e.jsx(h,{title:"Edit",children:e.jsx(l,{icon:e.jsx(se,{}),onClick:()=>n(s)})}),s.isClosed?e.jsx(V,{title:"Unlock this invoice?",onConfirm:()=>le(s._id),children:e.jsx(h,{title:"Unlock",children:e.jsx(l,{icon:e.jsx(Oe,{})})})}):e.jsx(V,{title:"Close this invoice?",onConfirm:()=>ie(s._id),children:e.jsx(h,{title:"Lock",children:e.jsx(l,{icon:e.jsx(Re,{})})})}),e.jsx(V,{title:"Delete invoice?",onConfirm:()=>C(s._id),children:e.jsx(h,{title:"Delete",children:e.jsx(l,{icon:e.jsx(ne,{}),danger:!0})})})]})}];return e.jsxs(e.Fragment,{children:[e.jsxs(Q,{title:"Invoice Management",extra:e.jsxs(R,{wrap:!0,children:[e.jsx(Le,{onChange:t=>o(t),format:"YYYY-MM-DD"}),e.jsxs(p,{value:y,onChange:B,style:{width:140},children:[e.jsx(p.Option,{value:"all",children:"All Status"}),e.jsx(p.Option,{value:"paid",children:"Paid"}),e.jsx(p.Option,{value:"pending",children:"Pending"}),e.jsx(p.Option,{value:"partial",children:"Partial"}),e.jsx(p.Option,{value:"overdue",children:"Overdue"})]}),e.jsxs(p,{value:m,onChange:_,placeholder:"Filter by Business",style:{width:200},allowClear:!0,children:[e.jsx(p.Option,{value:"all",children:"All Businesses"}),oe.map(t=>e.jsx(p.Option,{value:t,children:t},t))]}),e.jsx(te.Search,{placeholder:"Search invoices",onSearch:U,onChange:t=>U(t.target.value),style:{width:240},allowClear:!0,prefix:e.jsx(Ne,{})}),e.jsx(l,{type:"primary",icon:e.jsx(De,{}),onClick:S,children:"New Invoice"})]}),children:[e.jsx(Q,{type:"inner",title:"Summary",style:{marginBottom:16},children:e.jsxs(R,{direction:"horizontal",size:"large",children:[e.jsx(f,{strong:!0,children:"Total Invoices:"})," ",ue,e.jsx(f,{strong:!0,children:"Total Amount:"})," ₹",H.toFixed(2),e.jsx(f,{strong:!0,children:"Paid:"})," ₹",q.toFixed(2),e.jsx(f,{strong:!0,children:"Pending:"})," ₹",me.toFixed(2)]})}),e.jsx(be,{dataSource:O,columns:xe,rowKey:"_id",pagination:{pageSize:10},bordered:!0})]}),e.jsx(Fe,{title:"Invoice Details",open:g,onCancel:()=>b(!1),footer:e.jsx(l,{onClick:()=>b(!1),children:"Close"}),width:800,children:i&&e.jsxs(j,{bordered:!0,column:2,children:[e.jsx(j.Item,{label:"Invoice No",children:i.invoiceNumber}),e.jsx(j.Item,{label:"Date",children:i.date}),e.jsx(j.Item,{label:"Business",children:i.businessName}),e.jsx(j.Item,{label:"Customer",children:i.customerName}),e.jsx(j.Item,{label:"GSTIN",span:2,children:i.gstin}),e.jsxs(j.Item,{label:"Amount",span:2,children:["₹",(G=i.totalAmount)==null?void 0:G.toFixed(2)]}),e.jsx(j.Item,{label:"Status",span:2,children:Y(i.paymentStatus)}),e.jsx(j.Item,{label:"Closed",span:2,children:i.isClosed?e.jsx(v,{color:"red",children:"Yes"}):e.jsx(v,{color:"green",children:"No"})})]})}),e.jsx(Ve,{visible:M,onClose:()=>A(!1),invoice:i,refreshInvoices:c})]})};export{mt as default};
