import{r as p,V as f,p as e,T as L,B as j,q as W}from"./index-DJFv2fZl.js";import{i as _}from"./axios-CRSFEUrT.js";import{d as X,D as K}from"./index-DG61iyI2.js";import{F as l}from"./index-C218FKaA.js";import{t as ie,R as le}from"./index-BZ8fO5mU.js";import{C as B}from"./index-CIsoreGc.js";import{D as T}from"./index-Bt3lE0VZ.js";import{R as y,C as d}from"./index-aF4oOUgn.js";import{I as u}from"./index-nhsLOXfP.js";import{S as D}from"./index-F-KgjenD.js";import{T as de}from"./index-8kNy10tH.js";import{R as ne}from"./DeleteOutlined-DBMmcI3x.js";import{R as ce}from"./MinusCircleOutlined-C-WQ9ATi.js";import{R as ue}from"./index-Dp0cR596.js";import"./TextArea-DSWaGSmh.js";const me=r=>({quotationCard:{borderRadius:r.borderRadiusXL,boxShadow:r.boxShadowSecondary,border:`1px solid ${r.colorBorderBg}`,backgroundColor:r.colorBgContainer,padding:r.paddingLG},mainCardTitle:{color:r.colorPrimary,fontSize:r.fontSizeHeading2,fontWeight:r.fontWeightStronger,marginBottom:r.marginLG,textAlign:"center",textTransform:"uppercase",letterSpacing:"1px"},businessInfoCard:{background:`linear-gradient(135deg, ${r.colorFillQuaternary} 0%, ${r.colorFillAlter} 100%)`,border:`1px solid ${r.colorBorderSecondary}`,borderRadius:r.borderRadiusLG,padding:r.paddingMD,minHeight:"80px",boxShadow:r.boxShadowTertiary,marginBottom:r.marginLG,display:"flex",alignItems:"center",transition:"all 0.3s ease-in-out","&:hover":{boxShadow:r.boxShadow,transform:"translateY(-2px)"}},businessInfoPre:{margin:0,whiteSpace:"pre-wrap",flexGrow:1,fontFamily:"monospace",fontSize:r.fontSizeSM,color:r.colorTextSecondary,lineHeight:r.lineHeightSM,opacity:.8},formField:{width:"100%",borderRadius:r.borderRadiusSM,borderColor:r.colorBorder,transition:"all 0.2s ease","&:hover":{borderColor:r.colorPrimaryBorder},"&:focus":{boxShadow:`0 0 0 2px ${r.colorPrimaryBorderHover}`}},readOnlyFormField:{width:"100%",color:r.colorTextDisabled,borderRadius:r.borderRadiusSM,background:r.colorFillQuaternary,cursor:"not-allowed"},textAreaField:{width:"100%",marginBottom:r.marginS,borderRadius:r.borderRadiusSM,borderColor:r.colorBorder},readOnlyTextArea:{width:"100%",marginBottom:r.marginS,borderRadius:r.borderRadiusSM,color:r.colorTextDisabled,background:r.colorFillQuaternary,cursor:"not-allowed"},divider:{borderColor:r.colorBorderSecondary,borderStyle:"dashed",margin:`${r.marginXL}px 0`,color:r.colorTextTertiary,fontWeight:r.fontWeightStrong},specificationDivider:{borderColor:r.colorBorderSecondary,borderStyle:"dotted",margin:`${r.margin}px 0 ${r.marginS}px 0`,color:r.colorTextQuaternary},itemCard:{marginBottom:r.marginMD,border:`1px solid ${r.colorBorderSecondary}`,borderRadius:r.borderRadiusLG,backgroundColor:r.colorFillContentBackground,transition:"all 0.2s ease-in-out","&:hover":{boxShadow:r.boxShadowXl,transform:"translateY(-3px)"}},deleteButton:{height:"auto",display:"flex",alignItems:"center",justifyContent:"center",color:r.colorError,"&:hover":{color:r.colorErrorHover,background:r.colorErrorBg}},addButton:{height:"auto",display:"flex",alignItems:"center",justifyContent:"center",color:r.colorPrimary,borderColor:r.colorPrimaryBorder,"&:hover":{color:r.colorPrimaryHover,borderColor:r.colorPrimaryBorderHover,background:r.colorPrimaryBg}},addSpecButton:{marginTop:r.margin,borderRadius:r.borderRadiusSM,borderColor:r.colorBorderDashed,color:r.colorTextSecondary,"&:hover":{color:r.colorPrimaryText,borderColor:r.colorPrimary}},addItemButton:{marginTop:r.marginLG,borderRadius:r.borderRadiusSM,borderColor:r.colorPrimaryBorderDashed,color:r.colorPrimary,"&:hover":{background:r.colorPrimaryBgHover}},specificationRow:{marginBottom:r.marginXXS},summaryRow:{fontWeight:r.fontWeightStrong,borderTop:`1px dashed ${r.colorBorderSecondary}`,paddingTop:r.paddingMD,marginTop:r.marginLG},totalField:{width:"100%",borderRadius:r.borderRadiusSM,textAlign:"right",backgroundColor:r.colorFillTertiary,borderColor:r.colorBorder,color:r.colorText},grandTotalField:{width:"100%",borderRadius:r.borderRadiusSM,color:r.colorSuccess,fontSize:r.fontSizeHeading4,fontWeight:r.fontWeightStronger,textAlign:"right",backgroundColor:r.colorSuccessBg,borderColor:r.colorSuccessBorder},notesCard:{background:r.colorFillQuaternary,marginBottom:r.margin,borderRadius:r.borderRadiusLG,border:`1px solid ${r.colorBorderQuaternary}`},noteText:{margin:0,paddingBottom:r.paddingXXS,color:r.colorTextSecondary,fontSize:r.fontSizeSM,lineHeight:1.5},buttonGroup:{marginTop:r.marginLG,paddingTop:r.paddingMD,borderTop:`1px solid ${r.colorBorderSecondary}`,display:"flex",justifyContent:"flex-end",gap:r.marginSM}}),{Option:R}=D,{TextArea:J}=u,{useToken:pe}=ie,Re=({onCancel:r,onSave:Z,initialValues:m,isSaving:P})=>{const[b]=l.useForm(),[I,V]=p.useState([]),[A,k]=p.useState([]),[g,S]=p.useState([{id:1,productId:null,description:"",hsnSac:"",quantity:1,quantityType:"",rate:0,specifications:[{key:Date.now(),name:"",value:""}]}]),[F,ee]=p.useState([]),[N,Y]=p.useState(null),[h,$]=p.useState(null),{token:M}=pe(),o=me(M),q=p.useRef(!1),O=p.useRef(!1),v=p.useCallback(t=>{var s,a;return t?`
${(s=t.businessName)==null?void 0:s.toUpperCase()}
${t.contactName?`Mr. ${(a=t.contactName)==null?void 0:a.toUpperCase()}`:""}
${t.addressLine1||""}${t.addressLine2?", "+t.addressLine2:""}
${t.city||""}${t.pincode?" - "+t.pincode:""}
${t.state||""}, ${t.country||""}
${t.gstNumber||""}
${t.email||""} 
`.trim():""},[]),E=p.useCallback(async()=>{if(q.current)return;q.current=!0;const t=f.loading("Loading business options...");try{const s=await _.get("/api/quotations/leads/active");V(s.data),f.success("Business options loaded",{id:t})}catch(s){f.error("Failed to load businesses",{id:t}),console.error("Error fetching business options:",s),q.current=!1}},[]),Q=p.useCallback(async()=>{if(O.current)return;O.current=!0;const t=f.loading("Loading product options...");try{const s=await _.get("/api/product");k(s.data.map(a=>({...a,hsnSac:a.hsnSac||"",quantityType:a.quantityType||"",options:a.options||[]}))),f.success("Product options loaded",{id:t})}catch(s){f.error("Failed to load products",{id:t}),console.error("Error fetching product options:",s),O.current=!1}},[]);p.useEffect(()=>{if(E(),Q(),m&&(b.setFieldsValue({...m,date:m.date?X(m.date):null,validUntil:m.validUntil?X(m.validUntil):null,noteText:""}),S(m.items||[]),ee(m.notes||[]),Y(m.gstType||null),m.businessId&&I.length>0)){const t=I.find(s=>s._id===m.businessId);t&&($(t),b.setFieldsValue({businessName:t.businessName,businessType:t.type,gstin:t.gstNumber,businessInfo:v(t)}))}},[m,E,Q,b,v,I]);const re=async t=>{var c,n;if(!g||g.length===0){f.error("At least one item is required.");return}if(!N){f.error("Please select a GST type.");return}const s=new Date().toLocaleString(),a=t.noteText?{text:t.noteText,timestamp:s}:null,i={...t,date:(c=t.date)==null?void 0:c.format("YYYY-MM-DD"),validUntil:(n=t.validUntil)==null?void 0:n.format("YYYY-MM-DD"),items:g,notes:a?[...F,a]:F,subTotal:w(),tax:G(),total:U(),createdDate:new Date().toLocaleDateString(),gstType:N,businessName:h==null?void 0:h.businessName,businessType:h==null?void 0:h.type,gstin:h==null?void 0:h.gstNumber,businessInfo:h?v(h):"",customerName:t.customerName,customerEmail:t.customerEmail};try{await Z(i)}catch(x){console.error("Error in QuotationForm onFinish:",x)}finally{}},te=()=>S([...g,{id:Date.now(),productId:null,description:"",hsnSac:"",quantity:1,rate:0,quantityType:"",specifications:[{key:Date.now(),name:"",value:""}]}]),oe=t=>S(g.filter(s=>s.id!==t)),C=(t,s,a)=>{S(i=>i.map(c=>{if(c.id===t){if(s==="productId"){const n=A.find(x=>x._id===a);if(n)return{...c,productId:a,description:n.description||"",hsnSac:n.hsnSac||"",rate:n.price||0,quantityType:n.quantityType||"",specifications:n.options&&n.options.length>0?n.options.map(x=>({key:Date.now()+Math.random(),name:x.type||"",value:x.description||""})):[{key:Date.now()+Math.random(),name:"",value:""}]}}return{...c,[s]:a}}return c}))},H=t=>{S(s=>s.map(a=>a.id===t?{...a,specifications:[...a.specifications,{key:Date.now()+Math.random(),name:"",value:""}]}:a))},se=(t,s)=>{S(a=>a.map(i=>i.id===t?{...i,specifications:i.specifications.filter(c=>c.key!==s)}:i))},z=(t,s,a,i)=>{S(c=>c.map(n=>n.id===t?{...n,specifications:n.specifications.map(x=>x.key===s?{...x,[a]:i}:x)}:n))},w=()=>g.reduce((t,s)=>t+(s.quantity||0)*(s.rate||0),0),G=()=>w()*.18,U=()=>w()+G(),ae=t=>{const s=I.find(a=>a._id===t);if(s){$(s);const a=v(s);b.setFieldsValue({businessId:s._id,businessName:s.businessName,businessType:s.type,gstin:s.gstNumber,businessInfo:a})}else $(null),b.setFieldsValue({businessId:null,businessName:null,businessType:null,gstin:null,businessInfo:""})};return e.jsx(B,{title:e.jsx("span",{style:o.mainCardTitle,children:m?"Edit Quotation":"Create New Quotation"}),loading:P,style:o.quotationCard,children:e.jsxs(l,{form:b,layout:"vertical",onFinish:re,children:[e.jsx(T,{style:o.divider,children:"Customer Details"}),e.jsxs(y,{gutter:[16,24],children:[e.jsx(d,{xs:24,md:12,children:e.jsx(l.Item,{label:"Customer Name",name:"customerName",rules:[{required:!0,message:"Please enter customer name!"},{min:2,message:"Customer name must be at least 2 characters!"}],children:e.jsx(u,{placeholder:"Enter customer full name",style:o.formField})})}),e.jsx(d,{xs:24,md:12,children:e.jsx(l.Item,{label:"Customer Email",name:"customerEmail",rules:[{required:!0,message:"Please enter customer email!"},{type:"email",message:"Please enter a valid email address!"}],children:e.jsx(u,{placeholder:"Enter customer email address",style:o.formField,type:"email"})})})]}),e.jsx(T,{style:o.divider,children:"Business Details"}),e.jsxs(y,{gutter:[16,24],children:[e.jsxs(d,{xs:24,md:12,children:[e.jsx(l.Item,{label:"Business Name",name:"businessId",rules:[{required:!0,message:"Please select a business!"}],children:e.jsx(D,{placeholder:"Select business",showSearch:!0,optionFilterProp:"children",filterOption:(t,s)=>((s==null?void 0:s.children)||"").toLowerCase().includes(t.toLowerCase()),onChange:ae,allowClear:!0,style:o.formField,children:I.map(t=>e.jsx(R,{value:t._id,children:t.businessName},t._id))})}),e.jsx(l.Item,{name:"businessName",hidden:!0,children:e.jsx(u,{})})]}),e.jsx(d,{xs:24,md:12,children:e.jsx(l.Item,{name:"businessType",label:"Type",children:e.jsx(u,{readOnly:!0,style:o.readOnlyFormField})})})]}),e.jsxs(y,{gutter:[16],children:[e.jsx(d,{xs:24,md:12,children:e.jsx(l.Item,{name:"gstType",label:"GST Type",rules:[{required:!0,message:"Please select a GST type!"}],children:e.jsxs(D,{placeholder:"Select GST calculation type",onChange:t=>Y(t),value:N,style:o.formField,children:[e.jsx(R,{value:"interstate",children:"Interstate - IGST (Integrated GST)"}),e.jsx(R,{value:"intrastate",children:"Intrastate - SGST/CGST (State/Central GST)"})]})})}),e.jsx(d,{xs:24,md:12,children:e.jsx(l.Item,{label:"Business Info",children:e.jsx(B,{bordered:!0,style:o.businessInfoCard,children:e.jsx("pre",{style:o.businessInfoPre,children:b.getFieldValue("businessInfo")||"Select a business to view details..."})})})})]}),e.jsx(T,{style:o.divider,children:"Quotation Details"}),e.jsxs(y,{gutter:[16,24],children:[e.jsx(d,{xs:24,md:12,children:e.jsx(l.Item,{name:"date",label:"Date",rules:[{required:!0,message:"Please select a date!"}],children:e.jsx(K,{style:o.formField,format:"DD/MM/YYYY"})})}),e.jsx(d,{xs:24,md:12,children:e.jsx(l.Item,{name:"validUntil",label:"Valid Until",children:e.jsx(K,{style:o.formField,format:"DD/MM/YYYY"})})})]}),e.jsx(T,{style:o.divider,children:"Quotation Items"}),g.map((t,s)=>{const a=t.productId!==null;return e.jsxs(B,{style:o.itemCard,size:"small",children:[e.jsxs(y,{gutter:[16,16],align:"middle",children:[e.jsx(d,{xs:24,sm:8,children:e.jsx(l.Item,{label:"Product",noStyle:!0,children:e.jsx(D,{placeholder:"Search or select a product",showSearch:!0,optionFilterProp:"children",filterOption:(i,c)=>((c==null?void 0:c.children)||"").toLowerCase().includes(i.toLowerCase()),onChange:i=>C(t.id,"productId",i),value:t.productId,style:o.formField,children:A.map(i=>e.jsx(R,{value:i._id,children:i.productName||i.name},i._id))})})}),e.jsx(d,{xs:12,sm:4,children:e.jsx(l.Item,{label:"Qty",noStyle:!0,children:e.jsx(de,{placeholder:"1",value:t.quantity,onChange:i=>C(t.id,"quantity",i),style:o.formField,min:0})})}),e.jsx(d,{xs:12,sm:6,children:e.jsx(l.Item,{label:"Unit Type",noStyle:!0,children:e.jsx(u,{placeholder:"e.g., Pcs, Kg, Mtr",value:t.quantityType,onChange:i=>C(t.id,"quantityType",i.target.value),style:a?o.readOnlyFormField:o.formField,readOnly:a,disabled:a})})}),e.jsx(d,{xs:24,sm:6,style:{display:"flex",justifyContent:"flex-end",alignItems:"center"},children:g.length>1&&e.jsx(L,{title:"Remove Item",children:e.jsx(j,{icon:e.jsx(ne,{}),danger:!0,onClick:()=>oe(t.id),type:"text",style:o.deleteButton})})})]}),e.jsxs(y,{gutter:[16,16],style:{marginTop:M.marginS},children:[e.jsx(d,{xs:24,sm:8,children:e.jsx(l.Item,{label:"Price (per unit)",noStyle:!0,children:e.jsx(u,{prefix:"₹",value:t.rate.toFixed(2),readOnly:!0,style:o.readOnlyFormField})})}),e.jsx(d,{xs:24,sm:16,children:e.jsx(l.Item,{label:"Description",noStyle:!0,children:e.jsx(J,{placeholder:"Detailed description of the item",value:t.description,onChange:i=>C(t.id,"description",i.target.value),style:a?o.readOnlyTextArea:o.textAreaField,rows:2})})})]}),e.jsxs(y,{gutter:[16,16],style:{marginTop:M.marginS},children:[e.jsx(d,{xs:24,sm:8,children:e.jsx(l.Item,{label:"HSN/SAC Code",noStyle:!0,children:e.jsx(u,{placeholder:"HSN/SAC",value:t.hsnSac,onChange:i=>C(t.id,"hsnSac",i.target.value),style:a?o.readOnlyFormField:o.formField,readOnly:a,disabled:a})})}),e.jsx(d,{xs:24,sm:8,children:e.jsx(l.Item,{label:"Item Total",noStyle:!0,children:e.jsx(u,{value:`₹${((t.quantity||0)*(t.rate||0)).toFixed(2)}`,readOnly:!0,style:o.totalItemField})})})]}),t.specifications&&t.specifications.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(T,{orientation:"left",style:o.specificationDivider,children:"Specifications"}),t.specifications.map((i,c)=>e.jsxs(y,{gutter:16,style:o.specificationRow,align:"middle",children:[e.jsx(d,{xs:24,sm:10,children:e.jsx(u,{placeholder:"Specification Name (e.g., Color)",value:i.name,onChange:n=>z(t.id,i.key,"name",n.target.value),style:o.formField})}),e.jsx(d,{xs:24,sm:10,children:e.jsx(u,{placeholder:"Specification Value (e.g., Blue)",value:i.value,onChange:n=>z(t.id,i.key,"value",n.target.value),style:o.formField})}),e.jsx(d,{xs:24,sm:4,children:e.jsxs(W,{children:[t.specifications.length>1&&e.jsx(L,{title:"Remove Specification",children:e.jsx(j,{icon:e.jsx(ce,{}),onClick:()=>se(t.id,i.key),type:"text",danger:!0,style:o.deleteButton})}),c===t.specifications.length-1&&e.jsx(L,{title:"Add New Specification",children:e.jsx(j,{icon:e.jsx(ue,{}),onClick:()=>H(t.id),type:"dashed",style:o.addButton})})]})})]},i.key))]}),(!t.specifications||t.specifications.length===0||t.specifications.length>0&&t.specifications[t.specifications.length-1].name&&t.specifications[t.specifications.length-1].value)&&e.jsx(j,{onClick:()=>H(t.id),block:!0,type:"dashed",style:o.addSpecButton,children:"+ Add Specification"})]},t.id)}),e.jsx(j,{onClick:te,block:!0,type:"dashed",style:o.addItemButton,children:"+ Add Another Item"}),e.jsx(T,{style:o.divider,children:"Quotation Summary"}),e.jsxs(y,{gutter:[16,16],style:o.summaryRow,children:[e.jsx(d,{xs:24,sm:8,children:e.jsx(l.Item,{label:"Sub Total",children:e.jsx(u,{readOnly:!0,value:`₹${w().toFixed(2)}`,style:o.totalField})})}),e.jsx(d,{xs:24,sm:8,children:e.jsx(l.Item,{label:"GST (18%)",children:e.jsx(u,{readOnly:!0,value:`₹${G().toFixed(2)}`,style:o.totalField})})}),e.jsx(d,{xs:24,sm:8,children:e.jsx(l.Item,{label:"Total Amount",children:e.jsx(u,{readOnly:!0,value:`₹${U().toFixed(2)}`,style:o.grandTotalField})})})]}),F.length>0&&e.jsx(l.Item,{label:"Existing Notes",children:e.jsx(B,{style:o.notesCard,children:F.map((t,s)=>e.jsxs("p",{style:o.noteText,children:[e.jsxs("strong",{children:[t.timestamp,":"]})," ",t.text]},s))})}),e.jsx(l.Item,{name:"noteText",label:"Add New Note",children:e.jsx(J,{rows:3,style:o.textAreaField,placeholder:"Add any additional notes, terms, or conditions for this quotation..."})}),e.jsx(l.Item,{style:o.buttonGroup,children:e.jsxs(W,{size:"middle",children:[e.jsx(j,{onClick:r,disabled:P,size:"large",children:"Cancel"}),e.jsx(j,{htmlType:"submit",type:"primary",icon:e.jsx(le,{}),loading:P,size:"large",children:"Save Quotation"})]})})]})})};export{Re as default};
