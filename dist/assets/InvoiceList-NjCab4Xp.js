import{r as m,I as _e,t as Ue,o as ie,p as e,S as lt,B as O,q as de,V as R,s as Q,x as Ee,T as Re,D as it,M as L}from"./index-Bei6p0LZ.js";import{R as ct,E as dt}from"./jspdf.es.min-BKN8IyFz.js";import{a as ut}from"./jspdf.plugin.autotable-CtA5BUKo.js";import{u as pe,w as mt}from"./xlsx-x9ZxUr7s.js";import{I as ee,i as X,R as pt}from"./axios-YMP7eKdN.js";import{F as E}from"./index-CSlP1qA3.js";import{D as ge}from"./index-C0x4dXUg.js";import{R as ht}from"./SendOutlined-BhNT19Nx.js";import{T as me,a as oe}from"./index-CQPpjbGx.js";import{s as Me}from"./index-7YfhzvLv.js";import{D as ue,d as he}from"./index-DQN8ynfO.js";import{D as j}from"./index-Dh4nwLPX.js";import{S as C}from"./index-NfKGJaQN.js";import{F as N,R as xt}from"./Table-D7To-GTS.js";import{M as Z}from"./index-Li4Z4oqI.js";import{P as ft}from"./index-CEN69foU.js";import{h as se,R as yt}from"./moment-C3PZI8nc.js";import{D as ye}from"./index-DzB8EFJ-.js";import{T as Le,R as gt}from"./index-52h4BVIb.js";import{L as te}from"./index-BibDJDcy.js";import{C as jt}from"./index-D35NAn0s.js";import{a as wt}from"./index-CxwO9Rc_.js";import{R as St}from"./MessageOutlined-Cr4LarFb.js";import{R as bt}from"./ScheduleOutlined-e49Fikqy.js";import{R as Tt}from"./DollarOutlined-hQO3BQu0.js";import{R as It}from"./DeleteOutlined-BWQ6bMPl.js";var Nt={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M832 464h-68V240c0-70.7-57.3-128-128-128H388c-70.7 0-128 57.3-128 128v224h-68c-17.7 0-32 14.3-32 32v384c0 17.7 14.3 32 32 32h640c17.7 0 32-14.3 32-32V496c0-17.7-14.3-32-32-32zM332 240c0-30.9 25.1-56 56-56h248c30.9 0 56 25.1 56 56v224H332V240zm460 600H232V536h560v304zM484 701v53c0 4.4 3.6 8 8 8h40c4.4 0 8-3.6 8-8v-53a48.01 48.01 0 10-56 0z"}}]},name:"lock",theme:"outlined"},Ft=function(M,r){return m.createElement(_e,Ue({},M,{ref:r,icon:Nt}))},Ct=m.forwardRef(Ft),Dt={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M832 464H332V240c0-30.9 25.1-56 56-56h248c30.9 0 56 25.1 56 56v68c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-68c0-70.7-57.3-128-128-128H388c-70.7 0-128 57.3-128 128v224h-68c-17.7 0-32 14.3-32 32v384c0 17.7 14.3 32 32 32h640c17.7 0 32-14.3 32-32V496c0-17.7-14.3-32-32-32zm-40 376H232V536h560v304zM484 701v53c0 4.4 3.6 8 8 8h40c4.4 0 8-3.6 8-8v-53a48.01 48.01 0 10-56 0z"}}]},name:"unlock",theme:"outlined"},vt=function(M,r){return m.createElement(_e,Ue({},M,{ref:r,icon:Dt}))},At=m.forwardRef(vt),ce={exports:{}},kt=ce.exports,Oe;function Pt(){return Oe||(Oe=1,function(D,M){(function(r,y){y()})(kt,function(){function r(i,o){return typeof o>"u"?o={autoBom:!1}:typeof o!="object"&&(console.warn("Deprecated: Expected third argument to be a object"),o={autoBom:!o}),o.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(i.type)?new Blob(["\uFEFF",i],{type:i.type}):i}function y(i,o,w){var c=new XMLHttpRequest;c.open("GET",i),c.responseType="blob",c.onload=function(){P(c.response,o,w)},c.onerror=function(){console.error("could not download file")},c.send()}function A(i){var o=new XMLHttpRequest;o.open("HEAD",i,!1);try{o.send()}catch{}return 200<=o.status&&299>=o.status}function f(i){try{i.dispatchEvent(new MouseEvent("click"))}catch{var o=document.createEvent("MouseEvents");o.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),i.dispatchEvent(o)}}var g=typeof window=="object"&&window.window===window?window:typeof self=="object"&&self.self===self?self:typeof ie=="object"&&ie.global===ie?ie:void 0,k=g.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),P=g.saveAs||(typeof window!="object"||window!==g?function(){}:"download"in HTMLAnchorElement.prototype&&!k?function(i,o,w){var c=g.URL||g.webkitURL,S=document.createElement("a");o=o||i.name||"download",S.download=o,S.rel="noopener",typeof i=="string"?(S.href=i,S.origin===location.origin?f(S):A(S.href)?y(i,o,w):f(S,S.target="_blank")):(S.href=c.createObjectURL(i),setTimeout(function(){c.revokeObjectURL(S.href)},4e4),setTimeout(function(){f(S)},0))}:"msSaveOrOpenBlob"in navigator?function(i,o,w){if(o=o||i.name||"download",typeof i!="string")navigator.msSaveOrOpenBlob(r(i,w),o);else if(A(i))y(i,o,w);else{var c=document.createElement("a");c.href=i,c.target="_blank",setTimeout(function(){f(c)})}}:function(i,o,w,c){if(c=c||open("","_blank"),c&&(c.document.title=c.document.body.innerText="downloading..."),typeof i=="string")return y(i,o,w);var S=i.type==="application/octet-stream",B=/constructor/i.test(g.HTMLElement)||g.safari,Y=/CriOS\/[\d]+/.test(navigator.userAgent);if((Y||S&&B||k)&&typeof FileReader<"u"){var x=new FileReader;x.onloadend=function(){var T=x.result;T=Y?T:T.replace(/^data:[^;]*;/,"data:attachment/file;"),c?c.location.href=T:location=T,c=null},x.readAsDataURL(i)}else{var b=g.URL||g.webkitURL,p=b.createObjectURL(i);c?c.location=p:location.href=p,c=null,setTimeout(function(){b.revokeObjectURL(p)},4e4)}});g.saveAs=P.saveAs=P,D.exports=P})}(ce)),ce.exports}var Be=Pt();const{TextArea:$t}=ee,Et=({visible:D,onClose:M,account:r,invoice:y,refreshInvoices:A,refreshAccounts:f})=>{const[g]=E.useForm(),[k,P]=m.useState([]),[i,o]=m.useState(!1);m.useEffect(()=>{var b;const x=((b=y||r)==null?void 0:b.notes)||[];P(Array.isArray(x)?x:[])},[y,r]);const w=()=>{try{const x=JSON.parse(localStorage.getItem("user"));return(x==null?void 0:x.name)||(x==null?void 0:x.email)||"Unknown"}catch{return"Unknown"}},c=()=>y?`/api/invoices/${y._id}`:`/api/accounts/${r._id}`,S=async({note:x})=>{if(!x)return;const b={text:x,timestamp:new Date().toISOString(),addedBy:w()},p=[...k,b];try{o(!0),await X.put(c(),{...y||r,notes:p}),Me.success("Note added"),P(p),g.resetFields(),y?A==null||A():f==null||f()}catch(T){console.error("Failed to add note:",T),Me.error("Failed to add note")}finally{o(!1)}},Y=(x=>{const b={};return x.forEach(p=>{if(!p||typeof p!="object")return;const T=p.timestamp?new Date(p.timestamp).toLocaleDateString():"Unknown Date";b[T]||(b[T]=[]),b[T].push(p)}),b})(k);return e.jsx(ge,{title:e.jsxs("div",{children:["Notes for ",y?"Invoice":"Account"," ",e.jsxs(me.Text,{code:!0,children:["#",(y==null?void 0:y.invoiceNumber)||(r==null?void 0:r.businessName)]})]}),open:D,onClose:M,width:450,destroyOnClose:!0,children:e.jsxs(lt,{spinning:i,children:[e.jsx("div",{style:{padding:"0 8px"},children:Object.entries(Y).map(([x,b])=>e.jsxs("div",{children:[e.jsx("div",{className:"note-date-header",children:x}),b.map((p,T)=>e.jsxs("div",{className:"note-bubble",children:[e.jsxs("div",{className:"note-meta",children:[p.addedBy||"Unknown"," • ",p.timestamp?new Date(p.timestamp).toLocaleTimeString():""]}),e.jsx("div",{className:"note-text",children:typeof p.text=="string"?p.text:JSON.stringify(p.text)})]},T))]},x))}),e.jsxs(E,{form:g,layout:"vertical",onFinish:S,style:{marginTop:16},children:[e.jsx(E.Item,{name:"note",rules:[{required:!0,message:"Enter note"}],children:e.jsx($t,{rows:3,placeholder:"Type your note here..."})}),e.jsx(O,{htmlType:"submit",type:"primary",icon:e.jsx(ht,{}),block:!0,children:"Add Note"})]})]})})},{Text:xe}=me,Rt=({visible:D,onClose:M,invoice:r,refreshInvoices:y})=>{var F;const[A]=E.useForm(),[f]=E.useForm(),[g,k]=m.useState(!1),[P,i]=m.useState({paymentHistory:[]}),[o,w]=m.useState(!1),[c,S]=m.useState(null),[B,Y]=m.useState(0),[x,b]=m.useState(0),p=d=>{const u=d.paymentHistory.reduce((z,ae)=>z+ae.amount,0);Y(u),r!=null&&r.totalAmount?b(r.totalAmount-u):b(0)},T=()=>{try{const d=JSON.parse(localStorage.getItem("user"));return(d==null?void 0:d.email)||"Unknown"}catch{return"Unknown"}},_=async()=>{if(r!=null&&r._id)try{const d=await X.get(`/api/invoices/${r._id}`),u={...d.data,paymentHistory:Array.isArray(d.data.paymentHistory)?d.data.paymentHistory:[]};i(u),p(u)}catch(d){R.error("Failed to fetch invoice details."),console.error("Error fetching invoice:",d),i({paymentHistory:[]}),p({paymentHistory:[]})}};m.useEffect(()=>{D&&_()},[D,r==null?void 0:r._id]),m.useEffect(()=>{p(P)},[r==null?void 0:r.totalAmount,P.paymentHistory]);const ne=async d=>{k(!0);try{const u={...d,date:d.date.format("YYYY-MM-DD"),addedBy:T()};await X.post(`/api/invoices/${r._id}/payments`,u),R.success("Payment added successfully!"),A.resetFields(),await _(),y()}catch(u){R.error("Failed to add payment."),console.error("Error adding payment:",u)}finally{k(!1)}},G=async d=>{try{await X.delete(`/api/invoices/${r._id}/payments/${d}`),R.success("Payment deleted successfully!"),await _(),y()}catch(u){R.error("Failed to delete payment."),console.error("Error deleting payment:",u)}},J=async d=>{try{const u={...d,date:d.date.format("YYYY-MM-DD")};await X.put(`/api/invoices/${r._id}/payments/${c}`,u),R.success("Payment updated successfully!"),w(!1),await _(),y()}catch(u){R.error("Failed to update payment."),console.error("Error updating payment:",u)}},l=[{title:"Amount",dataIndex:"amount",key:"amount",render:d=>`₹${Number(d).toFixed(2)}`},{title:"Method",dataIndex:"method",key:"method"},{title:"Reference",dataIndex:"reference",key:"reference"},{title:"Date",dataIndex:"date",key:"date",render:d=>he(d).format("DD/MM/YYYY")},{title:"Added By",dataIndex:"addedBy",key:"addedBy"},{title:"Actions",key:"actions",render:(d,u)=>e.jsxs(de,{size:"middle",children:[e.jsx(O,{type:"link",onClick:()=>{S(u._id),f.setFieldsValue({amount:u.amount,method:u.method,reference:u.reference,date:he(u.date)}),w(!0)},children:"Edit"}),e.jsx(ft,{title:"Are you sure to delete this payment?",onConfirm:()=>G(u._id),okText:"Yes",cancelText:"No",children:e.jsx(O,{type:"link",danger:!0,children:"Delete"})})]})}];return e.jsxs(ge,{title:`Payment History for Invoice #${(r==null?void 0:r.invoiceNo)||"N/A"}`,placement:"right",onClose:M,open:D,width:720,children:[e.jsxs(j,{bordered:!0,column:1,size:"small",style:{marginBottom:20},children:[e.jsx(j.Item,{label:"Invoice Total",children:e.jsxs(xe,{strong:!0,children:["₹",((F=r==null?void 0:r.totalAmount)==null?void 0:F.toFixed(2))||"0.00"]})}),e.jsx(j.Item,{label:"Total Paid",children:e.jsxs(xe,{strong:!0,style:{color:B>0?"green":"inherit"},children:["₹",B.toFixed(2)]})}),e.jsx(j.Item,{label:"Outstanding Balance",children:e.jsxs(xe,{strong:!0,style:{color:x>0?"red":"green"},children:["₹",x.toFixed(2)]})})]}),e.jsx("h3",{children:"Add New Payment"}),e.jsx(E,{form:A,layout:"vertical",onFinish:ne,style:{marginBottom:20},children:e.jsxs(de,{children:[e.jsx(E.Item,{name:"amount",label:"Amount",rules:[{required:!0,message:"Please input amount!"}],children:e.jsx(ee,{type:"number",step:"0.01"})}),e.jsx(E.Item,{name:"method",label:"Method",rules:[{required:!0,message:"Please select method!"}],children:e.jsxs(C,{style:{width:120},children:[e.jsx(C.Option,{value:"Cash",children:"Cash"}),e.jsx(C.Option,{value:"UPI",children:"UPI"}),e.jsx(C.Option,{value:"Bank Transfer",children:"Bank Transfer"}),e.jsx(C.Option,{value:"Card",children:"Card"})]})}),e.jsx(E.Item,{name:"reference",label:"Reference",children:e.jsx(ee,{})}),e.jsx(E.Item,{name:"date",label:"Date",rules:[{required:!0,message:"Please select date!"}],children:e.jsx(ue,{style:{width:"100%"},defaultValue:he(),format:"DD/MM/YYYY"})}),e.jsx(O,{type:"primary",htmlType:"submit",loading:g,children:"Add Payment"})]})}),e.jsx("h3",{children:"Payment History"}),e.jsx(N,{dataSource:P.paymentHistory,columns:l,rowKey:"_id",pagination:!1,scroll:{x:"max-content"}}),e.jsx(Z,{open:o,title:"Edit Payment Entry",onCancel:()=>w(!1),onOk:()=>f.submit(),okText:"Update",cancelText:"Cancel",children:e.jsxs(E,{layout:"vertical",form:f,onFinish:J,children:[e.jsx(E.Item,{name:"amount",label:"Amount",rules:[{required:!0}],children:e.jsx(ee,{type:"number"})}),e.jsx(E.Item,{name:"method",label:"Method",rules:[{required:!0}],children:e.jsxs(C,{children:[e.jsx(C.Option,{value:"Cash",children:"Cash"}),e.jsx(C.Option,{value:"UPI",children:"UPI"}),e.jsx(C.Option,{value:"Bank Transfer",children:"Bank Transfer"}),e.jsx(C.Option,{value:"Card",children:"Card"})]})}),e.jsx(E.Item,{name:"reference",label:"Reference",rules:[{required:!0}],children:e.jsx(ee,{})}),e.jsx(E.Item,{name:"date",label:"Date",rules:[{required:!0}],children:e.jsx(ue,{style:{width:"100%"},format:"DD/MM/YYYY"})})]})})]})},{TextArea:Mt}=ee,{TabPane:fe}=Le,{Text:Ye}=me,Ot=({visible:D,onClose:M,invoice:r,refreshInvoices:y})=>{const[A,f]=m.useState(""),[g,k]=m.useState(null),[P,i]=m.useState(!1),[o,w]=m.useState([]),[c,S]=m.useState(null);m.useEffect(()=>{D&&(r!=null&&r._id)&&B()},[D,r]);const B=async()=>{try{const l=await X.get(`/api/invoices/${r._id}/followups`);w(l.data||[])}catch(l){console.error("Failed to fetch follow-ups:",l),Q.error("Failed to fetch follow-ups")}},Y=()=>{if(!A||!g){Q.error("Please fill in both date and note fields.");return}const l=JSON.parse(localStorage.getItem("user")),F=l==null?void 0:l._id;if(!F){Q.error("User information not found. Please log in.");return}i(!0);const d={date:g.format("YYYY-MM-DD"),note:A,addedBy:F};(c===null?X.post(`/api/invoices/${r._id}/followups`,d):X.put(`/api/invoices/${r._id}/followups/${c}`,d)).then(()=>{Q.success(c===null?"Follow-up added successfully!":"Follow-up updated successfully!"),f(""),k(null),S(null),B(),y()}).catch(z=>{var ae,le;console.error("Error saving follow-up:",z),Q.error(((le=(ae=z==null?void 0:z.response)==null?void 0:ae.data)==null?void 0:le.message)||"Failed to save follow-up.")}).finally(()=>i(!1))},x=l=>{const F=o[l];f(F.note),k(se(F.date)),S(l)},b=l=>{Z.confirm({title:"Delete Follow-up",content:"Are you sure you want to delete this follow-up? This action cannot be undone.",okText:"Yes, Delete",cancelText:"No",okButtonProps:{danger:!0},onOk:()=>{X.delete(`/api/invoices/${r._id}/followups/${l}`).then(()=>{Q.success("Follow-up deleted successfully!"),B(),y()}).catch(F=>{var d,u;console.error("Error deleting follow-up:",F),Q.error(((u=(d=F==null?void 0:F.response)==null?void 0:d.data)==null?void 0:u.message)||"Failed to delete follow-up.")})}})},p=se().format("YYYY-MM-DD"),T=[...o].sort((l,F)=>new Date(F.date)-new Date(l.date)),_=T.filter(l=>se(l.date).format("YYYY-MM-DD")===p),ne=T.filter(l=>se(l.date).isAfter(p,"day")),G=T.filter(l=>se(l.date).isBefore(p,"day")),J=(l,F)=>{var d,u;return e.jsx(te.Item,{actions:[e.jsx(O,{type:"link",onClick:()=>x(F),children:"Edit"},"edit"),e.jsx(O,{type:"link",danger:!0,onClick:()=>b(F),children:"Delete"},"delete")],children:e.jsxs("div",{children:[e.jsx(Ye,{strong:!0,children:se(l.date).format("DD-MM-YYYY")}),e.jsx("br",{}),l.note,e.jsx("br",{}),e.jsxs(Ye,{type:"secondary",children:["By ",((d=l.addedBy)==null?void 0:d.name)||((u=l.addedBy)==null?void 0:u.email)||"Unknown User"]})]})})};return e.jsxs(ge,{title:`Follow-ups for Invoice: ${(r==null?void 0:r.invoiceNumber)||(r==null?void 0:r.proformaNumber)||"N/A"}`,open:D,onClose:()=>{S(null),f(""),k(null),M()},width:720,children:[e.jsxs("div",{style:{marginBottom:20},children:[e.jsx(ue,{style:{width:"100%",marginBottom:8},format:"DD-MM-YYYY",value:g,onChange:l=>k(l),placeholder:"Select follow-up date"}),e.jsx(Mt,{rows:4,placeholder:"Enter follow-up note",value:A,onChange:l=>f(l.target.value)}),e.jsx(O,{type:"primary",block:!0,onClick:Y,loading:P,style:{marginTop:10},children:c===null?"Add Follow-up":"Update Follow-up"})]}),e.jsx(ye,{children:"Existing Follow-ups"}),e.jsxs(Le,{defaultActiveKey:"today",children:[e.jsx(fe,{tab:`Today's (${_.length})`,children:e.jsx(te,{dataSource:_,renderItem:l=>J(l,o.indexOf(l)),locale:{emptyText:"No follow-ups scheduled for today."}})},"today"),e.jsx(fe,{tab:`Upcoming (${ne.length})`,children:e.jsx(te,{dataSource:ne,renderItem:l=>J(l,o.indexOf(l)),locale:{emptyText:"No upcoming follow-ups."}})},"upcoming"),e.jsx(fe,{tab:`Past (${G.length})`,children:e.jsx(te,{dataSource:G,renderItem:l=>J(l,o.indexOf(l)),locale:{emptyText:"No past follow-ups."}})},"past")]})]})},{Text:h}=me,{RangePicker:Bt}=ue,Yt=({invoices:D,onAddNew:M,onEdit:r,onDelete:y,onSearch:A,refreshInvoices:f})=>{var Se,be,Te,Ie,Ne,Fe,Ce;const[g,k]=m.useState(""),[P,i]=m.useState(!1),[o,w]=m.useState(null),[c,S]=m.useState("all"),[B,Y]=m.useState(!1),[x,b]=m.useState(!1),[p,T]=m.useState(!1),[_,ne]=m.useState(null),[G,J]=m.useState("all"),[l,F]=m.useState("Invoice"),[d,u]=m.useState(!1),[z,ae]=m.useState("all"),le=[...new Set(D.map(t=>t.businessName))],V=t=>{const n=["","One","Two","Three","Four","Five","Six","Seven","Eight","Nine"],a=["Ten","Eleven","Twelve","Thirteen","Fourteen","Fifteen","Sixteen","Seventeen","Eighteen","Nineteen"],s=["","Ten","Twenty","Thirty","Forty","Fifty","Sixty","Seventy","Eighty","Ninety"];return t===0?"Zero":t<10?n[t]:t<20?a[t-10]:t<100?s[Math.floor(t/10)]+(t%10?" "+n[t%10]:""):t<1e3?n[Math.floor(t/100)]+" Hundred"+(t%100?" and "+V(t%100):""):t<1e5?V(Math.floor(t/1e3))+" Thousand"+(t%1e3?" "+V(t%1e3):""):t<1e7?V(Math.floor(t/1e5))+" Lakh"+(t%1e5?" "+V(t%1e5):""):V(Math.floor(t/1e7))+" Crore"+(t%1e7?" "+V(t%1e7):"")},$=t=>isNaN(t)?"0.00":t.toLocaleString("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2}),Xe=t=>{try{const n=new dt({orientation:"portrait",unit:"mm",format:"a4"});n.setProperties({title:`${t.invoiceType} - ${t.invoiceNumber||t.proformaNumber}`,subject:"Invoice",author:"Your Company Name",keywords:"invoice, billing",creator:"Invoice Management System"});const a=15;let s=a;n.setFontSize(16),n.setTextColor(0,0,0),n.setFont("helvetica","bold"),n.text(t.invoiceType==="Proforma"?"PROFORMA INVOICE":"TAX INVOICE",105,s,{align:"center"}),s+=10,n.setFontSize(10),n.setTextColor(0,0,0),n.setFont("helvetica","bold"),n.text("Your Company Name",a,s),n.setFont("helvetica","normal"),n.text("Your Company Address Line 1",a,s+5),n.text("Your Company Address Line 2",a,s+10),n.text("City, State - PIN, Country",a,s+15),n.text(`GSTIN: ${t.companyGSTIN||"XXXXXXXXXXXXXXX"}`,a,s+20),s+=30,n.setFontSize(10),n.setFont("helvetica","bold"),n.text(`Bill To: ${t.customerName||"N/A"}`,a,s),n.text(`${t.invoiceType==="Proforma"?"Proforma No":"Invoice No"}: ${t.invoiceType==="Proforma"?t.proformaNumber:t.invoiceNumber||"N/A"}`,140,s),s+=5,n.text(`Contact: ${t.contactPerson||"N/A"}`,a,s),n.text(`Date: ${t.date||new Date().toLocaleDateString()}`,140,s),s+=5,n.text(`Phone: ${t.contactNumber||"N/A"}`,a,s),n.text(`Due Date: ${t.dueDate||"N/A"}`,140,s),s+=5,n.text(`GSTIN: ${t.customerGSTIN||"N/A"}`,a,s),s+=5,n.text(`Address: ${t.customerAddress||"N/A"}`,a,s),s+=10;const U=(t.items||[]).map((v,ot)=>{var Ae,ke,Pe;const st=((Ae=v==null?void 0:v.description)==null?void 0:Ae.toString())||"N/A",at=v!=null&&v.specifications&&v.specifications.length>0?v.specifications.map($e=>`${$e.name}: ${$e.value}`).join(", "):"N/A",De=((ke=v==null?void 0:v.quantity)==null?void 0:ke.toString())||"1",ve=((Pe=v==null?void 0:v.rate)==null?void 0:Pe.toString())||"0",rt=(parseFloat(De)*parseFloat(ve)).toFixed(2);return[(ot+1).toString(),st,at,De,`₹${$(parseFloat(ve))}`,`₹${$(parseFloat(rt))}`]});ut(n,{head:[["S.No","Description","Specification","Qty","Unit Price (₹)","Total (₹)"]],body:U,startY:s,theme:"grid",headStyles:{fillColor:[41,128,185],textColor:255,fontStyle:"bold"},styles:{fontSize:9,cellPadding:3,overflow:"linebreak"},columnStyles:{0:{cellWidth:10},1:{cellWidth:50},2:{cellWidth:35},3:{cellWidth:15},4:{cellWidth:25},5:{cellWidth:25}}}),s=n.lastAutoTable.finalY+10,n.setFontSize(10),n.setFont("helvetica","bold"),n.text("Amount Summary:",a,s),s+=5;const I=parseFloat(t.subTotal)||0,H=parseFloat(t.igstAmount)||0,q=parseFloat(t.cgstAmount)||0,W=parseFloat(t.sgstAmount)||0,re=H+q+W,K=parseFloat(t.totalAmount)||0;if(n.text("Sub Total:",140,s),n.text(`₹${$(I)}`,200-a,s,{align:"right"}),s+=5,t.gstType==="interstate")n.text(`IGST (${t.gstPercentage||0}%):`,140,s),n.text(`₹${$(H)}`,200-a,s,{align:"right"}),s+=5;else if(t.gstType==="intrastate"){const v=(t.gstPercentage||0)/2;n.text(`CGST (${v}%):`,140,s),n.text(`₹${$(q)}`,200-a,s,{align:"right"}),s+=5,n.text(`SGST (${v}%):`,140,s),n.text(`₹${$(W)}`,200-a,s,{align:"right"}),s+=5}n.text("Grand Total:",140,s),n.text(`₹${$(K)}`,200-a,s,{align:"right"}),s+=10,n.setFont("helvetica","bold"),n.text("Amount in Words:",a,s),n.setFont("helvetica","normal"),n.text(`${V(Math.floor(K))} Rupees Only`,a+30,s),s+=15,n.setFontSize(9),n.setFont("helvetica","bold"),n.text("Payment Terms:",a,s),n.setFont("helvetica","normal"),n.text(t.paymentTerms||"Payment due within 15 days of invoice date",a+25,s),s+=10,n.setFontSize(8),n.setFont("helvetica","bold"),n.text("Notes:",a,s),n.setFont("helvetica","normal"),n.text(t.notes||"Thank you for your business!",a+15,s,{maxWidth:180}),s+=15,n.setFontSize(9),n.setFont("helvetica","bold"),n.text("Bank Details:",a,s),n.setFont("helvetica","normal"),n.text("Bank Name: Your Bank Name",a,s+5),n.text("Account Number: XXXXXXXXXXXX",a,s+10),n.text("IFSC Code: XXXXXXXXXX",a,s+15),n.text("Branch: Your Branch Name",a,s+20),s+=30,n.setFontSize(10),n.text("This is Computer Generated Invoice & requires no Signature",105,s,{align:"center"});const nt=n.output("blob");Be.saveAs(nt,`${t.invoiceType.toLowerCase()}-${t.invoiceType==="Proforma"?t.proformaNumber:t.invoiceNumber||"draft"}.pdf`)}catch(n){console.error("Error generating PDF:",n),R.error("Failed to generate PDF")}},je=t=>{k(t),A(t)},Ve=t=>{w(t),i(!0)},He=t=>{w(t),Y(!0)},ze=t=>{w(t),T(!0)},qe=t=>{w(t),u(!0)},Ge=t=>{w(t),b(!0)},We=async t=>{const n=R.loading("Closing invoice...");try{await X.patch(`/api/invoices/${t}/close`),R.success("Invoice closed successfully",{id:n}),f==null||f()}catch(a){console.error("Error closing invoice:",a),R.error("Failed to close invoice",{id:n})}},Ke=async t=>{const n=R.loading("Unlocking invoice...");try{await X.patch(`/api/invoices/${t}/unlock`),R.success("Invoice unlocked successfully",{id:n}),f==null||f()}catch(a){console.error("Error unlocking invoice:",a),R.error("Failed to unlock invoice",{id:n})}},Je=()=>{const t=we.map((I,H)=>({SNo:H+1,InvoiceNumber:I.invoiceType==="Proforma"?I.proformaNumber:I.invoiceNumber,Type:I.invoiceType,Business:I.businessName,Customer:I.customerName,TotalAmount:I.totalAmount||0,Date:I.date,DueDate:I.dueDate||"",Status:I.paymentStatus,Closed:I.isClosed?"Yes":"No",ConversionStatus:I.invoiceType==="Proforma"&&I.conversionStatus||"N/A"})),n=pe.json_to_sheet(t),a=pe.book_new();pe.book_append_sheet(a,n,"Invoices");const s=mt(a,{bookType:"xlsx",type:"array"}),U=new Blob([s],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});Be.saveAs(U,`Invoices-${new Date().toISOString().split("T")[0]}.xlsx`)},we=D.filter(t=>{var q,W,re,K;const n=t.invoiceType===l,a=!g||((q=t.invoiceNumber)==null?void 0:q.toLowerCase().includes(g.toLowerCase()))||((W=t.proformaNumber)==null?void 0:W.toLowerCase().includes(g.toLowerCase()))||((re=t.businessName)==null?void 0:re.toLowerCase().includes(g.toLowerCase()))||((K=t.customerName)==null?void 0:K.toLowerCase().includes(g.toLowerCase())),s=!_||new Date(t.date)>=_[0].toDate()&&new Date(t.date)<=_[1].toDate(),U=c==="all"?!0:c==="overdue"?t.paymentStatus!=="paid"&&new Date(t.dueDate)<new Date:t.paymentStatus===c,I=G==="all"?!0:t.businessName===G,H=z==="all"?!0:t.invoiceType==="Proforma"&&t.conversionStatus===z;return n&&a&&s&&U&&I&&H}),Qe=t=>{const n={paid:{color:"green",text:"Paid"},partial:{color:"orange",text:"Partial"},pending:{color:"red",text:"Pending"}}[t]||{};return e.jsx(oe,{color:n.color,children:n.text})},Ze=e.jsx(de,{style:{marginBottom:16},children:["Invoice","Proforma"].map(t=>{const n=D.filter(s=>s.invoiceType===t).length,a=l===t;return e.jsxs("span",{onClick:()=>F(t),style:{cursor:"pointer",borderBottom:a?"2px solid #1890ff":"none",color:a?"#1890ff":"#000",fontWeight:a?"600":"normal",paddingBottom:4,marginRight:20},children:[t," (",n,")"]},t)})}),et=()=>[{title:"S.No",width:60,align:"center",render:(t,n,a)=>a+1},{title:"Description",dataIndex:"description",ellipsis:!0,render:(t,n)=>{var a;if(!t&&((a=n.specifications)==null?void 0:a.length)>0){const s=n.specifications.find(U=>U.name==="SPECIFICATION");return s?s.value:"N/A"}return t||"N/A"}},{title:"HSN/SAC",dataIndex:"hsnSac",width:100,align:"center",render:t=>t||"N/A"},{title:"Qty",dataIndex:"quantity",width:80,align:"center",render:t=>parseFloat(t)||0},{title:"Unit Price (₹)",width:140,align:"right",render:(t,n)=>$(n.rate||0)},{title:"Total (₹)",width:140,align:"right",render:(t,n)=>e.jsx(h,{strong:!0,style:{color:"#52c41a"},children:$((n.quantity||0)*(n.rate||0))})}],tt=[{title:"S.No",render:(t,n,a)=>e.jsx(h,{strong:!0,children:a+1}),width:60},{title:"Number",render:(t,n)=>e.jsx(oe,{icon:e.jsx(Ee,{}),color:"blue",children:n.invoiceType==="Proforma"?n.proformaNumber:n.invoiceNumber})},{title:"Type",dataIndex:"invoiceType",render:t=>e.jsx(oe,{color:t==="Proforma"?"purple":"cyan",children:t})},{title:"Business",render:(t,n)=>{var s;const a=((s=n.businessId)==null?void 0:s.businessName)||n.businessName;return e.jsx(Re,{title:a,children:e.jsx(h,{strong:!0,children:a})})}},{title:"Customer",render:(t,n)=>{const s=(n.businessId||{}).businessName||n.customerName||"N/A";return e.jsx(Re,{title:s,children:e.jsx(h,{children:s})})}},{title:"Amount",dataIndex:"totalAmount",align:"right",render:t=>e.jsxs(h,{style:{color:"#52c41a"},children:["₹",(t||0).toFixed(2)]})},{title:"Date",dataIndex:"date",align:"center",render:t=>e.jsx(h,{children:t||"N/A"})},{title:"Due Date",dataIndex:"dueDate",align:"center",render:t=>e.jsx(h,{children:t||"N/A"})},{title:"Actions",width:80,render:(t,n)=>e.jsx(it,{overlay:e.jsxs(L,{children:[e.jsx(L.Item,{icon:e.jsx(pt,{}),onClick:()=>Ve(n),children:"View Invoice Details"},"view"),e.jsx(L.Item,{icon:e.jsx(Ee,{}),onClick:()=>qe(n),children:"View Item Specifications"},"view-specs"),e.jsx(L.Item,{icon:e.jsx(ct,{}),onClick:()=>Xe(n),children:"Generate PDF"},"generate-pdf"),e.jsx(L.Item,{icon:e.jsx(St,{}),onClick:()=>He(n),children:"View Notes"},"view-notes"),e.jsx(L.Item,{icon:e.jsx(bt,{}),onClick:()=>Ge(n),children:"Add/View Follow-ups"},"add-followup"),e.jsx(L.Item,{icon:e.jsx(Tt,{}),onClick:()=>ze(n),children:"View Payments"},"view-payments"),!n.isClosed&&e.jsx(L.Item,{icon:e.jsx(xt,{}),onClick:()=>r(n),children:"Edit Invoice"},"edit"),n.isClosed?e.jsx(L.Item,{icon:e.jsx(At,{}),onClick:()=>{Z.confirm({title:"Unlock Invoice",content:"Are you sure you want to unlock this invoice? It will become editable again.",okText:"Yes, Unlock",cancelText:"No",onOk:()=>Ke(n._id)})},children:"Unlock Invoice"},"unlock"):e.jsx(L.Item,{icon:e.jsx(Ct,{}),onClick:()=>{Z.confirm({title:"Close Invoice",content:"Are you sure you want to close this invoice? It will become uneditable.",okText:"Yes, Close",cancelText:"No",okButtonProps:{danger:!0},onOk:()=>We(n._id)})},children:"Lock Invoice"},"lock"),e.jsx(L.Item,{icon:e.jsx(It,{}),danger:!0,onClick:()=>{Z.confirm({title:"Delete Invoice",content:"Are you sure you want to delete this invoice? This action cannot be undone.",okText:"Yes, Delete",cancelText:"No",okButtonProps:{danger:!0},onOk:()=>y(n._id)})},children:"Delete Invoice"},"delete")]}),trigger:["click"],children:e.jsx(O,{icon:e.jsx(yt,{})})})}];return e.jsxs(e.Fragment,{children:[e.jsxs(jt,{title:"Invoice Management",extra:e.jsxs(de,{wrap:!0,children:[e.jsx(Bt,{onChange:ne,format:"YYYY-MM-DD"}),e.jsxs(C,{value:c,onChange:S,style:{width:140},children:[e.jsx(C.Option,{value:"all",children:"All Status"}),e.jsx(C.Option,{value:"paid",children:"Paid"}),e.jsx(C.Option,{value:"pending",children:"Pending"}),e.jsx(C.Option,{value:"partial",children:"Partial"}),e.jsx(C.Option,{value:"overdue",children:"Overdue"})]}),e.jsxs(C,{value:G,onChange:J,placeholder:"Filter by Business",style:{width:200},allowClear:!0,children:[e.jsx(C.Option,{value:"all",children:"All Businesses"}),le.map(t=>e.jsx(C.Option,{value:t,children:t},t))]}),e.jsx(ee.Search,{placeholder:"Search invoices",onSearch:je,onChange:t=>je(t.target.value),style:{width:240},allowClear:!0,prefix:e.jsx(wt,{})}),e.jsx(O,{onClick:Je,children:"Export Excel"}),e.jsx(O,{type:"primary",icon:e.jsx(gt,{}),onClick:M,children:"New Invoice"})]}),children:[Ze,e.jsx(N,{dataSource:we,columns:tt,rowKey:"_id",pagination:{pageSize:10},bordered:!0,scroll:{x:!0}})]}),e.jsx(Z,{title:"Invoice Details",open:P,onCancel:()=>i(!1),footer:e.jsx(O,{onClick:()=>i(!1),children:"Close"}),width:1e3,children:o&&e.jsxs("div",{children:[e.jsxs(j,{bordered:!0,column:2,size:"small",children:[e.jsx(j.Item,{label:o.invoiceType==="Proforma"?"Proforma No":"Invoice No",children:o.invoiceType==="Proforma"?o.proformaNumber:o.invoiceNumber}),e.jsx(j.Item,{label:"Type",children:o.invoiceType}),e.jsx(j.Item,{label:"Date",children:o.date?new Date(o.date).toLocaleDateString("en-IN"):"N/A"}),e.jsx(j.Item,{label:"Due Date",children:o.dueDate?new Date(o.dueDate).toLocaleDateString("en-IN"):"N/A"}),e.jsx(j.Item,{label:"Business",children:o.businessName}),e.jsx(j.Item,{label:"Customer",children:o.customerName}),e.jsx(j.Item,{label:"GSTIN",span:2,children:e.jsx(h,{code:!0,children:o.gstin||"N/A"})}),e.jsx(j.Item,{label:"Business Info",span:2,children:e.jsx(h,{style:{whiteSpace:"pre-wrap"},children:o.businessInfo||"N/A"})})]}),((Se=o.items)==null?void 0:Se.length)>0&&e.jsxs(e.Fragment,{children:[e.jsxs(ye,{orientation:"left",children:["Items (",o.items.length,")"]}),e.jsx(N,{dataSource:o.items,columns:et(),pagination:!1,size:"small",rowKey:(t,n)=>`${o._id}-item-${n}`,bordered:!0,expandable:{expandedRowRender:t=>{var n;return e.jsx("div",{style:{margin:0,padding:0},children:((n=t.specifications)==null?void 0:n.length)>0&&e.jsx(j,{column:1,size:"small",children:t.specifications.filter(a=>a.name!=="SPECIFICATION").map((a,s)=>e.jsx(j.Item,{label:a.name,children:a.value},s))})})},rowExpandable:t=>{var n;return((n=t.specifications)==null?void 0:n.length)>0}},summary:t=>{const n=t.reduce((re,K)=>re+(K.quantity||0)*(K.rate||0),0),a=o.gstPercentage||0,s=o.gstType||"intrastate";let U=0,I=0,H=0,q=0;s==="interstate"?(q=n*(a/100),U=q):(I=n*(a/200),H=n*(a/200),U=I+H);const W=n+U;return e.jsxs(N.Summary,{fixed:!0,children:[e.jsxs(N.Summary.Row,{children:[e.jsx(N.Summary.Cell,{index:0,colSpan:5,align:"right",children:e.jsx(h,{strong:!0,children:"Sub Total:"})}),e.jsx(N.Summary.Cell,{index:5,children:e.jsx(h,{strong:!0,children:$(n)})})]}),s==="interstate"?e.jsxs(N.Summary.Row,{children:[e.jsx(N.Summary.Cell,{index:0,colSpan:5,align:"right",children:e.jsxs(h,{strong:!0,children:["IGST (",a,"%):"]})}),e.jsx(N.Summary.Cell,{index:5,children:e.jsx(h,{strong:!0,children:$(q)})})]}):e.jsxs(e.Fragment,{children:[e.jsxs(N.Summary.Row,{children:[e.jsx(N.Summary.Cell,{index:0,colSpan:5,align:"right",children:e.jsxs(h,{strong:!0,children:["CGST (",a/2,"%):"]})}),e.jsx(N.Summary.Cell,{index:5,children:e.jsx(h,{strong:!0,children:$(I)})})]}),e.jsxs(N.Summary.Row,{children:[e.jsx(N.Summary.Cell,{index:0,colSpan:5,align:"right",children:e.jsxs(h,{strong:!0,children:["SGST (",a/2,"%):"]})}),e.jsx(N.Summary.Cell,{index:5,children:e.jsx(h,{strong:!0,children:$(H)})})]})]}),e.jsxs(N.Summary.Row,{children:[e.jsx(N.Summary.Cell,{index:0,colSpan:5,align:"right",children:e.jsx(h,{strong:!0,children:"Grand Total:"})}),e.jsx(N.Summary.Cell,{index:5,children:e.jsx(h,{strong:!0,style:{color:"#52c41a"},children:$(W)})})]}),e.jsx(N.Summary.Row,{children:e.jsx(N.Summary.Cell,{index:0,colSpan:6,children:e.jsxs(h,{italic:!0,children:["Amount in words:"," ",V(Math.floor(W))," Rupees Only"]})})})]})}})]}),e.jsxs(j,{column:2,bordered:!0,size:"small",style:{marginTop:"20px"},children:[e.jsxs(j.Item,{label:"Sub Total",span:2,children:["₹",((be=o.subTotal)==null?void 0:be.toFixed(2))||"0.00"]}),o.gstType==="interstate"?e.jsxs(j.Item,{label:"IGST Amount",span:2,children:["₹",((Te=o.igstAmount)==null?void 0:Te.toFixed(2))||"0.00"]}):e.jsxs(e.Fragment,{children:[e.jsxs(j.Item,{label:"CGST Amount",span:1,children:["₹",((Ie=o.cgstAmount)==null?void 0:Ie.toFixed(2))||"0.00"]}),e.jsxs(j.Item,{label:"SGST Amount",span:1,children:["₹",((Ne=o.sgstAmount)==null?void 0:Ne.toFixed(2))||"0.00"]})]}),e.jsx(j.Item,{label:"Grand Total",span:2,children:e.jsxs(h,{strong:!0,style:{fontSize:"18px",color:"#52c41a"},children:["₹",((Fe=o.totalAmount)==null?void 0:Fe.toFixed(2))||"0.00"]})}),e.jsx(j.Item,{label:"Amount in Words",span:2,children:e.jsxs(h,{italic:!0,children:[V(Math.floor(o.totalAmount||0))," ","Rupees Only"]})}),e.jsx(j.Item,{label:"Status",span:2,children:Qe(o.paymentStatus)}),e.jsx(j.Item,{label:"Closed",span:2,children:o.isClosed?e.jsx(oe,{color:"red",children:"Yes"}):e.jsx(oe,{color:"green",children:"No"})}),o.invoiceType==="Proforma"&&e.jsx(j.Item,{label:"Conversion Status",span:2,children:e.jsx(oe,{color:o.conversionStatus==="converted"?"green":o.conversionStatus==="rejected"?"red":"blue",children:o.conversionStatus==="converted"?"Converted":o.conversionStatus==="rejected"?"Rejected":"Pending Conversion"})})]}),((Ce=o.notes)==null?void 0:Ce.length)>0&&e.jsxs(e.Fragment,{children:[e.jsxs(ye,{orientation:"left",children:["Notes (",o.notes.length,")"]}),o.notes.map((t,n)=>e.jsxs("div",{style:{marginBottom:8},children:[e.jsx(h,{strong:!0,children:t.author})," on"," ",e.jsx(h,{type:"secondary",children:t.timestamp}),e.jsx("p",{children:t.text})]},n))]})]})}),e.jsx(Z,{title:"Item Specifications",open:d,onCancel:()=>u(!1),footer:e.jsx(O,{onClick:()=>u(!1),children:"Close"}),width:800,children:o&&o.items&&e.jsx(te,{itemLayout:"vertical",dataSource:o.items,renderItem:(t,n)=>e.jsx(te.Item,{children:e.jsx(te.Item.Meta,{title:e.jsx(h,{strong:!0,children:t.description||"No Description"}),description:e.jsxs(e.Fragment,{children:[e.jsxs(h,{children:["Quantity: ",t.quantity]}),e.jsx("br",{}),e.jsxs(h,{children:["Rate: ₹",$(t.rate)]}),e.jsx("br",{}),t.hsnSac&&e.jsxs(h,{children:["HSN/SAC: ",t.hsnSac]}),t.specifications&&t.specifications.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("br",{}),e.jsx(h,{strong:!0,children:"Specifications:"}),e.jsx("ul",{children:t.specifications.map((a,s)=>e.jsxs("li",{children:[a.name,": ",a.value]},s))})]})]})})},n)})}),o&&e.jsx(Et,{visible:B,onClose:()=>Y(!1),invoice:o,refreshInvoices:f}),o&&e.jsx(Ot,{visible:x,onClose:()=>b(!1),invoice:o,refreshInvoices:f}),e.jsx(Rt,{visible:p,onClose:()=>T(!1),invoice:o,refreshInvoices:f})]})},pn=Object.freeze(Object.defineProperty({__proto__:null,default:Yt},Symbol.toStringTag,{value:"Module"}));export{Yt as I,Et as N,pn as a};
