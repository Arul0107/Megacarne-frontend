import{r as p,E as f,p as e,C as j,D as oe,V as x,T as ne,F as le,M as g}from"./index-Bb3iEPMp.js";import{R as q,E as ae}from"./jspdf.es.min-BTZJM5r9.js";import re from"./html2canvas.esm-CBrSDip1.js";import{i as U,I as Z,R as ie}from"./axios-DCtTpA0N.js";import{h as F,R as de}from"./moment-vgxS63qH.js";import{D as ce}from"./index-D6GAQ_u7.js";import{D as me}from"./index-B7TWxO8Z.js";import{D as K}from"./index-CVLB7Q99.js";import{T as ee}from"./index-cBdIU9Pv.js";import{L as M}from"./index-D_7VJabU.js";import{T as te,a as z}from"./index-CYGB0aP3.js";import{M as se}from"./index-Cj4OrNc-.js";import{a as ue}from"./index-CkwLvGmr.js";import{F as u,R as pe}from"./Table-BdyiHqL-.js";import{D as r}from"./index-D4qKKYUJ.js";import{R as he}from"./MessageOutlined-EEmKcb3Y.js";import{R as xe}from"./ScheduleOutlined-GGuVuyYY.js";import{P as fe}from"./index-DDpDepK1.js";import{R as ge}from"./DeleteOutlined-DUY0Gbb0.js";import"./context-DzxhWYhG.js";import"./index-fWweIekq.js";import"./index-B3OjFfHS.js";const{TextArea:je}=Z,{TabPane:H}=ee,{Text:X}=te,ye=({visible:y,onClose:Q,quotation:m,refreshQuotations:L})=>{const[C,w]=p.useState(""),[T,I]=p.useState(null),[O,b]=p.useState(!1),[l,B]=p.useState([]),[N,D]=p.useState(null);p.useEffect(()=>{y&&(m!=null&&m._id)&&v()},[y,m]);const v=async()=>{try{const t=await U.get(`/api/quotations/${m._id}/followups`);B(t.data||[])}catch(t){console.error("Failed to fetch follow-ups for quotation:",t),f.error("Failed to fetch follow-ups for this quotation.")}},V=()=>{if(!C||!T){f.error("Please fill in both date and note fields.");return}const t=JSON.parse(localStorage.getItem("user")),o=t==null?void 0:t._id;if(!o){f.error("User information not found. Please log in.");return}b(!0);const n={date:T.format("YYYY-MM-DD"),note:C,addedBy:o};(N===null?U.post(`/api/quotations/${m._id}/followups`,n):U.put(`/api/quotations/${m._id}/followups/${N}`,n)).then(()=>{f.success(N===null?"Follow-up added successfully!":"Follow-up updated successfully!"),w(""),I(null),D(null),v(),L()}).catch(i=>{var c,A;console.error("Error saving follow-up:",i),f.error(((A=(c=i==null?void 0:i.response)==null?void 0:c.data)==null?void 0:A.message)||"Failed to save follow-up.")}).finally(()=>b(!1))},Y=t=>{const o=l[t];w(o.note),I(F(o.date)),D(t)},h=t=>{se.confirm({title:"Delete Follow-up",content:"Are you sure you want to delete this follow-up? This action cannot be undone.",okText:"Yes, Delete",cancelText:"No",okButtonProps:{danger:!0},onOk:()=>{U.delete(`/api/quotations/${m._id}/followups/${t}`).then(()=>{f.success("Follow-up deleted successfully!"),v(),L()}).catch(o=>{var n,a;console.error("Error deleting follow-up:",o),f.error(((a=(n=o==null?void 0:o.response)==null?void 0:n.data)==null?void 0:a.message)||"Failed to delete follow-up.")})}})},S=F().format("YYYY-MM-DD"),$=[...l].sort((t,o)=>new Date(o.date)-new Date(t.date)),P=$.filter(t=>F(t.date).format("YYYY-MM-DD")===S),k=$.filter(t=>F(t.date).isAfter(S,"day")),E=$.filter(t=>F(t.date).isBefore(S,"day")),s=(t,o)=>{var n,a;return e.jsx(M.Item,{actions:[e.jsx(j,{type:"link",onClick:()=>Y(o),children:"Edit"},"edit"),e.jsx(j,{type:"link",danger:!0,onClick:()=>h(o),children:"Delete"},"delete")],children:e.jsxs("div",{children:[e.jsx(X,{strong:!0,children:F(t.date).format("DD-MM-YYYY")}),e.jsx("br",{}),t.note,e.jsx("br",{}),e.jsxs(X,{type:"secondary",children:["By ",((n=t.addedBy)==null?void 0:n.name)||((a=t.addedBy)==null?void 0:a.email)||"Unknown User"]})]})})};return e.jsxs(ce,{title:`Follow-ups for Quotation: ${(m==null?void 0:m.quotationNumber)||"N/A"}`,open:y,onClose:()=>{D(null),w(""),I(null),Q()},width:720,children:[e.jsxs("div",{style:{marginBottom:20},children:[e.jsx(me,{style:{width:"100%",marginBottom:8},format:"DD-MM-YYYY",value:T,onChange:t=>I(t),placeholder:"Select follow-up date"}),e.jsx(je,{rows:4,placeholder:"Enter follow-up note",value:C,onChange:t=>w(t.target.value)}),e.jsx(j,{type:"primary",block:!0,onClick:V,loading:O,style:{marginTop:10},children:N===null?"Add Follow-up":"Update Follow-up"})]}),e.jsx(K,{children:"Existing Follow-ups"}),e.jsxs(ee,{defaultActiveKey:"today",children:[e.jsx(H,{tab:`Today's (${P.length})`,children:e.jsx(M,{dataSource:P,renderItem:t=>s(t,l.indexOf(t)),locale:{emptyText:"No follow-ups scheduled for today."}})},"today"),e.jsx(H,{tab:`Upcoming (${k.length})`,children:e.jsx(M,{dataSource:k,renderItem:t=>s(t,l.indexOf(t)),locale:{emptyText:"No upcoming follow-ups."}})},"upcoming"),e.jsx(H,{tab:`Past (${E.length})`,children:e.jsx(M,{dataSource:E,renderItem:t=>s(t,l.indexOf(t)),locale:{emptyText:"No past follow-ups."}})},"past")]})]})},{Text:d}=te,Qe=({quotations:y,onAddNew:Q,onEdit:m,onDelete:L,onSearch:C,onViewNotes:w,loading:T,refreshQuotations:I})=>{var P,k,E;const[O,b]=p.useState(!1),[l,B]=p.useState(null),[N,D]=p.useState(!1),v=s=>{B(s),b(!0),x.success("Quotation details loaded.",{duration:1500,position:"top-right"})},V=s=>{B(s),D(!0)},Y=async s=>{let t=null;const o=x.loading("Generating PDF...",{position:"top-center"});try{const n=document.getElementById(`quotation-${s._id}`);if(!n){x.error("Quotation content not found for PDF generation. Please try again.",{id:o});return}t=n.cloneNode(!0),t.style.position="fixed",t.style.top="-9999px",t.style.left="-9999px",t.style.width="210mm",t.style.padding="10mm",t.style.background="white",t.style.zIndex="-1",t.style.display="block",document.body.appendChild(t),await new Promise(R=>setTimeout(R,100));const i=(await re(t,{scale:2,useCORS:!0,logging:!1})).toDataURL("image/png"),c=new ae("p","mm","a4"),A=c.internal.pageSize.getWidth(),G=c.internal.pageSize.getHeight(),W=c.getImageProperties(i),_=W.height*A/W.width;let J=0;if(_>G){let R=_;for(;R>0;)c.addImage(i,"PNG",0,J,A,_),R-=G,J-=G,R>0&&c.addPage()}else c.addImage(i,"PNG",0,0,A,_);c.save(`${s.quotationNumber||"quotation"}.pdf`),x.success("PDF downloaded successfully!",{id:o})}catch(n){console.error("Failed to generate PDF:",n),x.error("Failed to generate PDF. Please try again.",{id:o})}finally{t&&document.body.contains(t)&&document.body.removeChild(t)}},h=s=>`₹${(parseFloat(s)||0).toLocaleString("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2})}`,S=()=>[{title:"S.No",width:60,align:"center",render:(s,t,o)=>o+1},{title:"Description",dataIndex:"description",ellipsis:!0,render:(s,t)=>{var o;if(!s&&((o=t.specifications)==null?void 0:o.length)>0){const n=t.specifications.find(a=>a.name==="SPECIFICATION");return n?n.value:"N/A"}return s||"N/A"}},{title:"HSN/SAC",dataIndex:"hsnSac",width:100,align:"center",render:s=>s||"N/A"},{title:"Qty",dataIndex:"quantity",width:80,align:"center",render:s=>parseFloat(s)||0},{title:"Unit Price (₹)",width:140,align:"right",render:(s,t)=>h(t.rate||0)},{title:"Total (₹)",width:140,align:"right",render:(s,t)=>e.jsx(d,{strong:!0,style:{color:"#52c41a"},children:h((t.quantity||0)*(t.rate||0))})}],$=[{title:"Quotation #",dataIndex:"quotationNumber",render:s=>e.jsx(z,{color:"blue",children:s||"N/A"}),sorter:(s,t)=>(s.quotationNumber||"").localeCompare(t.quotationNumber||"")},{title:"Business",dataIndex:"businessName",sorter:(s,t)=>(s.businessName||"").localeCompare(t.businessName||"")},{title:"Customer",dataIndex:"customerName",render:(s,t)=>e.jsxs("div",{children:[e.jsx("div",{children:s||"N/A"}),t.customerEmail&&e.jsx("div",{style:{fontSize:12,color:"#666"},children:t.customerEmail})]}),sorter:(s,t)=>(s.customerName||"").localeCompare(t.customerName||"")},{title:"Items Count",render:(s,t)=>{var o,n;return e.jsxs(z,{color:"geekblue",children:[((o=t.items)==null?void 0:o.length)||0," item",(((n=t.items)==null?void 0:n.length)||0)!==1?"s":""]})}},{title:"Latest Note",dataIndex:"notes",render:s=>{if(s&&s.length>0){const t=s[s.length-1],o=t.text.length>30?`${t.text.substring(0,30)}...`:t.text;return e.jsx(ne,{title:t.text,children:e.jsx(d,{type:"secondary",children:o})})}return e.jsx(d,{type:"secondary",italic:!0,children:"No notes"})}},{title:"Total (₹)",dataIndex:"total",render:(s,t)=>{var n;const o=parseFloat(s)||((n=t.items)==null?void 0:n.reduce((a,i)=>a+(i.quantity||0)*(i.rate||0),0))||0;return e.jsx(d,{strong:!0,style:{color:"#52c41a"},children:h(o)})},sorter:(s,t)=>{const o=parseFloat(s.total)||0,n=parseFloat(t.total)||0;return o-n}},{title:"Date",dataIndex:"date",render:s=>{if(!s)return"N/A";try{return new Date(s).toLocaleDateString("en-IN")}catch{return s}},sorter:(s,t)=>{const o=new Date(s.date).getTime()||0,n=new Date(t.date).getTime()||0;return o-n}},{title:"Actions",width:80,render:(s,t)=>e.jsx(le,{overlay:e.jsxs(g,{children:[e.jsx(g.Item,{icon:e.jsx(ie,{}),onClick:()=>v(t),children:"View Details"},"view"),e.jsx(g.Item,{icon:e.jsx(q,{}),onClick:()=>Y(t),children:"Download PDF"},"download"),e.jsx(g.Item,{icon:e.jsx(he,{}),onClick:()=>{w(t),x.success("Opening notes dialog...",{duration:1500})},children:"View/Add Notes"},"notes"),e.jsx(g.Item,{icon:e.jsx(xe,{}),onClick:()=>V(t),children:"Add/View Follow-ups"},"followups"),e.jsx(g.Item,{icon:e.jsx(pe,{}),onClick:()=>{m(t),x.success("Initiating quotation edit...",{duration:1500})},children:"Edit Quotation"},"edit"),e.jsx(g.Item,{children:e.jsxs(fe,{title:"Are you sure you want to delete this account?",onConfirm:()=>handleDeleteAccount(t._id),okText:"Yes",cancelText:"No",children:[e.jsx(ge,{}),"Delete Account"]})})]}),trigger:["click"],children:e.jsx(j,{icon:e.jsx(de,{})})})}];return e.jsxs(e.Fragment,{children:[e.jsxs(oe,{style:{marginBottom:16,justifyContent:"space-between",width:"100%"},children:[e.jsx(Z.Search,{placeholder:"Search by quotation number, business, customer, or notes...",onChange:s=>{C(s.target.value)},style:{width:400},prefix:e.jsx(ue,{}),allowClear:!0}),e.jsx(j,{type:"primary",onClick:()=>{Q(),x.success("Prepare to create a new quotation.",{duration:1500})},children:"+ New Quotation"})]}),e.jsx(u,{columns:$,dataSource:y,rowKey:"_id",loading:T,pagination:{pageSize:10,showSizeChanger:!0,showQuickJumper:!0,showTotal:(s,t)=>`${t[0]}-${t[1]} of ${s} quotations`},scroll:{x:1200}}),e.jsx(se,{title:e.jsxs("div",{children:[e.jsx(d,{strong:!0,children:"Quotation Details"}),l&&e.jsx(z,{color:"blue",style:{marginLeft:8},children:l.quotationNumber})]}),open:O,onCancel:()=>b(!1),footer:[e.jsx(j,{icon:e.jsx(q,{}),onClick:()=>Y(l),children:"Download PDF"},"download"),e.jsx(j,{onClick:()=>b(!1),children:"Close"},"close")],width:1e3,children:l&&e.jsxs("div",{id:`quotation-modal-preview-${l._id}`,children:[e.jsxs(r,{column:2,bordered:!0,size:"small",children:[e.jsx(r.Item,{label:"Quotation Number",children:e.jsx(z,{color:"blue",children:l.quotationNumber||"N/A"})}),e.jsx(r.Item,{label:"Date",children:l.date?new Date(l.date).toLocaleDateString("en-IN"):"N/A"}),e.jsx(r.Item,{label:"Business Name",children:l.businessName||"N/A"}),e.jsx(r.Item,{label:"Customer Name",children:l.customerName||"N/A"}),e.jsx(r.Item,{label:"Customer Email",children:l.customerEmail||"N/A"}),e.jsx(r.Item,{label:"GSTIN",children:e.jsx(d,{code:!0,children:l.gstin||"N/A"})}),e.jsx(r.Item,{label:"Business Info",span:2,children:e.jsx(d,{style:{whiteSpace:"pre-wrap"},children:l.businessInfo||"N/A"})}),e.jsx(r.Item,{label:"Total Amount",span:2,children:e.jsx(d,{style:{fontSize:"18px",fontWeight:"bold",color:"#52c41a"},children:h(l.total||((P=l.items)==null?void 0:P.reduce((s,t)=>s+(t.quantity||0)*(t.rate||0),0))||0)})})]}),((k=l.items)==null?void 0:k.length)>0&&e.jsxs(e.Fragment,{children:[e.jsxs(K,{orientation:"left",children:["Items (",l.items.length,")"]}),e.jsx(u,{dataSource:l.items,columns:S(),pagination:!1,size:"small",rowKey:(s,t)=>`${l._id}-item-${t}`,bordered:!0,expandable:{expandedRowRender:s=>{var t;return e.jsx("div",{style:{margin:0,padding:0},children:((t=s.specifications)==null?void 0:t.length)>0&&e.jsx(r,{column:1,size:"small",children:s.specifications.filter(o=>o.name!=="SPECIFICATION").map((o,n)=>e.jsx(r.Item,{label:o.name,children:o.value},n))})})},rowExpandable:s=>{var t;return((t=s.specifications)==null?void 0:t.length)>0}},summary:s=>{const t=s.reduce((o,n)=>o+(n.quantity||0)*(n.rate||0),0);return e.jsx(u.Summary,{fixed:!0,children:e.jsxs(u.Summary.Row,{children:[e.jsx(u.Summary.Cell,{index:0,colSpan:5,children:e.jsx(d,{strong:!0,children:"Grand Total:"})}),e.jsx(u.Summary.Cell,{index:5,children:e.jsx(d,{strong:!0,style:{color:"#52c41a"},children:h(t)})})]})})}})]}),((E=l.notes)==null?void 0:E.length)>0&&e.jsxs(e.Fragment,{children:[e.jsxs(K,{orientation:"left",children:["Notes (",l.notes.length,")"]}),l.notes.map((s,t)=>e.jsxs("div",{style:{marginBottom:12,padding:8,background:"#f5f5f5",borderRadius:4},children:[e.jsxs(d,{italic:!0,children:['"',s.text,'"']}),e.jsx("br",{}),e.jsxs(d,{type:"secondary",style:{fontSize:"0.8em"},children:["— ",s.author," on"," ",s.timestamp||new Date(l.createdAt).toLocaleDateString("en-IN")]})]},t))]})]})}),y.map(s=>{var t,o;return e.jsx("div",{id:`quotation-${s._id}`,style:{display:"none"},children:e.jsxs("div",{style:{padding:"20px",fontFamily:"Arial, sans-serif"},children:[e.jsx("h2",{style:{textAlign:"center",marginBottom:"20px"},children:"QUOTATION"}),e.jsxs(r,{column:2,bordered:!0,size:"small",children:[e.jsx(r.Item,{label:"Quotation Number",children:s.quotationNumber||"N/A"}),e.jsx(r.Item,{label:"Date",children:s.date?new Date(s.date).toLocaleDateString("en-IN"):"N/A"}),e.jsx(r.Item,{label:"Business Name",children:s.businessName||"N/A"}),e.jsx(r.Item,{label:"Customer Name",children:s.customerName||"N/A"}),e.jsx(r.Item,{label:"Customer Email",children:s.customerEmail||"N/A"}),e.jsx(r.Item,{label:"GSTIN",children:s.gstin||"N/A"}),e.jsx(r.Item,{label:"Business Info",span:2,children:e.jsx(d,{style:{whiteSpace:"pre-wrap"},children:s.businessInfo||"N/A"})})]}),((t=s.items)==null?void 0:t.length)>0&&e.jsxs(e.Fragment,{children:[e.jsx("h3",{style:{marginTop:"20px",marginBottom:"10px"},children:"Items"}),e.jsx(u,{dataSource:s.items,columns:S(),pagination:!1,size:"small",rowKey:(n,a)=>`${s._id}-pdf-item-${a}`,bordered:!0,expandable:{expandedRowRender:n=>{var a;return e.jsx("div",{style:{margin:0,padding:0},children:((a=n.specifications)==null?void 0:a.length)>0&&e.jsx(r,{column:1,size:"small",children:n.specifications.filter(i=>i.name!=="SPECIFICATION").map((i,c)=>e.jsx(r.Item,{label:i.name,children:i.value},c))})})},rowExpandable:n=>{var a;return((a=n.specifications)==null?void 0:a.length)>0}},summary:n=>{const a=n.reduce((i,c)=>i+(c.quantity||0)*(c.rate||0),0);return e.jsx(u.Summary,{children:e.jsxs(u.Summary.Row,{children:[e.jsx(u.Summary.Cell,{index:0,colSpan:5,children:e.jsx(d,{strong:!0,children:"Grand Total:"})}),e.jsx(u.Summary.Cell,{index:5,children:e.jsx(d,{strong:!0,style:{color:"#52c41a"},children:h(a)})})]})})}})]}),((o=s.notes)==null?void 0:o.length)>0&&e.jsxs(e.Fragment,{children:[e.jsx("h3",{style:{marginTop:"20px",marginBottom:"10px"},children:"Notes"}),s.notes.map((n,a)=>e.jsxs("div",{style:{marginBottom:8},children:[e.jsxs(d,{italic:!0,children:['"',n.text,'"']}),e.jsx("br",{}),e.jsxs(d,{type:"secondary",style:{fontSize:"0.8em"},children:["— ",n.author," on"," ",n.timestamp||new Date(s.createdAt).toLocaleDateString("en-IN")]})]},a))]})]})},s._id)}),l&&e.jsx(ye,{visible:N,onClose:()=>D(!1),quotation:l,refreshQuotations:I})]})};export{Qe as default};
