import{r as p,P as f,n as e,B as j,D as se,V as x,T as ne,Q as le,U as g}from"./index-Cqbpo4Tu.js";import{R as q,E as ae}from"./jspdf.es.min-slvWPzS2.js";import re from"./html2canvas.esm-CBrSDip1.js";import{i as U,I as Z,b as ie}from"./axios-BQcx7bQ3.js";import{h as F}from"./moment-C5S46NFB.js";import{D as de}from"./index-BAZIrpXB.js";import{D as ce}from"./index-zxiQ_mm-.js";import{D as K}from"./index-D-FGh7vi.js";import{T as ee}from"./index-CWCP-2YO.js";import{L as M}from"./index-B6WVjc8L.js";import{T as te,a as Q}from"./index-FfGBM9-D.js";import{M as oe}from"./index-CKMbULed.js";import{c as me}from"./index-CpX-krNH.js";import{F as u}from"./Table-mG2uY23_.js";import{D as r}from"./index-BrDaRmQh.js";import{R as ue}from"./MoreOutlined-Duk4Im4t.js";import{R as pe}from"./MessageOutlined-DbgYFAB_.js";import{R as he}from"./ScheduleOutlined-BsCmtPS6.js";import{R as xe}from"./EditOutlined-CwoSM7yz.js";import{P as fe}from"./index-dAvgvm28.js";import{R as ge}from"./DeleteOutlined-DrmpgwwO.js";import"./context-ChbsC7z9.js";import"./index-Bg3F5gRI.js";import"./InfoCircleFilled-DlNxt6_X.js";import"./index-0h_1htgT.js";const{TextArea:je}=Z,{TabPane:H}=ee,{Text:X}=te,ye=({visible:y,onClose:z,quotation:m,refreshQuotations:L})=>{const[C,w]=p.useState(""),[T,I]=p.useState(null),[O,b]=p.useState(!1),[l,R]=p.useState([]),[N,D]=p.useState(null);p.useEffect(()=>{y&&(m!=null&&m._id)&&v()},[y,m]);const v=async()=>{try{const t=await U.get(`/api/quotations/${m._id}/followups`);R(t.data||[])}catch(t){console.error("Failed to fetch follow-ups for quotation:",t),f.error("Failed to fetch follow-ups for this quotation.")}},V=()=>{if(!C||!T){f.error("Please fill in both date and note fields.");return}const t=JSON.parse(localStorage.getItem("user")),s=t==null?void 0:t._id;if(!s){f.error("User information not found. Please log in.");return}b(!0);const n={date:T.format("YYYY-MM-DD"),note:C,addedBy:s};(N===null?U.post(`/api/quotations/${m._id}/followups`,n):U.put(`/api/quotations/${m._id}/followups/${N}`,n)).then(()=>{f.success(N===null?"Follow-up added successfully!":"Follow-up updated successfully!"),w(""),I(null),D(null),v(),L()}).catch(i=>{var c,A;console.error("Error saving follow-up:",i),f.error(((A=(c=i==null?void 0:i.response)==null?void 0:c.data)==null?void 0:A.message)||"Failed to save follow-up.")}).finally(()=>b(!1))},Y=t=>{const s=l[t];w(s.note),I(F(s.date)),D(t)},h=t=>{oe.confirm({title:"Delete Follow-up",content:"Are you sure you want to delete this follow-up? This action cannot be undone.",okText:"Yes, Delete",cancelText:"No",okButtonProps:{danger:!0},onOk:()=>{U.delete(`/api/quotations/${m._id}/followups/${t}`).then(()=>{f.success("Follow-up deleted successfully!"),v(),L()}).catch(s=>{var n,a;console.error("Error deleting follow-up:",s),f.error(((a=(n=s==null?void 0:s.response)==null?void 0:n.data)==null?void 0:a.message)||"Failed to delete follow-up.")})}})},S=F().format("YYYY-MM-DD"),$=[...l].sort((t,s)=>new Date(s.date)-new Date(t.date)),P=$.filter(t=>F(t.date).format("YYYY-MM-DD")===S),k=$.filter(t=>F(t.date).isAfter(S,"day")),B=$.filter(t=>F(t.date).isBefore(S,"day")),o=(t,s)=>{var n,a;return e.jsx(M.Item,{actions:[e.jsx(j,{type:"link",onClick:()=>Y(s),children:"Edit"},"edit"),e.jsx(j,{type:"link",danger:!0,onClick:()=>h(s),children:"Delete"},"delete")],children:e.jsxs("div",{children:[e.jsx(X,{strong:!0,children:F(t.date).format("DD-MM-YYYY")}),e.jsx("br",{}),t.note,e.jsx("br",{}),e.jsxs(X,{type:"secondary",children:["By ",((n=t.addedBy)==null?void 0:n.name)||((a=t.addedBy)==null?void 0:a.email)||"Unknown User"]})]})})};return e.jsxs(de,{title:`Follow-ups for Quotation: ${(m==null?void 0:m.quotationNumber)||"N/A"}`,open:y,onClose:()=>{D(null),w(""),I(null),z()},width:720,children:[e.jsxs("div",{style:{marginBottom:20},children:[e.jsx(ce,{style:{width:"100%",marginBottom:8},format:"DD-MM-YYYY",value:T,onChange:t=>I(t),placeholder:"Select follow-up date"}),e.jsx(je,{rows:4,placeholder:"Enter follow-up note",value:C,onChange:t=>w(t.target.value)}),e.jsx(j,{type:"primary",block:!0,onClick:V,loading:O,style:{marginTop:10},children:N===null?"Add Follow-up":"Update Follow-up"})]}),e.jsx(K,{children:"Existing Follow-ups"}),e.jsxs(ee,{defaultActiveKey:"today",children:[e.jsx(H,{tab:`Today's (${P.length})`,children:e.jsx(M,{dataSource:P,renderItem:t=>o(t,l.indexOf(t)),locale:{emptyText:"No follow-ups scheduled for today."}})},"today"),e.jsx(H,{tab:`Upcoming (${k.length})`,children:e.jsx(M,{dataSource:k,renderItem:t=>o(t,l.indexOf(t)),locale:{emptyText:"No upcoming follow-ups."}})},"upcoming"),e.jsx(H,{tab:`Past (${B.length})`,children:e.jsx(M,{dataSource:B,renderItem:t=>o(t,l.indexOf(t)),locale:{emptyText:"No past follow-ups."}})},"past")]})]})},{Text:d}=te,Ve=({quotations:y,onAddNew:z,onEdit:m,onDelete:L,onSearch:C,onViewNotes:w,loading:T,refreshQuotations:I})=>{var P,k,B;const[O,b]=p.useState(!1),[l,R]=p.useState(null),[N,D]=p.useState(!1),v=o=>{R(o),b(!0),x.success("Quotation details loaded.",{duration:1500,position:"top-right"})},V=o=>{R(o),D(!0)},Y=async o=>{let t=null;const s=x.loading("Generating PDF...",{position:"top-center"});try{const n=document.getElementById(`quotation-${o._id}`);if(!n){x.error("Quotation content not found for PDF generation. Please try again.",{id:s});return}t=n.cloneNode(!0),t.style.position="fixed",t.style.top="-9999px",t.style.left="-9999px",t.style.width="210mm",t.style.padding="10mm",t.style.background="white",t.style.zIndex="-1",t.style.display="block",document.body.appendChild(t),await new Promise(E=>setTimeout(E,100));const i=(await re(t,{scale:2,useCORS:!0,logging:!1})).toDataURL("image/png"),c=new ae("p","mm","a4"),A=c.internal.pageSize.getWidth(),G=c.internal.pageSize.getHeight(),W=c.getImageProperties(i),_=W.height*A/W.width;let J=0;if(_>G){let E=_;for(;E>0;)c.addImage(i,"PNG",0,J,A,_),E-=G,J-=G,E>0&&c.addPage()}else c.addImage(i,"PNG",0,0,A,_);c.save(`${o.quotationNumber||"quotation"}.pdf`),x.success("PDF downloaded successfully!",{id:s})}catch(n){console.error("Failed to generate PDF:",n),x.error("Failed to generate PDF. Please try again.",{id:s})}finally{t&&document.body.contains(t)&&document.body.removeChild(t)}},h=o=>`₹${(parseFloat(o)||0).toLocaleString("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2})}`,S=()=>[{title:"S.No",width:60,align:"center",render:(o,t,s)=>s+1},{title:"Description",dataIndex:"description",ellipsis:!0,render:(o,t)=>{var s;if(!o&&((s=t.specifications)==null?void 0:s.length)>0){const n=t.specifications.find(a=>a.name==="SPECIFICATION");return n?n.value:"N/A"}return o||"N/A"}},{title:"HSN/SAC",dataIndex:"hsnSac",width:100,align:"center",render:o=>o||"N/A"},{title:"Qty",dataIndex:"quantity",width:80,align:"center",render:o=>parseFloat(o)||0},{title:"Unit Price (₹)",width:140,align:"right",render:(o,t)=>h(t.rate||0)},{title:"Total (₹)",width:140,align:"right",render:(o,t)=>e.jsx(d,{strong:!0,style:{color:"#52c41a"},children:h((t.quantity||0)*(t.rate||0))})}],$=[{title:"Quotation #",dataIndex:"quotationNumber",render:o=>e.jsx(Q,{color:"blue",children:o||"N/A"}),sorter:(o,t)=>(o.quotationNumber||"").localeCompare(t.quotationNumber||"")},{title:"Business",dataIndex:"businessName",sorter:(o,t)=>(o.businessName||"").localeCompare(t.businessName||"")},{title:"Customer",dataIndex:"customerName",render:(o,t)=>e.jsxs("div",{children:[e.jsx("div",{children:o||"N/A"}),t.customerEmail&&e.jsx("div",{style:{fontSize:12,color:"#666"},children:t.customerEmail})]}),sorter:(o,t)=>(o.customerName||"").localeCompare(t.customerName||"")},{title:"Items Count",render:(o,t)=>{var s,n;return e.jsxs(Q,{color:"geekblue",children:[((s=t.items)==null?void 0:s.length)||0," item",(((n=t.items)==null?void 0:n.length)||0)!==1?"s":""]})}},{title:"Latest Note",dataIndex:"notes",render:o=>{if(o&&o.length>0){const t=o[o.length-1],s=t.text.length>30?`${t.text.substring(0,30)}...`:t.text;return e.jsx(ne,{title:t.text,children:e.jsx(d,{type:"secondary",children:s})})}return e.jsx(d,{type:"secondary",italic:!0,children:"No notes"})}},{title:"Total (₹)",dataIndex:"total",render:(o,t)=>{var n;const s=parseFloat(o)||((n=t.items)==null?void 0:n.reduce((a,i)=>a+(i.quantity||0)*(i.rate||0),0))||0;return e.jsx(d,{strong:!0,style:{color:"#52c41a"},children:h(s)})},sorter:(o,t)=>{const s=parseFloat(o.total)||0,n=parseFloat(t.total)||0;return s-n}},{title:"Date",dataIndex:"date",render:o=>{if(!o)return"N/A";try{return new Date(o).toLocaleDateString("en-IN")}catch{return o}},sorter:(o,t)=>{const s=new Date(o.date).getTime()||0,n=new Date(t.date).getTime()||0;return s-n}},{title:"Actions",width:80,render:(o,t)=>e.jsx(le,{overlay:e.jsxs(g,{children:[e.jsx(g.Item,{icon:e.jsx(ie,{}),onClick:()=>v(t),children:"View Details"},"view"),e.jsx(g.Item,{icon:e.jsx(q,{}),onClick:()=>Y(t),children:"Download PDF"},"download"),e.jsx(g.Item,{icon:e.jsx(pe,{}),onClick:()=>{w(t),x.success("Opening notes dialog...",{duration:1500})},children:"View/Add Notes"},"notes"),e.jsx(g.Item,{icon:e.jsx(he,{}),onClick:()=>V(t),children:"Add/View Follow-ups"},"followups"),e.jsx(g.Item,{icon:e.jsx(xe,{}),onClick:()=>{m(t),x.success("Initiating quotation edit...",{duration:1500})},children:"Edit Quotation"},"edit"),e.jsx(g.Item,{children:e.jsxs(fe,{title:"Are you sure you want to delete this account?",onConfirm:()=>handleDeleteAccount(t._id),okText:"Yes",cancelText:"No",children:[e.jsx(ge,{}),"Delete Account"]})})]}),trigger:["click"],children:e.jsx(j,{icon:e.jsx(ue,{})})})}];return e.jsxs(e.Fragment,{children:[e.jsxs(se,{style:{marginBottom:16,justifyContent:"space-between",width:"100%"},children:[e.jsx(Z.Search,{placeholder:"Search by quotation number, business, customer, or notes...",onChange:o=>{C(o.target.value)},style:{width:400},prefix:e.jsx(me,{}),allowClear:!0}),e.jsx(j,{type:"primary",onClick:()=>{z(),x.success("Prepare to create a new quotation.",{duration:1500})},children:"+ New Quotation"})]}),e.jsx(u,{columns:$,dataSource:y,rowKey:"_id",loading:T,pagination:{pageSize:10,showSizeChanger:!0,showQuickJumper:!0,showTotal:(o,t)=>`${t[0]}-${t[1]} of ${o} quotations`},scroll:{x:1200}}),e.jsx(oe,{title:e.jsxs("div",{children:[e.jsx(d,{strong:!0,children:"Quotation Details"}),l&&e.jsx(Q,{color:"blue",style:{marginLeft:8},children:l.quotationNumber})]}),open:O,onCancel:()=>b(!1),footer:[e.jsx(j,{icon:e.jsx(q,{}),onClick:()=>Y(l),children:"Download PDF"},"download"),e.jsx(j,{onClick:()=>b(!1),children:"Close"},"close")],width:1e3,children:l&&e.jsxs("div",{id:`quotation-modal-preview-${l._id}`,children:[e.jsxs(r,{column:2,bordered:!0,size:"small",children:[e.jsx(r.Item,{label:"Quotation Number",children:e.jsx(Q,{color:"blue",children:l.quotationNumber||"N/A"})}),e.jsx(r.Item,{label:"Date",children:l.date?new Date(l.date).toLocaleDateString("en-IN"):"N/A"}),e.jsx(r.Item,{label:"Business Name",children:l.businessName||"N/A"}),e.jsx(r.Item,{label:"Customer Name",children:l.customerName||"N/A"}),e.jsx(r.Item,{label:"Customer Email",children:l.customerEmail||"N/A"}),e.jsx(r.Item,{label:"GSTIN",children:e.jsx(d,{code:!0,children:l.gstin||"N/A"})}),e.jsx(r.Item,{label:"Business Info",span:2,children:e.jsx(d,{style:{whiteSpace:"pre-wrap"},children:l.businessInfo||"N/A"})}),e.jsx(r.Item,{label:"Total Amount",span:2,children:e.jsx(d,{style:{fontSize:"18px",fontWeight:"bold",color:"#52c41a"},children:h(l.total||((P=l.items)==null?void 0:P.reduce((o,t)=>o+(t.quantity||0)*(t.rate||0),0))||0)})})]}),((k=l.items)==null?void 0:k.length)>0&&e.jsxs(e.Fragment,{children:[e.jsxs(K,{orientation:"left",children:["Items (",l.items.length,")"]}),e.jsx(u,{dataSource:l.items,columns:S(),pagination:!1,size:"small",rowKey:(o,t)=>`${l._id}-item-${t}`,bordered:!0,expandable:{expandedRowRender:o=>{var t;return e.jsx("div",{style:{margin:0,padding:0},children:((t=o.specifications)==null?void 0:t.length)>0&&e.jsx(r,{column:1,size:"small",children:o.specifications.filter(s=>s.name!=="SPECIFICATION").map((s,n)=>e.jsx(r.Item,{label:s.name,children:s.value},n))})})},rowExpandable:o=>{var t;return((t=o.specifications)==null?void 0:t.length)>0}},summary:o=>{const t=o.reduce((s,n)=>s+(n.quantity||0)*(n.rate||0),0);return e.jsx(u.Summary,{fixed:!0,children:e.jsxs(u.Summary.Row,{children:[e.jsx(u.Summary.Cell,{index:0,colSpan:5,children:e.jsx(d,{strong:!0,children:"Grand Total:"})}),e.jsx(u.Summary.Cell,{index:5,children:e.jsx(d,{strong:!0,style:{color:"#52c41a"},children:h(t)})})]})})}})]}),((B=l.notes)==null?void 0:B.length)>0&&e.jsxs(e.Fragment,{children:[e.jsxs(K,{orientation:"left",children:["Notes (",l.notes.length,")"]}),l.notes.map((o,t)=>e.jsxs("div",{style:{marginBottom:12,padding:8,background:"#f5f5f5",borderRadius:4},children:[e.jsxs(d,{italic:!0,children:['"',o.text,'"']}),e.jsx("br",{}),e.jsxs(d,{type:"secondary",style:{fontSize:"0.8em"},children:["— ",o.author," on"," ",o.timestamp||new Date(l.createdAt).toLocaleDateString("en-IN")]})]},t))]})]})}),y.map(o=>{var t,s;return e.jsx("div",{id:`quotation-${o._id}`,style:{display:"none"},children:e.jsxs("div",{style:{padding:"20px",fontFamily:"Arial, sans-serif"},children:[e.jsx("h2",{style:{textAlign:"center",marginBottom:"20px"},children:"QUOTATION"}),e.jsxs(r,{column:2,bordered:!0,size:"small",children:[e.jsx(r.Item,{label:"Quotation Number",children:o.quotationNumber||"N/A"}),e.jsx(r.Item,{label:"Date",children:o.date?new Date(o.date).toLocaleDateString("en-IN"):"N/A"}),e.jsx(r.Item,{label:"Business Name",children:o.businessName||"N/A"}),e.jsx(r.Item,{label:"Customer Name",children:o.customerName||"N/A"}),e.jsx(r.Item,{label:"Customer Email",children:o.customerEmail||"N/A"}),e.jsx(r.Item,{label:"GSTIN",children:o.gstin||"N/A"}),e.jsx(r.Item,{label:"Business Info",span:2,children:e.jsx(d,{style:{whiteSpace:"pre-wrap"},children:o.businessInfo||"N/A"})})]}),((t=o.items)==null?void 0:t.length)>0&&e.jsxs(e.Fragment,{children:[e.jsx("h3",{style:{marginTop:"20px",marginBottom:"10px"},children:"Items"}),e.jsx(u,{dataSource:o.items,columns:S(),pagination:!1,size:"small",rowKey:(n,a)=>`${o._id}-pdf-item-${a}`,bordered:!0,expandable:{expandedRowRender:n=>{var a;return e.jsx("div",{style:{margin:0,padding:0},children:((a=n.specifications)==null?void 0:a.length)>0&&e.jsx(r,{column:1,size:"small",children:n.specifications.filter(i=>i.name!=="SPECIFICATION").map((i,c)=>e.jsx(r.Item,{label:i.name,children:i.value},c))})})},rowExpandable:n=>{var a;return((a=n.specifications)==null?void 0:a.length)>0}},summary:n=>{const a=n.reduce((i,c)=>i+(c.quantity||0)*(c.rate||0),0);return e.jsx(u.Summary,{children:e.jsxs(u.Summary.Row,{children:[e.jsx(u.Summary.Cell,{index:0,colSpan:5,children:e.jsx(d,{strong:!0,children:"Grand Total:"})}),e.jsx(u.Summary.Cell,{index:5,children:e.jsx(d,{strong:!0,style:{color:"#52c41a"},children:h(a)})})]})})}})]}),((s=o.notes)==null?void 0:s.length)>0&&e.jsxs(e.Fragment,{children:[e.jsx("h3",{style:{marginTop:"20px",marginBottom:"10px"},children:"Notes"}),o.notes.map((n,a)=>e.jsxs("div",{style:{marginBottom:8},children:[e.jsxs(d,{italic:!0,children:['"',n.text,'"']}),e.jsx("br",{}),e.jsxs(d,{type:"secondary",style:{fontSize:"0.8em"},children:["— ",n.author," on"," ",n.timestamp||new Date(o.createdAt).toLocaleDateString("en-IN")]})]},a))]})]})},o._id)}),l&&e.jsx(ye,{visible:N,onClose:()=>D(!1),quotation:l,refreshQuotations:I})]})};export{Ve as default};
