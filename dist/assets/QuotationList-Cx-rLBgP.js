import{r as v,p as e,q as P,B as x,V as u,T as p}from"./index-DJFv2fZl.js";import{E as O}from"./jspdf.es.min-D5sk-AdV.js";import M from"./html2canvas.esm-CBrSDip1.js";import{I as H,R as K}from"./index-nhsLOXfP.js";import{R as U}from"./TextArea-DSWaGSmh.js";import{F as m,R as W}from"./Table-Ba5SqTG2.js";import{M as J}from"./index-RtXhLelk.js";import{D as a}from"./index-CNF0TI-e.js";import{a as f,T as Y}from"./index-PfaQhicL.js";import{D as R}from"./index-Bt3lE0VZ.js";import{R as $}from"./PrinterOutlined-Bmpp8DX-.js";import{R as X}from"./MessageOutlined-XSFY_PJu.js";import{P as Z}from"./index-DU0XO1m_.js";import{R as ee}from"./DeleteOutlined-DBMmcI3x.js";import"./index-F-KgjenD.js";import"./index-CnrHKh7b.js";import"./context-gBB5gMPl.js";const{Text:l}=Y,fe=({quotations:b,onAddNew:B,onEdit:E,onDelete:z,onSearch:Q,onViewNotes:_,loading:k})=>{var A,C,D;const[L,y]=v.useState(!1),[r,q]=v.useState(null),V=t=>{q(t),y(!0),u.success("Quotation details loaded.",{duration:1500,position:"top-right"})},w=async t=>{let n=null;const i=u.loading("Generating PDF...",{position:"top-center"});try{const s=document.getElementById(`quotation-${t._id}`);if(!s){u.error("Quotation content not found for PDF generation. Please try again.",{id:i});return}n=s.cloneNode(!0),n.style.position="fixed",n.style.top="-9999px",n.style.left="-9999px",n.style.width="210mm",n.style.padding="10mm",n.style.background="white",n.style.zIndex="-1",n.style.display="block",document.body.appendChild(n),await new Promise(g=>setTimeout(g,100));const d=(await M(n,{scale:2,useCORS:!0,logging:!1})).toDataURL("image/png"),c=new O("p","mm","a4"),N=c.internal.pageSize.getWidth(),I=c.internal.pageSize.getHeight(),F=c.getImageProperties(d),j=F.height*N/F.width;let T=0;if(j>I){let g=j;for(;g>0;)c.addImage(d,"PNG",0,T,N,j),g-=I,T-=I,g>0&&c.addPage()}else c.addImage(d,"PNG",0,0,N,j);c.save(`${t.quotationNumber||"quotation"}.pdf`),u.success("PDF downloaded successfully!",{id:i})}catch(s){console.error("Failed to generate PDF:",s),u.error("Failed to generate PDF. Please try again.",{id:i})}finally{n&&document.body.contains(n)&&document.body.removeChild(n)}},h=t=>`₹${(parseFloat(t)||0).toLocaleString("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2})}`,S=()=>[{title:"S.No",width:60,align:"center",render:(t,n,i)=>i+1},{title:"Description",dataIndex:"description",ellipsis:!0,render:(t,n)=>{var i;if(!t&&((i=n.specifications)==null?void 0:i.length)>0){const s=n.specifications.find(o=>o.name==="SPECIFICATION");return s?s.value:"N/A"}return t||"N/A"}},{title:"HSN/SAC",dataIndex:"hsnSac",width:100,align:"center",render:t=>t||"N/A"},{title:"Qty",dataIndex:"quantity",width:80,align:"center",render:t=>parseFloat(t)||0},{title:"Unit Price (₹)",width:140,align:"right",render:(t,n)=>h(n.rate||0)},{title:"Total (₹)",width:140,align:"right",render:(t,n)=>e.jsx(l,{strong:!0,style:{color:"#52c41a"},children:h((n.quantity||0)*(n.rate||0))})}],G=[{title:"Quotation #",dataIndex:"quotationNumber",render:t=>e.jsx(f,{color:"blue",children:t||"N/A"}),sorter:(t,n)=>(t.quotationNumber||"").localeCompare(n.quotationNumber||"")},{title:"Business",dataIndex:"businessName",sorter:(t,n)=>(t.businessName||"").localeCompare(n.businessName||"")},{title:"Customer",dataIndex:"customerName",render:(t,n)=>e.jsxs("div",{children:[e.jsx("div",{children:t||"N/A"}),n.customerEmail&&e.jsx("div",{style:{fontSize:12,color:"#666"},children:n.customerEmail})]}),sorter:(t,n)=>(t.customerName||"").localeCompare(n.customerName||"")},{title:"Items Count",render:(t,n)=>{var i,s;return e.jsxs(f,{color:"geekblue",children:[((i=n.items)==null?void 0:i.length)||0," item",(((s=n.items)==null?void 0:s.length)||0)!==1?"s":""]})}},{title:"Latest Note",dataIndex:"notes",render:t=>{if(t&&t.length>0){const n=t[t.length-1],i=n.text.length>30?`${n.text.substring(0,30)}...`:n.text;return e.jsx(p,{title:n.text,children:e.jsx(l,{type:"secondary",children:i})})}return e.jsx(l,{type:"secondary",italic:!0,children:"No notes"})}},{title:"Total (₹)",dataIndex:"total",render:(t,n)=>{var s;const i=parseFloat(t)||((s=n.items)==null?void 0:s.reduce((o,d)=>o+(d.quantity||0)*(d.rate||0),0))||0;return e.jsx(l,{strong:!0,style:{color:"#52c41a"},children:h(i)})},sorter:(t,n)=>{const i=parseFloat(t.total)||0,s=parseFloat(n.total)||0;return i-s}},{title:"Date",dataIndex:"date",render:t=>{if(!t)return"N/A";try{return new Date(t).toLocaleDateString("en-IN")}catch{return t}},sorter:(t,n)=>{const i=new Date(t.date).getTime()||0,s=new Date(n.date).getTime()||0;return i-s}},{title:"Actions",width:200,render:(t,n)=>e.jsxs(P,{children:[e.jsx(p,{title:"View Details",children:e.jsx(x,{icon:e.jsx(K,{}),onClick:()=>V(n)})}),e.jsx(p,{title:"Download PDF",children:e.jsx(x,{icon:e.jsx($,{}),onClick:()=>w(n)})}),e.jsx(p,{title:"View/Add Notes",children:e.jsx(x,{icon:e.jsx(X,{}),onClick:()=>{_(n),u.success("Opening notes dialog...",{duration:1500})}})}),e.jsx(p,{title:"Edit Quotation",children:e.jsx(x,{icon:e.jsx(W,{}),onClick:()=>{E(n),u.success("Initiating quotation edit...",{duration:1500})}})}),e.jsx(Z,{title:"Are you sure you want to delete this quotation?",onConfirm:()=>{z(n._id),u.success("Deleting quotation...",{duration:1500})},okText:"Yes",cancelText:"No",children:e.jsx(p,{title:"Delete Quotation",children:e.jsx(x,{icon:e.jsx(ee,{}),danger:!0})})})]})}];return e.jsxs(e.Fragment,{children:[e.jsxs(P,{style:{marginBottom:16,justifyContent:"space-between",width:"100%"},children:[e.jsx(H.Search,{placeholder:"Search by quotation number, business, customer, or notes...",onChange:t=>{Q(t.target.value)},style:{width:400},prefix:e.jsx(U,{}),allowClear:!0}),e.jsx(x,{type:"primary",onClick:()=>{B(),u.success("Prepare to create a new quotation.",{duration:1500})},children:"+ New Quotation"})]}),e.jsx(m,{columns:G,dataSource:b,rowKey:"_id",loading:k,pagination:{pageSize:10,showSizeChanger:!0,showQuickJumper:!0,showTotal:(t,n)=>`${n[0]}-${n[1]} of ${t} quotations`},scroll:{x:1200}}),e.jsx(J,{title:e.jsxs("div",{children:[e.jsx(l,{strong:!0,children:"Quotation Details"}),r&&e.jsx(f,{color:"blue",style:{marginLeft:8},children:r.quotationNumber})]}),open:L,onCancel:()=>y(!1),footer:[e.jsx(x,{icon:e.jsx($,{}),onClick:()=>w(r),children:"Download PDF"},"download"),e.jsx(x,{onClick:()=>y(!1),children:"Close"},"close")],width:1e3,children:r&&e.jsxs("div",{id:`quotation-modal-preview-${r._id}`,children:[e.jsxs(a,{column:2,bordered:!0,size:"small",children:[e.jsx(a.Item,{label:"Quotation Number",children:e.jsx(f,{color:"blue",children:r.quotationNumber||"N/A"})}),e.jsx(a.Item,{label:"Date",children:r.date?new Date(r.date).toLocaleDateString("en-IN"):"N/A"}),e.jsx(a.Item,{label:"Business Name",children:r.businessName||"N/A"}),e.jsx(a.Item,{label:"Customer Name",children:r.customerName||"N/A"}),e.jsx(a.Item,{label:"Customer Email",children:r.customerEmail||"N/A"}),e.jsx(a.Item,{label:"GSTIN",children:e.jsx(l,{code:!0,children:r.gstin||"N/A"})}),e.jsx(a.Item,{label:"Business Info",span:2,children:e.jsx(l,{style:{whiteSpace:"pre-wrap"},children:r.businessInfo||"N/A"})}),e.jsx(a.Item,{label:"Total Amount",span:2,children:e.jsx(l,{style:{fontSize:"18px",fontWeight:"bold",color:"#52c41a"},children:h(r.total||((A=r.items)==null?void 0:A.reduce((t,n)=>t+(n.quantity||0)*(n.rate||0),0))||0)})})]}),((C=r.items)==null?void 0:C.length)>0&&e.jsxs(e.Fragment,{children:[e.jsxs(R,{orientation:"left",children:["Items (",r.items.length,")"]}),e.jsx(m,{dataSource:r.items,columns:S(),pagination:!1,size:"small",rowKey:(t,n)=>`${r._id}-item-${n}`,bordered:!0,expandable:{expandedRowRender:t=>{var n;return e.jsx("div",{style:{margin:0,padding:0},children:((n=t.specifications)==null?void 0:n.length)>0&&e.jsx(a,{column:1,size:"small",children:t.specifications.filter(i=>i.name!=="SPECIFICATION").map((i,s)=>e.jsx(a.Item,{label:i.name,children:i.value},s))})})},rowExpandable:t=>{var n;return((n=t.specifications)==null?void 0:n.length)>0}},summary:t=>{const n=t.reduce((i,s)=>i+(s.quantity||0)*(s.rate||0),0);return e.jsx(m.Summary,{fixed:!0,children:e.jsxs(m.Summary.Row,{children:[e.jsx(m.Summary.Cell,{index:0,colSpan:5,children:e.jsx(l,{strong:!0,children:"Grand Total:"})}),e.jsx(m.Summary.Cell,{index:5,children:e.jsx(l,{strong:!0,style:{color:"#52c41a"},children:h(n)})})]})})}})]}),((D=r.notes)==null?void 0:D.length)>0&&e.jsxs(e.Fragment,{children:[e.jsxs(R,{orientation:"left",children:["Notes (",r.notes.length,")"]}),r.notes.map((t,n)=>e.jsxs("div",{style:{marginBottom:12,padding:8,background:"#f5f5f5",borderRadius:4},children:[e.jsxs(l,{italic:!0,children:['"',t.text,'"']}),e.jsx("br",{}),e.jsxs(l,{type:"secondary",style:{fontSize:"0.8em"},children:["— ",t.author," on"," ",t.timestamp||new Date(r.createdAt).toLocaleDateString("en-IN")]})]},n))]})]})}),b.map(t=>{var n,i;return e.jsx("div",{id:`quotation-${t._id}`,style:{display:"none"},children:e.jsxs("div",{style:{padding:"20px",fontFamily:"Arial, sans-serif"},children:[e.jsx("h2",{style:{textAlign:"center",marginBottom:"20px"},children:"QUOTATION"}),e.jsxs(a,{column:2,bordered:!0,size:"small",children:[e.jsx(a.Item,{label:"Quotation Number",children:t.quotationNumber||"N/A"}),e.jsx(a.Item,{label:"Date",children:t.date?new Date(t.date).toLocaleDateString("en-IN"):"N/A"}),e.jsx(a.Item,{label:"Business Name",children:t.businessName||"N/A"}),e.jsx(a.Item,{label:"Customer Name",children:t.customerName||"N/A"}),e.jsx(a.Item,{label:"Customer Email",children:t.customerEmail||"N/A"}),e.jsx(a.Item,{label:"GSTIN",children:t.gstin||"N/A"}),e.jsx(a.Item,{label:"Business Info",span:2,children:t.businessInfo||"N/A"})]}),((n=t.items)==null?void 0:n.length)>0&&e.jsxs(e.Fragment,{children:[e.jsx("h3",{style:{marginTop:"20px",marginBottom:"10px"},children:"Items"}),e.jsx(m,{dataSource:t.items,columns:S(),pagination:!1,size:"small",rowKey:(s,o)=>`${t._id}-pdf-item-${o}`,bordered:!0,expandable:{expandedRowRender:s=>{var o;return e.jsx("div",{style:{margin:0,padding:0},children:((o=s.specifications)==null?void 0:o.length)>0&&e.jsx(a,{column:1,size:"small",children:s.specifications.filter(d=>d.name!=="SPECIFICATION").map((d,c)=>e.jsx(a.Item,{label:d.name,children:d.value},c))})})},rowExpandable:s=>{var o;return((o=s.specifications)==null?void 0:o.length)>0}},summary:s=>{const o=s.reduce((d,c)=>d+(c.quantity||0)*(c.rate||0),0);return e.jsx(m.Summary,{children:e.jsxs(m.Summary.Row,{children:[e.jsx(m.Summary.Cell,{index:0,colSpan:5,children:e.jsx(l,{strong:!0,children:"Grand Total:"})}),e.jsx(m.Summary.Cell,{index:5,children:e.jsx(l,{strong:!0,style:{color:"#52c41a"},children:h(o)})})]})})}})]}),((i=t.notes)==null?void 0:i.length)>0&&e.jsxs(e.Fragment,{children:[e.jsx("h3",{style:{marginTop:"20px",marginBottom:"10px"},children:"Notes"}),t.notes.map((s,o)=>e.jsxs("div",{style:{marginBottom:8},children:[e.jsxs(l,{italic:!0,children:['"',s.text,'"']}),e.jsx("br",{}),e.jsxs(l,{type:"secondary",style:{fontSize:"0.8em"},children:["— ",s.author," on"," ",s.timestamp||new Date(t.createdAt).toLocaleDateString("en-IN")]})]},o))]})]})},t._id)})]})};export{fe as default};
