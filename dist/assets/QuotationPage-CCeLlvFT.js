import{v,r,o as e,D as $,S as b,L as D,T as L,I as V,w as Q,B as N,x as z,y as A,z as q,P as R,A as k,E as P,V as s,s as m}from"./index-BHNQ9zbu.js";import _ from"./QuotationForm-sSuFhPzm.js";import B from"./QuotationList-DDjBQ_3T.js";import"./html2canvas.esm-CBrSDip1.js";const{TextArea:T}=V,{Text:O}=L,Y=({visible:S,onClose:F,quotation:l,refreshQuotations:c})=>{const[u]=v.useForm(),[p,d]=r.useState(!1),[I,j]=r.useState(null),[w,f]=r.useState(""),[h,y]=r.useState([]);r.useEffect(()=>{y((l==null?void 0:l.notes)||[])},[l]);const o=async a=>{try{d(!0);const t=s.loading("Adding note..."),i={text:a.note,timestamp:new Date().toLocaleString()},E=[...h,i];await m.put(`/api/quotations/${l._id}`,{notes:E}),y(E),s.success("Note added successfully",{id:t}),u.resetFields(),c()}catch(t){console.error(t),s.error("Failed to add note")}finally{d(!1)}},n=async a=>{try{d(!0);const t=s.loading("Deleting note..."),i=[...h];i.splice(a,1),await m.put(`/api/quotations/${l._id}`,{notes:i}),y(i),s.success("Note deleted successfully",{id:t}),c()}catch(t){console.error(t),s.error("Failed to delete note")}finally{d(!1)}},g=(a,t)=>{j(t),f(a.text)},x=async a=>{try{d(!0);const t=s.loading("Updating note..."),i=[...h];i[a]={...i[a],text:w,timestamp:new Date().toLocaleString()},await m.put(`/api/quotations/${l._id}`,{notes:i}),y(i),s.success("Note updated successfully",{id:t}),j(null),c()}catch(t){console.error(t),s.error("Failed to update note")}finally{d(!1)}},C=()=>{j(null),f("")};return e.jsx($,{title:`Notes for Quotation #${l==null?void 0:l.quotationNumber}`,open:S,onClose:F,width:400,destroyOnClose:!0,children:e.jsxs(b,{spinning:p,children:[e.jsx("div",{style:{maxHeight:"496px",overflowY:"auto"},children:e.jsx(D,{size:"small",dataSource:h,locale:{emptyText:"No notes added yet"},renderItem:(a,t)=>e.jsx(D.Item,{style:{padding:"12px 0",borderBottom:"1px solid #f0f0f0"},actions:[I===t?e.jsxs(Q,{children:[e.jsx(N,{size:"small",icon:e.jsx(z,{style:{color:"#52c41a"}}),onClick:()=>x(t),type:"text"}),e.jsx(N,{size:"small",icon:e.jsx(A,{style:{color:"#ff4d4f"}}),onClick:C,type:"text"})]}):e.jsxs(Q,{children:[e.jsx(N,{size:"small",icon:e.jsx(q,{style:{color:"#1890ff"}}),onClick:()=>g(a,t),type:"text"}),e.jsx(R,{title:"Are you sure to delete this note?",onConfirm:()=>n(t),okText:"Yes",cancelText:"No",children:e.jsx(N,{size:"small",icon:e.jsx(k,{style:{color:"#ff4d4f"}}),type:"text"})})]})],children:e.jsx(D.Item.Meta,{description:e.jsxs(e.Fragment,{children:[e.jsx(O,{type:"secondary",style:{fontSize:12},children:a.timestamp}),I===t?e.jsx(T,{value:w,onChange:i=>f(i.target.value),rows:2,style:{marginTop:8},autoFocus:!0}):e.jsx("div",{style:{marginTop:4,whiteSpace:"pre-wrap"},children:a.text})]})})},t)})}),e.jsxs(v,{form:u,layout:"vertical",style:{marginTop:16},onFinish:o,children:[e.jsx(v.Item,{name:"note",rules:[{required:!0,message:"Please enter a note"}],children:e.jsx(T,{rows:3,placeholder:"Type your note here"})}),e.jsx(N,{type:"primary",htmlType:"submit",loading:p,block:!0,icon:e.jsx(P,{}),children:"Add Note"})]})]})})},J=()=>{const[S,F]=r.useState([]),[l,c]=r.useState(!1),[u,p]=r.useState(null),[d,I]=r.useState([]),[j,w]=r.useState(!1),f=()=>{const o=s.loading("Loading quotations...");m.get("/api/quotations").then(n=>{F(n.data),s.success("Quotations loaded successfully",{id:o})}).catch(()=>{s.error("Failed to load quotations",{id:o})})};r.useEffect(()=>{f()},[]);const h=o=>{const n=s.loading("Saving quotation...");(u?m.put(`/api/quotations/${u._id}`,o):m.post("/api/quotations",o)).then(()=>{f(),s.success("Quotation saved successfully!",{id:n}),c(!1),p(null)}).catch(x=>{s.error(`Failed to save quotation: ${x.message}`,{id:n})})},y=o=>{const n=o.toLowerCase(),g=S.filter(x=>{var C,a,t;return((C=x.businessName)==null?void 0:C.toLowerCase().includes(n))||((a=x.customerName)==null?void 0:a.toLowerCase().includes(n))||((t=x.quotationNumber)==null?void 0:t.toLowerCase().includes(n))});I(g)};return e.jsxs(e.Fragment,{children:[e.jsx(B,{quotations:d.length?d:S,onAddNew:()=>c(!0),onEdit:o=>{p(o),c(!0)},onDelete:o=>{const n=s.loading("Deleting quotation...");m.delete(`/api/quotations/${o}`).then(()=>{f(),s.success("Quotation deleted successfully",{id:n})}).catch(g=>{s.error(`Failed to delete quotation: ${g.message}`,{id:n})})},onSearch:y,onViewNotes:o=>{p(o),w(!0)}}),e.jsx($,{open:l,title:u?"Edit Quotation":"Create Quotation",onClose:()=>{c(!1),p(null)},width:720,destroyOnClose:!0,children:e.jsx(_,{initialValues:u,onCancel:()=>{c(!1),p(null)},onSave:h})}),e.jsx(Y,{visible:j,onClose:()=>w(!1),quotation:u,refreshQuotations:f})]})};export{J as default};
